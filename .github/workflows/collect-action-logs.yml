name: Collect Action Logs

on:
  workflow_dispatch:
    inputs:
      per_page:
        description: 'Number of recent runs to check'
        required: false
        default: '10'
      only_failed:
        description: 'Only collect logs for non-success runs'
        required: false
        default: 'true'

jobs:
  collect:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
    steps:
      - name: Prepare runner
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl unzip

      - name: List runs and download logs
        env:
          REPO: ${{ github.repository }}
          PER_PAGE: ${{ github.event.inputs.per_page || '10' }}
          ONLY_FAILED: ${{ github.event.inputs.only_failed || 'true' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p logs
          echo "Listing recent workflow runs for branch main (per_page=${PER_PAGE})"
          runs_json=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" "https://api.github.com/repos/${REPO}/actions/runs?branch=main&per_page=${PER_PAGE}")
          echo "$runs_json" | jq -r '.workflow_runs[] | "\(.id)\t\(.name)\t\(.status)\t\(.conclusion)"' > runs_list.txt || true
          echo "Found runs:"
          cat runs_list.txt || true
          while IFS=$'\t' read -r id name status conclusion; do
            if [ "${ONLY_FAILED}" = "true" ] && [ "${conclusion}" = "success" ]; then
              echo "Skipping run ${id} (success)"
              continue
            fi
            echo "Downloading logs for run ${id} (conclusion=${conclusion})"
            out="logs/run-${id}-logs.zip"
            curl -L -H "Authorization: token ${GITHUB_TOKEN}" -o "${out}" "https://api.github.com/repos/${REPO}/actions/runs/${id}/logs"
            echo "Downloaded ${out} (size=$(stat -c%s "${out}" || echo 0))"
          done < runs_list.txt || true
          echo "Listing logs dir:"
          ls -lah logs || true

      - name: Upload logs artifacts
        uses: actions/upload-artifact@v4
        with:
          name: action-logs
          path: logs/*.zip
          if-no-files-found: warn
          overwrite: false
