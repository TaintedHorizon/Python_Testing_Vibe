name: "Label PRs for Auto-merge"

permissions:
  contents: write
  pull-requests: write

on:
  pull_request:
    types: [opened, edited, reopened]

jobs:
  add-automerge-label:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title/body for [automerge]
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          PR_NUMBER=${{ github.event.pull_request.number }}
          OWNER=${{ github.repository_owner }}
          REPO=${{ github.event.repository.name }}
          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"
          if echo "$TITLE" | grep -qi '\[automerge\]' || echo "$BODY" | grep -qi 'automerge'; then
            echo "Adding label 'automerge' to PR #$PR_NUMBER"
            curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$OWNER/$REPO/issues/$PR_NUMBER/labels" \
              -d '{"labels":["automerge"]}'

            echo "Checking out PR branch to create empty commit to retrigger checks"
            git config --global user.email "action@github.com"
            git config --global user.name "GitHub Action"
            git clone "https://x-access-token:$GITHUB_TOKEN@github.com/$OWNER/$REPO.git" repo
            cd repo
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
            git commit --allow-empty -m "ci: retrigger status checks for automerge" || true
            git push origin "$BRANCH_NAME"

            echo "Enabling auto-merge for PR #$PR_NUMBER"
            curl -s -X PUT -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$OWNER/$REPO/pulls/$PR_NUMBER/enable-auto-merge" \
              -d '{"merge_method":"squash"}'
          else
            echo "No [automerge] marker found; skipping"
          fi
