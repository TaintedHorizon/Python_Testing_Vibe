name: Playwright E2E

on:
  workflow_dispatch:
  push:
    paths:
      - 'doc_processor/**'
      - '.github/workflows/playwright-e2e.yml'

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-cache-${{ runner.os }}-python-${{ matrix.python-version || '3.12' }}-{{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            pip-cache-${{ runner.os }}-python-
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-browsers-${{ runner.os }}-v1
          restore-keys: |
            playwright-browsers-
      - name: Install system deps for Playwright
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libxss1 libgbm1 libxcomposite1 libxrandr2 libasound2
      - name: Create venv and install deps
        run: |
          python -m venv venv
          . venv/bin/activate
          pip install -r doc_processor/requirements.txt
          pip install playwright pytest-playwright
          python -m playwright install --with-deps
      - name: Run Playwright E2E
        env:
          PLAYWRIGHT_E2E: '1'
          FAST_TEST_MODE: '1'
          SKIP_OLLAMA: '1'
        run: |
          . venv/bin/activate
          pytest -q doc_processor/tests/e2e/test_gui_end_to_end_playwright.py
*** End Patch