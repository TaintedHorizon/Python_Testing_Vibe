{% extends 'base.html' %}

{% block title %}Batch Control{% endblock %}

{% block content %}
<style>
    /* General table styling */
    .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .history-table th, .history-table td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
    .history-table th { background-color: #f2f2f2; font-weight: bold; }
    
    /* Styling for action buttons to make them look distinct */
    .action-btn { display: inline-block; padding: 8px 12px; text-decoration: none; color: white; border-radius: 5px; font-size: 0.9em; margin-right: 5px; margin-bottom: 5px; border: none; cursor: pointer; }
    .btn-verify { background-color: #007BFF; } /* Blue */
    .btn-review { background-color: #ffc107; color: black; } /* Yellow */
    .btn-group { background-color: #28a745; } /* Green */
    .btn-order { background-color: #6f42c1; } /* Purple */
    .btn-finalize { background-color: #17a2b8; } /* Teal */
    .btn-view-docs { background-color: #20c997; } /* Brighter Teal for View Docs */
    .btn-revisit { background-color: #6c757d; } /* Gray */
    .btn-reset { background-color: #dc3545; } /* Red */

    /* Style for a disabled-looking link/button */
    .action-btn.disabled {
        background-color: #6c757d;
        pointer-events: none;
        cursor: not-allowed;
    }
    
    /* Styling for the new batch form section */
    .new-batch-form { padding: 20px; background-color: white; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 30px; text-align: center; }
    .new-batch-form button { font-size: 1.2em; padding: 10px 20px; cursor: pointer; width: 100%; background-color: #3182ce; color: white; border-radius: 5px; border: none; }
    .new-batch-form button:hover { background-color: #2c5282; }
</style>

<h1>ðŸ“Š Batch Control</h1>
<p>Monitor and manage your document processing batches. To start processing new documents, use <strong>Analyze Intake</strong> from the navigation menu.</p>

<table class="history-table">
    <thead>
        <tr>
            <th>Batch ID</th>
            <th>Start Time</th>
            <th>Status</th>
            <th>Actions</th>
            <th>Audit</th>
        </tr>
    </thead>
    <tbody>
        {% for batch in batches %}
        <tr>
            <td>#{{ batch.id }}</td>
            <td>{{ batch.start_time }}</td>
            <td>{{ batch.status | replace('_', ' ') | title }}</td>
            <td>
                {% if batch.status == 'pending_verification' %}
                    <a href="{{ url_for('verify_batch_page', batch_id=batch.id) }}" class="action-btn btn-verify">Verify</a>
                
                {% elif batch.status == 'verification_complete' %}
                    <a href="{{ url_for('group_batch_page', batch_id=batch.id) }}" class="action-btn btn-group">Group ({{ batch.ungrouped_count }} ungrouped)</a>
                    {% if batch.flagged_count > 0 %}
                        <a href="{{ url_for('review_batch_page', batch_id=batch.id) }}" class="action-btn btn-review">Review ({{ batch.flagged_count }} flagged)</a>
                    {% endif %}
                    <a href="{{ url_for('revisit_batch_page', batch_id=batch.id) }}" class="action-btn btn-revisit">Revisit Pages</a>
                

                {% elif batch.status == 'grouping_complete' %}
                    <a href="{{ url_for('order_batch_page', batch_id=batch.id) }}" class="action-btn btn-order">Order Pages</a>
                    <form action="{{ url_for('reset_grouping_action', batch_id=batch.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="action-btn btn-group">Revisit Grouping</button>
                    </form>

                {% elif batch.status == 'ordering_complete' %}
                    <a href="{{ url_for('finalize_batch_page', batch_id=batch.id) }}" class="action-btn btn-finalize">Finalize & Export</a>
                    <form action="{{ url_for('revisit_ordering_action', batch_id=batch.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="action-btn btn-order">Revisit Ordering</button>
                    </form>
                    <a href="{{ url_for('view_documents_page', batch_id=batch.id) }}" class="action-btn btn-view-docs">View Documents</a>

                {% elif batch.status == 'Exported' %}
                    <a href="{{ url_for('view_documents_page', batch_id=batch.id) }}" class="action-btn btn-view-docs">View Documents</a>

                {% elif batch.status == 'ready_for_manipulation' %}
                    {% if batch.has_been_manipulated %}
                        <form action="{{ url_for('finalize_single_documents_batch_action', batch_id=batch.id) }}" method="post" style="display:inline;">
                            <button type="submit" class="action-btn btn-group" onclick="return confirm('Export all single documents to category folders?');">ðŸŽ¯ Export Single Documents</button>
                        </form>
                    {% else %}
                        <a href="{{ url_for('manipulate_batch_page', batch_id=batch.id) }}" class="action-btn btn-finalize">Manipulate Single Documents</a>
                    {% endif %}
                    <a href="{{ url_for('view_documents_page', batch_id=batch.id) }}" class="action-btn btn-view-docs">View PDFs</a>
                
                {% elif batch.status == 'ready_for_export' %}
                    <form action="{{ url_for('finalize_single_documents_batch_action', batch_id=batch.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="action-btn btn-group" onclick="return confirm('Export all single documents to category folders?');">ðŸŽ¯ Export Single Documents</button>
                    </form>
                    <a href="{{ url_for('manipulate_batch_page', batch_id=batch.id) }}" class="action-btn btn-secondary">Edit Again</a>
                    <a href="{{ url_for('view_documents_page', batch_id=batch.id) }}" class="action-btn btn-view-docs">View PDFs</a>

                {% else %}
                    <a href="{{ url_for('revisit_batch_page', batch_id=batch.id) }}" class="action-btn btn-revisit">Revisit Batch</a>
                {% endif %}

                {% if batch.status != 'pending_verification' and batch.status != 'Exported' %}
                    <form action="{{ url_for('reset_batch_action', batch_id=batch.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to completely reset this batch? All grouping and ordering will be lost.');">
                        <button type="submit" class="action-btn btn-reset">Reset Batch</button>
                    </form>
                {% endif %}
            </td>
            <td>
                <a href="{{ batch.audit_url }}" class="action-btn" style="background-color:#343a40;">Audit</a>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="4" style="text-align: center;">No batches have been processed yet. Click "Start New Batch" to begin.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Script for the "Start New Batch" button
        const batchForm = document.getElementById('batch-form');
        if (batchForm) {
            batchForm.addEventListener('submit', function() {
                const button = document.getElementById('start-button');
                button.disabled = true;
                button.innerText = 'Processing... Please Wait...';
            });
        }

        // Script for the "Finalize & Export" button
        const finalizeLinks = document.querySelectorAll('.btn-finalize');
        finalizeLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                link.classList.add('disabled');
                link.textContent = 'Loading...';
            });
        });

        // Script for the "View Documents" button
        const viewDocsLinks = document.querySelectorAll('.btn-view-docs');
        viewDocsLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                link.classList.add('disabled');
                link.textContent = 'Loading...';
            });
        });
    });
</script>
{% endblock %}