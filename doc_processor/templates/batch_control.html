{% extends 'base.html' %}

{% block title %}Batch Control{% endblock %}

{% block content %}
<style>
    /* General table styling */
    .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .history-table th, .history-table td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
    .history-table th { background-color: #f2f2f2; font-weight: bold; }
    
    /* Styling for action buttons to make them look distinct */
    .action-btn { display: inline-block; padding: 8px 12px; text-decoration: none; color: white; border-radius: 5px; font-size: 0.9em; margin-right: 5px; margin-bottom: 5px; border: none; cursor: pointer; }
    .btn-verify { background-color: #007BFF; } /* Blue */
    .btn-review { background-color: #ffc107; color: black; } /* Yellow */
    .btn-group { background-color: #28a745; } /* Green */
    .btn-order { background-color: #6f42c1; } /* Purple */
    .btn-finalize { background-color: #17a2b8; } /* Teal */
    .btn-view-docs { background-color: #20c997; } /* Brighter Teal for View Docs */
    .btn-revisit { background-color: #6c757d; } /* Gray */
    .btn-reset { background-color: #dc3545; } /* Red */
    .btn-secondary { background-color: #6c757d; } /* Gray for Edit Again */

    /* Style for a disabled-looking link/button */
    .action-btn.disabled {
        background-color: #6c757d;
        pointer-events: none;
        cursor: not-allowed;
    }
    
    /* Styling for the new batch form section */
    .new-batch-form { padding: 20px; background-color: white; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 30px; text-align: center; }
    .new-batch-form button { font-size: 1.2em; padding: 10px 20px; cursor: pointer; width: 100%; background-color: #3182ce; color: white; border-radius: 5px; border: none; }
    .new-batch-form button:hover { background-color: #2c5282; }
</style>

<h1>📊 Batch Control</h1>
<p>Monitor and manage your document processing batches. To start processing new documents, use <strong>Analyze Intake</strong> from the navigation menu.</p>

<form id="start-new-batch" action="{{ url_for('batch.start_new_batch') }}" method="post" style="margin-top:20px;margin-bottom:10px;text-align:right;">
    <button type="submit" class="action-btn btn-group" style="background:#198754;font-size:0.95rem;">➕ Start New Batch</button>
</form>

<table class="history-table">
    <thead>
        <tr>
            <th>🆔 Batch ID</th>
            <th>⏰ Created</th>
            <th>📊 Status</th>
            <th>📄 Docs</th>
            <th>⚙️ Actions</th>
            <th>🔍 Audit</th>
        </tr>
    </thead>
    <tbody>
        {% for batch in batches %}
        <tr>
            <td>#{{ batch.id }}</td>
            <td>{{ batch.start_time }}</td>
            <td>{{ batch.status | replace('_', ' ') | title }}</td>
            <td>{{ batch.document_count }}</td>
            <td>
                {% if batch.status == 'pending_verification' %}
                    <a href="{{ url_for('manipulation.verify_batch', batch_id=batch.id) }}" class="action-btn btn-verify">✅ Verify</a>
                
                {% elif batch.status == 'verification_complete' %}
                    <a href="{{ url_for('manipulation.group_documents', batch_id=batch.id) }}" class="action-btn btn-group">📂 Group ({{ batch.ungrouped_count }} ungrouped)</a>
                    {% if batch.flagged_count > 0 %}
                        <a href="{{ url_for('manipulation.review_batch', batch_id=batch.id) }}" class="action-btn btn-review">🔍 Review ({{ batch.flagged_count }} flagged)</a>
                    {% endif %}
                    <a href="{{ url_for('manipulation.revisit_batch', batch_id=batch.id) }}" class="action-btn btn-revisit">🔄 Revisit Pages</a>
                

                {% elif batch.status == 'grouping_complete' %}
                    <a href="{{ url_for('manipulation.order_documents', batch_id=batch.id) }}" class="action-btn btn-order">📋 Order Pages</a>
                    <form action="{{ url_for('batch.reset_grouping', batch_id=batch.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="action-btn btn-group">🔄 Revisit Grouping</button>
                    </form>

                {% elif batch.status == 'ordering_complete' %}
                    <a href="{{ url_for('export.finalize_page', batch_id=batch.id) }}" class="action-btn btn-finalize">🎯 Finalize & Export</a>
                    <form action="{{ url_for('manipulation.revisit_ordering_batch', batch_id=batch.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="action-btn btn-order">🔄 Revisit Ordering</button>
                    </form>
                    <a href="{{ url_for('manipulation.view_documents', batch_id=batch.id) }}" class="action-btn btn-view-docs">📄 View Documents</a>

                {% elif batch.status == 'Exported' %}
                    <a href="{{ url_for('manipulation.view_documents', batch_id=batch.id) }}" class="action-btn btn-view-docs">📄 View Documents</a>
                    <a href="{{ url_for('manipulation.revisit_batch', batch_id=batch.id) }}" class="action-btn btn-revisit">🔄 Revisit Batch</a>

                {% elif batch.status == 'ready_for_manipulation' %}
                    {% if batch.has_been_manipulated %}
                        <form action="{{ url_for('export.finalize_single_documents_batch', batch_id=batch.id) }}" method="post" style="display:inline;">
                            <button type="submit" class="action-btn btn-group" onclick="return confirm('Export all single documents to category folders?');">🎯 Export Single Documents</button>
                        </form>
                    {% else %}
                        <a href="{{ url_for('manipulation.manipulate_batch_documents', batch_id=batch.id) }}" class="action-btn btn-finalize">⚙️ Manipulate Single Documents</a>
                    {% endif %}
                    <a href="{{ url_for('manipulation.view_documents', batch_id=batch.id) }}" class="action-btn btn-view-docs">View PDFs</a>
                
                {% elif batch.status == 'ready_for_export' %}
                    <form action="{{ url_for('export.finalize_single_documents_batch', batch_id=batch.id) }}" method="post" style="display:inline;">
                        <button type="submit" class="action-btn btn-group" id="export-btn-{{ batch.id }}">🎯 Export Single Documents</button>
                    </form>
                    <a href="{{ url_for('manipulation.manipulate_batch_documents', batch_id=batch.id) }}" class="action-btn btn-secondary">✏️ Edit Again</a>
                    <a href="{{ url_for('manipulation.view_documents', batch_id=batch.id) }}" class="action-btn btn-view-docs">📄 View PDFs</a>

                {% else %}
                    <a href="{{ url_for('manipulation.revisit_batch', batch_id=batch.id) }}" class="action-btn btn-revisit">🔄 Revisit Batch</a>
                {% endif %}

                {% if batch.status != 'pending_verification' %}
                    <form action="{{ url_for('batch.reset_batch', batch_id=batch.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to completely reset this batch? All grouping and ordering will be lost.');">
                        <button type="submit" class="action-btn btn-reset">🔄 Reset Batch</button>
                    </form>
                {% endif %}
            </td>
            <td>
                <a href="{{ batch.audit_url }}" class="action-btn" style="background-color:#343a40;">🔍 Audit</a>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="6" style="text-align: center;">No batches have been processed yet. Click "Start New Batch" to begin.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Script for the "Start New Batch" button
        const batchForm = document.getElementById('batch-form');
        if (batchForm) {
            batchForm.addEventListener('submit', function() {
                const button = document.getElementById('start-button');
                button.disabled = true;
                button.innerText = 'Processing... Please Wait...';
            });
        }

        // Script for the "Finalize & Export" button
        const finalizeLinks = document.querySelectorAll('.btn-finalize');
        finalizeLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                link.classList.add('disabled');
                link.textContent = 'Loading...';
            });
        });

        // Script for the "View Documents" button
        const viewDocsLinks = document.querySelectorAll('.btn-view-docs');
        viewDocsLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                link.classList.add('disabled');
                link.textContent = 'Loading...';
            });
        });
    });
</script>
<script>
// --- Single Document Export Progress Poller ---
document.addEventListener('DOMContentLoaded', () => {
    const exportForms = Array.from(document.querySelectorAll('form'))
        .filter(f => f.action.includes('/export/finalize_single_documents_batch/'));
    if (!exportForms.length) return;

    // Create a lightweight overlay UI
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = 0; overlay.style.left = 0; overlay.style.right = 0; overlay.style.bottom = 0;
    overlay.style.background = 'rgba(0,0,0,0.55)';
    overlay.style.display = 'none';
    overlay.style.zIndex = 9999;
    overlay.innerHTML = `
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:24px 32px;border-radius:8px;min-width:360px;box-shadow:0 4px 18px rgba(0,0,0,0.25);font-family:system-ui, Arial, sans-serif;">
            <h3 style="margin-top:0;margin-bottom:8px;font-size:1.15rem;">Exporting Single Documents…</h3>
            <div id="export-status-msg" style="font-size:0.9rem;margin-bottom:12px;color:#333;">Initializing…</div>
            <div style="background:#eee;border-radius:4px;overflow:hidden;height:14px;margin-bottom:12px;">
                <div id="export-progress-bar" style="height:100%;width:0%;background:#17a2b8;transition:width .4s ease;"></div>
            </div>
            <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:#555;">
                <span id="export-progress-numbers">0 / 0</span>
                <span id="export-progress-percent">0%</span>
            </div>
        </div>`;
    document.body.appendChild(overlay);

    function showOverlay() { overlay.style.display = 'block'; }
    function hideOverlay() { overlay.style.display = 'none'; }

    async function pollProgress(batchId, startTs) {
        let attempts = 0;
        const maxAttempts = 300; // ~10 minutes @ 2s
        while (attempts < maxAttempts) {
            attempts++;
            try {
                const resp = await fetch('/export/api/progress');
                if (!resp.ok) throw new Error('progress fetch failed ' + resp.status);
                const json = await resp.json();
                if (!json.success) throw new Error('progress payload unsuccessful');
                const entry = json.data[String(batchId)] || json.data[batchId];
                if (entry) {
                    const bar = document.getElementById('export-progress-bar');
                    const msgEl = document.getElementById('export-status-msg');
                        const numEl = document.getElementById('export-progress-numbers');
                    const pctEl = document.getElementById('export-progress-percent');
                    const pct = entry.progress || 0;
                    bar.style.width = pct + '%';
                    msgEl.textContent = entry.message || 'Working…';
                    if (typeof entry.current === 'number' && typeof entry.total === 'number') {
                        numEl.textContent = `${entry.current} / ${entry.total}`;
                        pctEl.textContent = pct + '%';
                    }
                    if (entry.status === 'completed' || pct === 100) {
                        // Small delay to let user see 100%
                        await new Promise(r => setTimeout(r, 600));
                        window.location.reload();
                        return;
                    }
                }
            } catch (e) {
                console.warn('[export-poller] error:', e);
            }
            await new Promise(r => setTimeout(r, 2000));
        }
        // Timeout/fallback
        hideOverlay();
        alert('Export progress polling timed out. Refresh the page to verify status.');
    }

    exportForms.forEach(form => {
        form.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const action = form.action;
            const batchMatch = action.match(/finalize_single_documents_batch\/(\d+)/);
            const batchId = batchMatch ? batchMatch[1] : null;
            if (!batchId) { form.submit(); return; }
            showOverlay();
            try {
                const formData = new FormData(form);
                const resp = await fetch(action, { method: 'POST', body: formData });
                if (!resp.ok) throw new Error('Export start failed ' + resp.status);
                const json = await resp.json();
                if (!json.success) throw new Error('Export start returned error');
                pollProgress(batchId, Date.now());
            } catch (e) {
                hideOverlay();
                alert('Failed to start export: ' + e.message);
            }
        });
    });
});
</script>
{% endblock %}