{% extends 'base.html' %}

{% block title %}Finalize & Export Batch {{ batch_id }}{% endblock %}

{% block content %}
<style>
    .finalize-container { max-width: 900px; margin: auto; background-color: white; padding: 20px; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .doc-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .doc-table th, .doc-table td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
    .doc-table th { background-color: #f2f2f2; }
    .filename-input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
    .export-form { margin-top: 20px; text-align: center; }
    .export-btn {
        padding: 12px 30px;
        background-color: #28a745;
        color: white;
        border-radius: 5px;
        font-size: 1.2em;
        border: none;
        cursor: pointer;
    }
    .export-btn:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }
</style>

<div class="finalize-container">
    <h1>ðŸŽ¯ Finalize & Export Batch #{{ batch_id }}</h1>
    <p>Review the AI-suggested filenames below. You can edit them as needed. When you are ready, click the button at the bottom to export all documents and complete the batch.</p>

    <form id="export-form" class="export-form" action="{{ url_for('export.export_batch', batch_id=batch_id) }}" method="post" onsubmit="return handleExportSubmit(this);">
        <table class="doc-table">
            <thead>
                <tr>
                    <th>Document Name</th>
                    <th>Final Filename</th>
                    <th>Page Count</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in documents %}
                <tr>
                    <td>{{ doc.document_name }}</td>
                    <td>
                        <input type="hidden" name="document_ids" value="{{ doc.id }}">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="text" name="final_filenames" class="filename-input" value="{{ doc.suggested_filename }}" id="filename-input-{{ doc.id }}">
                            <button type="button" class="btn btn-ai suggest-btn" data-doc-id="{{ doc.id }}" title="Suggest filename">ðŸ¤–</button>
                            <button type="button" class="btn btn-cancel revert-btn" data-doc-id="{{ doc.id }}" style="display:none;" title="Revert filename">âŸ²</button>
                        </div>
<style>
    .btn { display: inline-block; padding: 6px 14px; text-decoration: none; color: white; border-radius: 5px; border: none; font-size: 1em; cursor: pointer; }
    .btn-ai { background-color: #17a2b8; }
    .btn-cancel { background-color: #6c757d; }
</style>
                    </td>
                    <td>{{ doc.page_count }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="3" style="text-align: center;">No documents found in this batch.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if documents %}
                        <button type="submit" class="export-btn">ðŸš€ Export All Documents</button>
        {% endif %}
    </form>
</div>

<script>
    function handleExportSubmit(form) {
        if (confirm('Are you sure you want to export all documents for this batch? This action is final.')) {
            const button = form.querySelector('#export-button');
            button.disabled = true;
            button.textContent = 'Exporting... Please Wait...';
            return true;
        }
        return false;
    }

    // --- SUGGEST/REVERT BUTTON LOGIC ---
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.suggest-btn').forEach(function(btn) {
            btn.addEventListener('click', async function() {
                const docId = btn.getAttribute('data-doc-id');
                const input = document.getElementById('filename-input-' + docId);
                const revertBtn = document.querySelector('.revert-btn[data-doc-id="' + docId + '"]');
                const original = input.value;
                btn.disabled = true;
                btn.textContent = '...';
                try {
                    const resp = await fetch(`/api/suggest_name/${docId}`, { method: 'POST' });
                    const data = await resp.json();
                    if (data.success && data.suggested_name) {
                        input.value = data.suggested_name;
                        revertBtn.style.display = '';
                        revertBtn.setAttribute('data-original', original);
                    } else {
                        alert('AI suggestion failed: ' + (data.error || 'Unknown error'));
                    }
                } catch (e) {
                    alert('Error contacting AI suggestion API.');
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'ðŸ¤–';
                }
            });
        });
        document.querySelectorAll('.revert-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const docId = btn.getAttribute('data-doc-id');
                const input = document.getElementById('filename-input-' + docId);
                const original = btn.getAttribute('data-original');
                if (original) input.value = original;
                btn.style.display = 'none';
            });
        });
    });
</script>
{% endblock %}