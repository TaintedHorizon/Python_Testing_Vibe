<!--
This HTML template is the user interface for the "Grouping" stage of the document processing workflow.
Its primary purpose is to allow a user to take individual, verified pages and assemble them into logical, multi-page documents.

Key Features:
- A two-column layout for efficient user interaction.
- Left Column: A large preview area to display a high-resolution image of a selected page.
- Right Column: The main interaction pane, which includes:
    - A list of documents already created in the current batch.
    - A form to create a new document by giving it a name and selecting pages.
    - A scrollable list of available, ungrouped pages, conveniently grouped by their verified category.
- JavaScript enhancements for a smoother user experience, including:
    - Image preview functionality.
    - "Select All" checkboxes for each category.
    - Applying the correct rotation to page thumbnails.
- A final "Finish" button that appears once all pages have been grouped, guiding the user to the next step.
-->
{% extends 'base.html' %}

<!-- Sets the browser tab title, dynamically including the current batch ID for context. -->
{% block title %}Group Documents for Batch {{ batch_id }}{% endblock %}

<!-- Main content block that will be injected into the base template. -->
{% block content %}
<style>
    /* 
      This page uses a CSS Grid layout to create a responsive two-column view.
      - The left column (`preview-pane`) is for viewing a large image.
      - The right column (`selection-pane`) contains all the interactive controls.
      `align-items: start;` ensures that the columns align at the top.
    */
    .group-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
    .preview-pane, .selection-pane { border: 1px solid #ccc; padding: 15px; background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    /* Styles for the large image preview area. It takes up 75% of the viewport height. */
    .preview-wrapper { width: 100%; height: 75vh; border: 1px solid #ddd; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; overflow: hidden; color: #888; border-radius: 3px; }
    .preview-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; /* `contain` ensures the entire image is visible without being cropped. */ }

    /* Styles for the scrollable list of available pages. */
    .page-list { max-height: 40vh; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 10px; background-color: #fdfdfd; }
    .category-group { margin-bottom: 20px; } /* Provides spacing between different category sections. */
    .category-header { display: flex; justify-content: space-between; align-items: center; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; }
    .page-item { display: flex; align-items: center; margin-bottom: 8px; background-color: #fafafa; padding: 5px; border-radius: 3px; cursor: pointer; transition: background-color 0.2s; }
    .page-item:hover { background-color: #e9e9e9; } /* Visual feedback on hover. */
    .page-item input { margin-right: 10px; transform: scale(1.5); /* Makes the checkbox slightly larger and easier to click. */ }
    .page-item img {
        width: 40px;
        height: 52px;
        object-fit: cover;
        border: 1px solid #ccc;
        margin-right: 10px;
        transition: transform 0.2s; /* Smooth transition for the rotation effect. */
    }

    /* Styles for the list of documents that have already been created. */
    .doc-list { max-height: 20vh; overflow-y: auto; }
    .doc-list-item { background-color: #f0f9ff; border: 1px solid #cde4f5; padding: 8px; margin-bottom: 5px; border-radius: 3px; }

    /* Utility styles for displaying error messages and action buttons. */
    .error-message { color: #c53030; background-color: #fed7d7; border: 1px solid #f56565; padding: 10px; border-radius: 5px; font-weight: bold; margin-bottom: 10px; }
    .finish-button { width: 100%; padding: 10px; margin-top: 15px; background-color: #17a2b8; color: white; border: none; font-size: 1.2em; text-align: center; text-decoration: none; display: inline-block; border-radius: 5px; cursor: pointer; }
    .reset-grouping-btn { background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; float: right; /* Floats the button to the right of the "Created Documents" header. */}
</style>

<h1>Group Documents for Batch #{{ batch_id }}</h1>
<p>This is the second step of the workflow. Group verified pages into logical documents. Select pages from the same category and give the document a name.</p>
<hr>

<div class="group-container">
    <!-- Left Pane: A large area to preview a selected page image. -->
    <div class="preview-pane">
        <h3>Page Preview</h3>
        <div class="preview-wrapper">
            <!-- This placeholder text is shown before any page is selected. -->
            <span id="previewPlaceholder">Select a page from the right to preview it here.</span>
            <!-- The image tag that will be populated by the JavaScript. It is hidden by default. -->
            <img id="previewImage" src="" alt="Page Preview" style="display: none;">
        </div>
    </div>

    <!-- Right Pane: Contains all the interactive elements for selection and creation. -->
    <div class="selection-pane">

        <!-- Section to display documents that have already been created in this batch. -->
        <h3>Created Documents</h3>
        <div id="doc-list" class="doc-list">
            {% if created_docs %}
                <!-- This form allows the user to undo all grouping for the batch. It submits a POST request to the reset_grouping_action endpoint. -->
                <form action="{{ url_for('reset_grouping_action', batch_id=batch_id) }}" method="post" onsubmit="return confirm('Are you sure you want to reset all grouping for this batch? This cannot be undone.');">
                    <button type="submit" class="reset-grouping-btn">Reset All Groups</button>
                </form>
                <!-- Loop through and display the names of the created documents. -->
                {% for doc in created_docs %}
                    <div class="doc-list-item">{{ doc.document_name }}</div>
                {% endfor %}
            {% else %}
                <p>No documents have been created for this batch yet.</p>
            {% endif %}
        </div>
        <hr style="clear:both; margin-top: 40px; margin-bottom: 20px;">

        <!-- Section for creating a new document. -->
        <h3>Create a New Document</h3>

        <!-- If the previous form submission failed (e.g., no pages selected), a descriptive error is shown here. The error message is passed as a URL parameter. -->
        {% if request.args.get('error') %}
            <p class="error-message">{{ request.args.get('error') }}</p>
        {% endif %}

        <!-- This entire form is only shown if there are still ungrouped pages available. -->
        {% if grouped_pages %}
            <form action="{{ url_for('save_document_action') }}" method="post">
                <!-- Hidden input to pass the batch_id back to the server on form submission. -->
                <input type="hidden" name="batch_id" value="{{ batch_id }}">
                <div style="margin-bottom: 15px;">
                    <label for="document_name" style="font-weight: bold;">New Document Name:</label>
                    <input type="text" id="document_name" name="document_name" required style="width: 100%; padding: 8px; box-sizing: border-box;">
                </div>

                <label style="font-weight: bold;">Select Pages to Include:</label>
                <div class="page-list">
                    <!-- The outer loop iterates through the `grouped_pages` dictionary (e.g., {'Receipt': [page1, page2], 'Letter': [page3]}). -->
                    {% for category, pages in grouped_pages.items() %}
                        <!-- Create a URL-safe slug from the category name (e.g., "Financial Document" -> "Financial-Document") for use in CSS classes. -->
                        {% set category_slug = category|replace(' ', '-')|replace('/', '-') %}
                        <div class="category-group">
                            <div class="category-header">
                                <h4>{{ category }} ({{ pages|length }} available)</h4>
                                <!-- A "Select All" checkbox for this specific category. The `data-category` attribute links it to its corresponding page checkboxes. -->
                                <label><input type="checkbox" class="select-all-checkbox" data-category="{{ category_slug }}"> Select All</label>
                            </div>
                            <!-- The inner loop iterates through each page object within the current category. -->
                            {% for page in pages %}
                                <!-- This div represents a single selectable page item. It has a click handler to show the preview. -->
                                <div class="page-item" data-rotation="{{ page.rotation_angle or 0 }}" onclick="showPreview('{{ url_for('serve_processed_file', filepath=page.relative_image_path) }}')">
                                    <!-- The checkbox for selecting this page. `event.stopPropagation()` is crucial; it prevents a click on the checkbox from also triggering the parent div's `onclick` event. -->
                                    <input type="checkbox" name="page_ids" value="{{ page.id }}" class="page-checkbox-{{ category_slug }}" onclick="event.stopPropagation();">
                                    <img src="{{ url_for('serve_processed_file', filepath=page.relative_image_path) }}" alt="Thumbnail">
                                    <span>ID: {{ page.id }} ({{ page.source_filename }}, Pg {{ page.page_number }})</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
                <button type="submit" style="width: 100%; padding: 10px; margin-top: 15px; background-color: #28a745; color: white; border: none; font-size: 1.2em; cursor: pointer;">Save New Document</button>
            </form>
        {% else %}
            <!-- This block is displayed as a success state when all pages in the batch have been grouped into documents. -->
            <div style="text-align: center;">
                <p style="color: green; font-weight: bold;">ðŸŽ‰ Grouping is complete for this batch!</p>
                <p>You can now proceed to the next step if any documents need page ordering.</p>
                <!-- This link acts as a button, guiding the user to the next logical step in the workflow. -->
                <a href="{{ url_for('order_batch_page', batch_id=batch_id) }}" class="finish-button">Proceed to Ordering</a>
            </div>
        {% endif %}
    </div>
</div>

<script>
    const previewImage = document.getElementById('previewImage');
    const previewPlaceholder = document.getElementById('previewPlaceholder');

    /**
     * Updates the main preview pane with the image of the clicked page item.
     * @param {string} imageUrl - The URL of the image to display.
     */
    function showPreview(imageUrl) {
        // Hide the placeholder text and show the image element.
        if (previewPlaceholder) previewPlaceholder.style.display = 'none';
        if (previewImage) {
            previewImage.style.display = 'block';
            previewImage.src = imageUrl;
        }
    }

    // `DOMContentLoaded` ensures that the script runs only after the entire HTML page has been loaded and the DOM tree is ready.
    document.addEventListener('DOMContentLoaded', () => {

        // Apply the correct rotation to all thumbnail images based on the `data-rotation` attribute set by the backend.
        const pageItems = document.querySelectorAll('.page-item');
        pageItems.forEach(item => {
            const angle = item.dataset.rotation || 0;
            const img = item.querySelector('img');
            if (img && angle != 0) {
                // Apply a CSS transform to rotate the image.
                img.style.transform = `rotate(${angle}deg)`;
            }
        });

        // Add event listeners to all the "Select All" checkboxes.
        const selectAllCheckboxes = document.querySelectorAll('.select-all-checkbox');
        selectAllCheckboxes.forEach(headerCheckbox => {
            headerCheckbox.addEventListener('change', function() {
                // Get the category slug from the `data-category` attribute.
                const category = this.dataset.category;
                // Find all page checkboxes that belong to this category using the shared class name.
                const pageCheckboxes = document.querySelectorAll(`.page-checkbox-${category}`);
                // Set the checked status of all page checkboxes to match the state of the "Select All" checkbox.
                pageCheckboxes.forEach(pageCheckbox => {
                    pageCheckbox.checked = this.checked;
                });
            });
        });
    });
</script>
{% endblock %}
