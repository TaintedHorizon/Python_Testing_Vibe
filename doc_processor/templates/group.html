{% extends 'base.html' %}

{% block title %}Group Documents for Batch {{ batch_id }}{% endblock %}

{% block content %}
<style>
    /* Styles for the two-column layout */
    .group-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: start; }
    .preview-pane, .selection-pane { border: 1px solid #ccc; padding: 15px; background-color: white; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    
    /* Styles for the image preview area */
    .preview-wrapper { width: 100%; height: 75vh; border: 1px solid #ddd; background-color: #f0f0f0; display: flex; align-items: center; justify-content: center; overflow: hidden; color: #888; border-radius: 3px; }
    .preview-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; }
    
    /* Styles for the list of selectable pages */
    .page-list { max-height: 40vh; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 10px; background-color: #fdfdfd; }
    .category-group { margin-bottom: 20px; }
    .category-header { display: flex; justify-content: space-between; align-items: center; margin: 0 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid #eee; }
    .page-item { display: flex; align-items: center; margin-bottom: 8px; background-color: #fafafa; padding: 5px; border-radius: 3px; cursor: pointer; transition: background-color 0.2s; }
    .page-item:hover { background-color: #e9e9e9; }
    .page-item input { margin-right: 10px; transform: scale(1.5); }
    .page-item img {
        width: 40px;
        height: 52px;
        object-fit: cover;
        border: 1px solid #ccc;
        margin-right: 10px;
        transition: transform 0.2s; /* Smooth transition for rotation */
    }

    /* Styles for the list of already created documents */
    .doc-list { max-height: 20vh; overflow-y: auto; }
    .doc-list-item { background-color: #f0f9ff; border: 1px solid #cde4f5; padding: 8px; margin-bottom: 5px; border-radius: 3px; }
    
    /* Utility and button styles */
    .error-message { color: #c53030; background-color: #fed7d7; border: 1px solid #f56565; padding: 10px; border-radius: 5px; font-weight: bold; margin-bottom: 10px; }
    .finish-button { width: 100%; padding: 10px; margin-top: 15px; background-color: #17a2b8; color: white; border: none; font-size: 1.2em; text-align: center; text-decoration: none; display: inline-block; border-radius: 5px; cursor: pointer; }
    .reset-grouping-btn { background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; float: right;}
</style>

<h1>Group Documents for Batch #{{ batch_id }}</h1>
<p>This is the second step of the workflow. Group verified pages into logical documents. Select pages from the same category and give the document a name.</p>
<hr>

<div class="group-container">
    <!-- Left Pane: Image Preview -->
    <div class="preview-pane">
        <h3>Page Preview</h3>
        <div class="preview-wrapper">
            <span id="previewPlaceholder">Select a page from the right to preview it here.</span>
            <img id="previewImage" src="" alt="Page Preview" style="display: none;">
        </div>
    </div>

    <!-- Right Pane: Selection and Creation -->
    <div class="selection-pane">
        
        <!-- Section to display documents already created in this batch -->
        <h3>Created Documents</h3>
        <div id="doc-list" class="doc-list">
            {% if created_docs %}
                <!-- Form to reset all grouping for this batch -->
                <form action="{{ url_for('reset_grouping_action', batch_id=batch_id) }}" method="post" onsubmit="return confirm('Are you sure you want to reset all grouping for this batch? This cannot be undone.');">
                    <button type="submit" class="reset-grouping-btn">Reset All Groups</button>
                </form>
                {% for doc in created_docs %}
                    <div class="doc-list-item">{{ doc.document_name }}</div>
                {% endfor %}
            {% else %}
                <p>No documents have been created for this batch yet.</p>
            {% endif %}
        </div>
        <hr style="clear:both; margin-top: 40px; margin-bottom: 20px;">

        <!-- Section to create a new document -->
        <h3>Create a New Document</h3>
        
        <!-- Display an error message if the form submission failed -->
        {% if request.args.get('error') %}
            <p class="error-message">{{ request.args.get('error') }}</p>
        {% endif %}

        <!-- This block is shown only if there are ungrouped pages available -->
        {% if grouped_pages %}
            <form action="{{ url_for('save_document_action') }}" method="post">
                <input type="hidden" name="batch_id" value="{{ batch_id }}">
                <div style="margin-bottom: 15px;">
                    <label for="document_name" style="font-weight: bold;">New Document Name:</label>
                    <input type="text" id="document_name" name="document_name" required style="width: 100%; padding: 8px; box-sizing: border-box;">
                </div>
                
                <label style="font-weight: bold;">Select Pages to Include:</label>
                <div class="page-list">
                    <!-- Loop through pages, grouped by category -->
                    {% for category, pages in grouped_pages.items() %}
                        {% set category_slug = category|replace(' ', '-')|replace('/', '-') %}
                        <div class="category-group">
                            <div class="category-header">
                                <h4>{{ category }} ({{ pages|length }} available)</h4>
                                <!-- "Select All" checkbox for this category -->
                                <label><input type="checkbox" class="select-all-checkbox" data-category="{{ category_slug }}"> Select All</label>
                            </div>
                            <!-- Loop through each page in the category -->
                            {% for page in pages %}
                                <div class="page-item" data-rotation="{{ page.rotation_angle or 0 }}" onclick="showPreview('{{ url_for('serve_processed_file', filepath=page.relative_image_path) }}')">
                                    <input type="checkbox" name="page_ids" value="{{ page.id }}" class="page-checkbox-{{ category_slug }}" onclick="event.stopPropagation();">
                                    <img src="{{ url_for('serve_processed_file', filepath=page.relative_image_path) }}" alt="Thumbnail">
                                    <span>ID: {{ page.id }} ({{ page.source_filename }}, Pg {{ page.page_number }})</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
                <button type="submit" style="width: 100%; padding: 10px; margin-top: 15px; background-color: #28a745; color: white; border: none; font-size: 1.2em; cursor: pointer;">Save New Document</button>
            </form>
        {% else %}
            <!-- This block is shown when all verified pages have been grouped -->
            <div style="text-align: center;">
                <p style="color: green; font-weight: bold;">ðŸŽ‰ Grouping is complete for this batch!</p>
                <p>You can now proceed to the next step if any documents need page ordering.</p>
                <a href="{{ url_for('order_batch_page', batch_id=batch_id) }}" class="finish-button">Proceed to Ordering</a>
            </div>
        {% endif %}
    </div>
</div>

<script>
    const previewImage = document.getElementById('previewImage');
    const previewPlaceholder = document.getElementById('previewPlaceholder');

    // Function to update the main preview pane with the selected image.
    function showPreview(imageUrl) {
        if (previewPlaceholder) previewPlaceholder.style.display = 'none';
        if (previewImage) {
            previewImage.style.display = 'block';
            previewImage.src = imageUrl;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // This script runs after the page has fully loaded.

        // Apply the correct rotation to all thumbnail images based on the data from the database.
        const pageItems = document.querySelectorAll('.page-item');
        pageItems.forEach(item => {
            const angle = item.dataset.rotation || 0;
            const img = item.querySelector('img');
            if (img && angle != 0) {
                img.style.transform = `rotate(${angle}deg)`;
            }
        });

        // Add event listeners to the "Select All" checkboxes.
        const selectAllCheckboxes = document.querySelectorAll('.select-all-checkbox');
        selectAllCheckboxes.forEach(headerCheckbox => {
            headerCheckbox.addEventListener('change', function() {
                const category = this.dataset.category;
                const pageCheckboxes = document.querySelectorAll(`.page-checkbox-${category}`);
                // When a "Select All" checkbox is changed, update all page checkboxes in that category.
                pageCheckboxes.forEach(pageCheckbox => {
                    pageCheckbox.checked = this.checked;
                });
            });
        });
    });
</script>
{% endblock %}
