<!-- Intake Analysis Preview Template -->
{% extends 'base.html' %}

{% block title %}Intake Analysis{% endblock %}

{% block content %}
<!-- Include PDF Modal Viewer Component -->
{% include 'components/pdf_modal.html' %}

<style>
.strategy-override-container {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 10px;
    font-size: 0.9em;
}

.strategy-override-select {
    font-size: 0.85em;
    padding: 4px 8px;
}

.override-status {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 4px;
    padding: 6px 8px;
    margin-top: 4px;
}

.override-indicator {
    font-weight: 500;
}

.strategy-override-container .text-muted {
    color: #6c757d !important;
}
</style>

<div class="container">
    <h1>ÔøΩ Intake Analysis</h1>
    <div class="container">
        <h1>üìä Intake Analysis</h1>
    <div class="alert alert-info text-center">
        <button id="start-analysis-btn" onclick="startAnalysis()" class="btn btn-primary">üîç Start Analysis</button>
        <form method="post" action="{{ url_for('admin.clear_analysis_cache') }}" style="display: inline-block; margin-left: 10px;" onsubmit="handleForceReAnalysis(this, event)">
            <button type="submit" id="force-reanalysis-btn" class="btn btn-secondary">üîÑ Force Re-Analysis</button>
        </form>
        <p class="mt-2">Click to analyze your intake files and determine optimal processing strategies for each document.</p>
        {% if analyses %}
        <div class="alert alert-success mt-3">
            <strong>üìå Cached Results Available:</strong> Previous analysis results are shown below. Use "Force Re-Analysis" to refresh if files have changed.
        </div>
        {% endif %}
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="alert alert-primary text-center" style="display: none;">
        <div class="spinner-border text-primary mb-3" role="status">
        </div>
        <h4>ü§ñ Analyzing Your Documents...</h4>
        <p class="mb-3">Please wait while we examine your intake files and determine optimal processing strategies.</p>
        
        <!-- Progress Bar -->
        <div class="progress mb-3" style="height: 30px; max-width: 500px; margin: 0 auto;">
            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                 role="progressbar" 
                 style="width: 0%; white-space: nowrap; font-weight: 500; font-size: 14px; line-height: 30px;"
                 aria-valuenow="0" 
                 aria-valuemin="0" 
                 aria-valuemax="100">
                0 of 0 PDFs
            </div>
        </div>
        
        <small class="text-muted">This may take a few moments for large files or when consulting the AI...</small>
    </div>
    
    <!-- Results State -->
    <div id="results-state" style="display: none;">
        <div class="alert alert-info">
            <strong>Smart Processing:</strong> The system has analyzed your intake files and suggests the optimal processing strategy for each document. Review the recommendations below before proceeding.
        </div>

        <!-- Results will be populated here by JavaScript -->
        <div id="analysis-results"></div>
    </div>
    
    <!-- No Files State -->
    <div id="no-files-state" style="display: none;">
        <div class="alert alert-warning text-center">
            <h4>üìÅ No PDF Files Found</h4>
            <p>No PDF files were found in the intake directory.</p>
            <p><code>{{ intake_dir }}</code></p>
            <p>Please add some PDF files to the intake directory, then click the button below to check again.</p>
            
            <div class="mt-3">
                <button id="recheck-btn" onclick="recheckForPDFs()" class="btn btn-primary btn-lg">
                    <span id="recheck-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                    <span id="recheck-text">üîÑ Re-check for PDFs</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Error State -->
        <div id="error-state" style="display: none;" class="text-center">
            <h4>‚ùå Analysis Failed</h4>
            <p id="error-message"></p>
            <!-- The main Start Analysis button at the top becomes 'üîÑ Retry Analysis' when this is visible. -->
        </div>    {% if False %} <!-- Hide the static template content -->
    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3>{{ single_count }}</h3>
                    <p>Single Documents<br><small>Fast processing, direct to finalization</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3>{{ batch_count }}</h3>
                    <p>Batch Scans<br><small>Page-by-page verification workflow</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3>{{ total_count }}</h3>
                    <p>Total Files<br><small>Ready for processing</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analysis Table -->
    <div class="card">
        <div class="card-header">
            <h5>üìÑ File Analysis Details</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Size</th>
                            <th>Pages</th>
                            <th>Processing Strategy</th>
                            <th>Confidence</th>
                            <th>Reasoning</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for analysis in analyses %}
                        <tr>
                            <td>
                                <strong>{{ analysis.filename }}</strong>
                                {% if analysis.filename_hints == "single" %}
                                <span class="badge badge-success">üìÑ Document</span>
                                {% elif analysis.filename_hints == "batch" %}
                                <span class="badge badge-primary">üìö Batch</span>
                                {% endif %}
                            </td>
                            <td>{{ "%.1f"|format(analysis.file_size_mb) }} MB</td>
                            <td>{{ analysis.page_count }}</td>
                            <td>
                                {% if analysis.processing_strategy == "single_document" %}
                                <span class="badge badge-success">üöÄ Single Document</span>
                                <br><small class="text-muted">Direct processing</small>
                                {% else %}
                                <span class="badge badge-primary">üìã Batch Scan</span>
                                <br><small class="text-muted">Page verification</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="progress" style="width: 80px;">
                                    {% set confidence_percent = (analysis.confidence * 100)|int %}
                                    <div class="progress-bar 
                                        {% if confidence_percent >= 70 %}bg-success
                                        {% elif confidence_percent >= 50 %}bg-warning
                                        {% else %}bg-secondary{% endif %}" 
                                        style="width: {{ confidence_percent }}%">
                                    </div>
                                </div>
                                <small>{{ "%.0f"|format(analysis.confidence * 100) }}%</small>
                            </td>
                            <td>
                                <ul class="list-unstyled mb-0" style="font-size: 0.85em;">
                                    {% for reason in analysis.reasoning[:3] %}
                                    <li>‚Ä¢ {{ reason }}</li>
                                    {% endfor %}
                                    {% if analysis.reasoning|length > 3 %}
                                    <li><small class="text-muted">... and {{ analysis.reasoning|length - 3 }} more</small></li>
                                    {% endif %}
                                </ul>
                                {% if analysis.llm_analysis %}
                                <div class="mt-2 p-2 bg-light rounded" style="font-size: 0.8em;">
                                    <strong>ü§ñ LLM Analysis:</strong>
                                    <br><span class="text-primary">{{ analysis.llm_analysis.classification|title }}</span> 
                                    ({{ analysis.llm_analysis.confidence }}% confidence)
                                    <br><small class="text-muted">{{ analysis.llm_analysis.reasoning[:80] }}{% if analysis.llm_analysis.reasoning|length > 80 %}...{% endif %}</small>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Content Samples (if available) -->
    {% set sample_analyses = analyses[:3] %}
    {% if sample_analyses %}
    <div class="card mt-4">
        <div class="card-header">
            <h5>üìù Content Samples</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for analysis in sample_analyses %}
                {% if analysis.content_sample %}
                <div class="col-md-4 mb-3">
                    <div class="card border-secondary">
                        <div class="card-header bg-light">
                            <small><strong>{{ analysis.filename }}</strong></small>
                        </div>
                        <div class="card-body" style="max-height: 150px; overflow-y: auto;">
                            <small class="text-monospace">{{ analysis.content_sample }}</small>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h5>üéØ Smart Processing</h5>
                    <p class="text-muted"><strong>Recommended:</strong> Use AI recommendations for optimal processing.</p>
                    <form action="{{ url_for('batch.process_batch_smart') }}" method="post">
                        <button type="submit" class="btn btn-success btn-lg btn-block">
                            üöÄ Smart Processing
                        </button>
                    </form>
                    <small class="text-muted mt-2 d-block">Best balance of speed and safety</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h5>üèÉ‚Äç‚ôÇÔ∏è Speed Mode</h5>
                    <p class="text-muted">Process all files as single documents for maximum speed.</p>
                    <form action="{{ url_for('batch.process_batch_all_single') }}" method="post">
                        <button type="submit" class="btn btn-info btn-lg btn-block">
                            ‚ö° All as Single Documents
                        </button>
                    </form>
                    <small class="text-muted mt-2 d-block">Fastest processing, skip verification</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h5>ÔøΩÔ∏è Safety Mode</h5>
                    <p class="text-muted">Process all files as batch scans for maximum control.</p>
                    <form action="{{ url_for('batch.process_batch_force_traditional') }}" method="post">
                        <button type="submit" class="btn btn-warning btn-lg btn-block">
                            üìã All as Batch Scans
                        </button>
                    </form>
                    <small class="text-muted mt-2 d-block">Traditional workflow with verification</small>
                </div>
            </div>
        </div>
    </div>



    <!-- Help Section -->
    <div class="card mt-4 border-info">
        <div class="card-header bg-info text-white">
            <h5>üí° Processing Strategy Guide</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6>üéØ Smart Processing</h6>
                    <ul>
                        <li><strong>Uses AI recommendations</strong></li>
                        <li><strong>Best balance</strong> of speed and safety</li>
                        <li><strong>Single docs:</strong> Fast track (~30s each)</li>
                        <li><strong>Batch scans:</strong> Full verification</li>
                        <li><strong>Recommended</strong> for most users</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6>‚ö° All as Single Documents</h6>
                    <ul>
                        <li><strong>Speed mode:</strong> Fastest processing</li>
                        <li><strong>All files:</strong> Direct to export</li>
                        <li><strong>Time:</strong> ~30 seconds per document</li>
                        <li><strong>Best for:</strong> Trusted individual files</li>
                        <li><strong>Risk:</strong> No verification step</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6>ÔøΩÔ∏è All as Batch Scans</h6>
                    <ul>
                        <li><strong>Safety mode:</strong> Maximum control</li>
                        <li><strong>All files:</strong> Full verification workflow</li>
                        <li><strong>Time:</strong> ~2-5 minutes per document</li>
                        <li><strong>Best for:</strong> Unknown or complex files</li>
                        <li><strong>Benefit:</strong> Human verification of everything</li>
                    </ul>
                </div>
            </div>
            <div class="alert alert-success mt-3">
                <strong>üéØ Recommendation:</strong> Smart Processing is recommended - it will automatically fast-track obvious single documents while ensuring complex files get proper human verification. This typically saves 50-70% processing time.
            </div>
        </div>
    </div>
    {% endif %}
    </div> <!-- Close results-state -->
</div> <!-- Close container -->

<!-- Navigation Section (Always visible at bottom) -->
<div class="navigation-footer mt-5 pt-4 border-top">
    <div class="text-center">
        <a href="{{ url_for('batch.batch_control') }}" class="action-btn btn-revisit btn-center">üè† Batch Control</a>
    </div>
</div>

<style>
.progress {
    height: 10px;
}
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.badge {
    font-size: 0.75em;
}
.spinner-border {
    width: 3rem;
    height: 3rem;
}

/* Action button styles matching the project */
.action-btn { 
    display: inline-block; 
    padding: 12px 20px; 
    text-decoration: none; 
    color: white; 
    border-radius: 5px; 
    font-size: 1em; 
    margin-right: 5px; 
    margin-bottom: 5px; 
    border: none; 
    cursor: pointer; 
    font-weight: 500;
    transition: background-color 0.2s, transform 0.1s;
}
.action-btn:hover {
    text-decoration: none;
    color: white;
    transform: translateY(-1px);
}
.btn-revisit { 
    background-color: #6c757d; 
}
.btn-revisit:hover { 
    background-color: #5a6268; 
}

/* Navigation section styling */
.navigation-footer {
    width: 100%;
    margin-top: 3rem !important;
    padding-top: 2rem !important;
    border-top: 2px solid #dee2e6 !important;
    text-align: center !important;
}

.btn-center {
    display: inline-block !important;
    margin: 0 auto !important;
    text-align: center !important;
}
</style>

<script>
// Start analysis automatically when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Check if we have cached results from server
    {% if analyses %}
    console.log('Using cached analysis results from server');
    const cachedData = {
        analyses: {{ analyses | tojson }},
        single_count: {{ analyses | selectattr("processing_strategy", "equalto", "single_document") | list | length }},
        batch_count: {{ analyses | selectattr("processing_strategy", "equalto", "batch_scan") | list | length }},
        total_count: {{ analyses | length }}
    };
    document.getElementById('results-state').style.display = 'block';
    populateResults(cachedData);
    {% else %}
    console.log('No cached results, waiting for manual trigger');
    {% endif %}
});

function startAnalysis() {
    // Disable and update button state - handle both initial and retry buttons
    const startBtns = document.querySelectorAll('[onclick="startAnalysis()"]');
    startBtns.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    
    // Also disable the Force Re-Analysis button during analysis
    const forceReanalysisBtn = document.getElementById('force-reanalysis-btn');
    if (forceReanalysisBtn) {
        forceReanalysisBtn.disabled = true;
        forceReanalysisBtn.classList.remove('btn-secondary');
        forceReanalysisBtn.classList.add('btn-outline-secondary');
    }
    
    // Show loading state with progress bar
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('results-state').style.display = 'none';
    document.getElementById('no-files-state').style.display = 'none';
    document.getElementById('error-state').style.display = 'none';
    
    // Use Server-Sent Events for real-time progress
    const eventSource = new EventSource('{{ url_for('intake.analyze_intake_progress') }}');
    
    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('Progress update:', data);
            
            if (data.error) {
                eventSource.close();
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-message').textContent = data.error;
                // Now that error-state is visible, set primary button to Retry
                resetStartButton();
                return;
            }
            
            if (data.complete) {
                // Analysis complete
                console.log('Analysis complete:', data);
                eventSource.close();
                resetStartButton();
                document.getElementById('loading-state').style.display = 'none';
                
                if (data.analyses.length === 0) {
                    document.getElementById('no-files-state').style.display = 'block';
                } else {
                    document.getElementById('results-state').style.display = 'block';
                    // Convert format to match existing populateResults function
                    const formattedData = {
                        success: true,
                        analyses: data.analyses,
                        single_count: data.single_count,
                        batch_count: data.batch_count,
                        total_count: data.total
                    };
                    
                    // Store analysis data globally for strategy override functionality
                    window.analysisData = formattedData;
                    
                    // Cache results for this session
                    sessionStorage.setItem('intake_analysis_results', JSON.stringify(formattedData));
                    
                    populateResults(formattedData);
                }
            } else {
                // Progress update - update the loading UI
                updateLoadingProgress(data);
            }
        } catch (parseError) {
            console.error('Error parsing SSE data:', parseError, event.data);
        }
    };
    
    eventSource.onerror = function(error) {
        console.error('EventSource error:', error);
        eventSource.close();
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'block';
        document.getElementById('error-message').textContent = 'Connection lost during analysis.';
        // Ensure button becomes Retry when error panel is shown
        resetStartButton();
    };
}

function resetStartButton() {
    const startBtns = document.querySelectorAll('[onclick="startAnalysis()"]');
    startBtns.forEach(btn => {
        btn.disabled = false;
        // Reset to original text based on context
        const errorVisible = document.getElementById('error-state') && 
                             getComputedStyle(document.getElementById('error-state')).display !== 'none';
        btn.innerHTML = errorVisible ? 'üîÑ Retry Analysis' : 'üîç Start Analysis';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
    });
    
    // Also re-enable the Force Re-Analysis button
    const forceReanalysisBtn = document.getElementById('force-reanalysis-btn');
    if (forceReanalysisBtn) {
        forceReanalysisBtn.disabled = false;
        forceReanalysisBtn.classList.remove('btn-outline-secondary');
        forceReanalysisBtn.classList.add('btn-secondary');
    }
}

function updateLoadingProgress(data) {
    const progressPercent = data.total > 0 ? Math.round((data.progress / data.total) * 100) : 0;
    const progressText = data.total > 0 ? `${data.progress} of ${data.total} PDFs` : '0 of 0 PDFs';
    
    // Update progress bar
    const progressBar = document.querySelector('#loading-state .progress-bar');
    if (progressBar) {
        progressBar.style.width = progressPercent + '%';
        progressBar.textContent = progressText;
    }
    
    // Update status message
    const statusMessage = document.querySelector('#loading-state p');
    if (statusMessage) {
        if (data.current_file) {
            statusMessage.textContent = `Analyzing: ${data.current_file}`;
        } else if (data.message) {
            statusMessage.textContent = data.message;
        }
    }
    
    console.log(`Progress: ${progressText} PDFs (${progressPercent}%)`);
}

function handleForceReAnalysis(form, event) {
    // Disable the Force Re-Analysis button immediately
    const btn = form.querySelector('#force-reanalysis-btn');
    const originalText = btn.innerHTML;
    
    // Update button to show processing state
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Clearing Cache...';
    btn.classList.remove('btn-secondary');
    btn.classList.add('btn-outline-secondary');
    
    // Also disable the Start Analysis button
    const startBtns = document.querySelectorAll('[onclick="startAnalysis()"]');
    startBtns.forEach(startBtn => {
        startBtn.disabled = true;
        startBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        startBtn.classList.remove('btn-primary');
        startBtn.classList.add('btn-secondary');
    });
    
    // Show loading message
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('results-state').style.display = 'none';
    document.getElementById('no-files-state').style.display = 'none';
    document.getElementById('error-state').style.display = 'none';
    
    // Update loading message
    const statusMessage = document.querySelector('#loading-state p');
    if (statusMessage) {
        statusMessage.textContent = 'Clearing cache and preparing for fresh analysis...';
    }
    
    // Allow form to submit normally - the page will refresh and show the analysis UI
    return true;
}

function startAnalysisOld() {
    // Show loading state
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('results-state').style.display = 'none';
    document.getElementById('no-files-state').style.display = 'none';
    document.getElementById('error-state').style.display = 'none';
    
    // Use the old API endpoint temporarily
    fetch('/api/analyze_intake')
        .then(response => {
            console.log('API Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API Response data:', data);
            document.getElementById('loading-state').style.display = 'none';
            
            if (data.success) {
                if (data.analyses.length === 0) {
                    document.getElementById('no-files-state').style.display = 'block';
                } else {
                    document.getElementById('results-state').style.display = 'block';
                    populateResults(data);
                }
            } else {
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-message').textContent = data.error;
                // Set Start button to Retry since error-state is now visible
                resetStartButton();
            }
        })
        .catch(error => {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            document.getElementById('error-message').textContent = 'Network error: ' + error.message;
            // Set Start button to Retry on network error
            resetStartButton();
        });
}

function recheckForPDFs() {
    // Show loading state on re-check button
    const btn = document.getElementById('recheck-btn');
    const spinner = document.getElementById('recheck-spinner');
    const text = document.getElementById('recheck-text');
    
    btn.disabled = true;
    spinner.classList.remove('d-none');
    text.textContent = ' Checking...';
    
    // Start analysis (which will detect PDFs)
    setTimeout(() => {
        startAnalysis();
    }, 500); // Small delay to show loading state
}

function populateResults(data) {
    // Store analysis data globally for strategy override functionality
    window.analysisData = data;
    
    const resultsDiv = document.getElementById('analysis-results');
    
    // Create summary statistics
    const summaryHtml = `
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3>${data.single_count}</h3>
                        <p>Single Documents<br><small>Fast processing, direct to finalization</small></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h3>${data.batch_count}</h3>
                        <p>Batch Scans<br><small>Page-by-page verification workflow</small></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h3>${data.total_count}</h3>
                        <p>Total Files<br><small>Ready for processing</small></p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Create analysis table
    let tableHtml = `
        <div class="card">
            <div class="card-header">
                <h5>üìÑ File Analysis Details</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th style="width: 18%">Filename</th>
                                <th style="width: 7%">Size</th>
                                <th style="width: 7%">Pages</th>
                                <th style="width: 14%">Processing Strategy</th>
                                <th style="width: 11%">Confidence</th>
                                <th style="width: 15%">Strategy Override</th>
                                <th style="width: 28%">Analysis & Reasoning</th>
                                <th style="width: 10%">Preview</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    data.analyses.forEach(analysis => {
        const confidencePercent = Math.round(analysis.confidence * 100);
        const progressColor = confidencePercent >= 70 ? 'bg-success' : (confidencePercent >= 50 ? 'bg-warning' : 'bg-secondary');
        
        let strategyBadge = analysis.processing_strategy === 'single_document' 
            ? '<span class="badge badge-success">üöÄ Single Document</span><br><small class="text-muted">Direct processing</small>'
            : '<span class="badge badge-primary">üìã Batch Scan</span><br><small class="text-muted">Page verification</small>';
            
        let filenameHints = '';
        if (analysis.filename_hints === 'single') {
            filenameHints = '<span class="badge badge-success">üìÑ Document</span>';
        } else if (analysis.filename_hints === 'batch') {
            filenameHints = '<span class="badge badge-primary">üìö Batch</span>';
        }
        
        // Create reasoning box with proper formatting
        let reasoningHtml = `<div class="reasoning-box p-3 border rounded bg-light" style="max-width: 350px;">`;
        
        // Separate static analysis (heuristics) from LLM decision lines
        let staticAnalysis = [];
        let llmDecisionLines = [];
        
        analysis.reasoning.forEach(reason => {
            // LLM decision lines start with ü§ñ or contain "LLM" or "Final classification"
            if (reason.includes('ü§ñ') || reason.includes('LLM') || reason.includes('Final classification')) {
                llmDecisionLines.push(reason);
            } else {
                staticAnalysis.push(reason);
            }
        });
        
        // Create unique IDs for this analysis
        const filenameSafe = analysis.filename.replace(/[^a-zA-Z0-9]/g, '_');
        const staticAnalysisId = `static_${filenameSafe}`;
        const aiAnalysisId = `ai_${filenameSafe}`;
        
        // Determine static analysis verdict
        let staticVerdict = 'Unknown';
        let staticDetails = staticAnalysis.join('<br>‚Ä¢ ');
        
        // Extract verdict from LLM decision lines or fall back to processing strategy
        if (llmDecisionLines.length > 0) {
            // If there's LLM decision, the static analysis didn't have final say
            const classification = analysis.processing_strategy.replace('_', ' ');
            staticVerdict = `${classification} (heuristic analysis)`;
        } else {
            // No LLM, so static analysis made the final decision
            const classification = analysis.processing_strategy.replace('_', ' ');
            staticVerdict = `${classification} (${Math.round(analysis.confidence * 100)}% confidence)`;
        }
        
        // Add Static Analysis section
        reasoningHtml += `<div class="mb-2">`;
        reasoningHtml += `<strong>üìä Static Analysis:</strong><br>`;
        reasoningHtml += `<div style="margin: 4px 0;">`;
        reasoningHtml += `<span class="text-info font-weight-bold">${staticVerdict}</span>`;
        reasoningHtml += `<button class="btn btn-sm btn-outline-secondary ml-2" type="button" 
                                onclick="toggleLlmDetails('${staticAnalysisId}')" 
                                style="font-size: 0.7em; padding: 2px 8px;">
                            <span id="${staticAnalysisId}_toggle">üîΩ Details</span>
                        </button>`;
        reasoningHtml += `</div>`;
        reasoningHtml += `<div id="${staticAnalysisId}_details" style="display: none; margin: 4px 0; font-size: 0.9em; color: #666; 
                         max-height: 150px; overflow-y: auto; padding: 8px; background: #f8f9fa; border-radius: 4px;">`;
        reasoningHtml += `‚Ä¢ ${staticDetails}`;
        reasoningHtml += `</div>`;
        reasoningHtml += `</div>`;
        
        // Add AI Analysis section if LLM was used
        if (analysis.llm_analysis) {
            console.log('LLM Analysis for', analysis.filename, ':', analysis.llm_analysis);
            const llmClassification = analysis.llm_analysis.classification ? analysis.llm_analysis.classification.replace('_', ' ') : 'Unknown';
            const llmConfidence = analysis.llm_analysis.confidence || 0;
            const llmReasoning = analysis.llm_analysis.reasoning || 'No reasoning provided';
            
            reasoningHtml += `
                <div class="mt-2 pt-2 border-top">
                    <strong>ü§ñ AI Analysis:</strong><br>
                    <div style="margin: 4px 0;">
                        <span class="text-primary font-weight-bold">${llmClassification}</span> (${llmConfidence}% confidence)
                        <button class="btn btn-sm btn-outline-secondary ml-2" type="button" 
                                onclick="toggleLlmDetails('${aiAnalysisId}')" 
                                style="font-size: 0.7em; padding: 2px 8px;">
                            <span id="${aiAnalysisId}_toggle">üîΩ Details</span>
                        </button>
                    </div>
                    <div id="${aiAnalysisId}_details" style="display: none; margin: 4px 0; font-size: 0.9em; color: #666; 
                         max-height: 150px; overflow-y: auto; padding: 8px; background: #f8f9fa; border-radius: 4px;">
                        ${llmReasoning}
                        <div class="mt-2" style="border-top: 1px solid #ddd; padding-top: 8px;">
                            <strong>LLM Decision Process:</strong><br>
                            ‚Ä¢ ${llmDecisionLines.join('<br>‚Ä¢ ')}
                        </div>
                    </div>
                </div>
            `;
        } else {
            console.log('No LLM analysis for', analysis.filename);
        }
        
        reasoningHtml += `</div>`;
        
        tableHtml += `
            <tr style="vertical-align: top;">
                <td class="py-3">
                    <div><strong>${analysis.filename}</strong></div>
                    <div class="mt-1">${filenameHints}</div>
                </td>
                <td class="py-3">${analysis.file_size_mb.toFixed(1)} MB</td>
                <td class="py-3">${analysis.page_count}</td>
                <td class="py-3">${strategyBadge}</td>
                <td class="py-3">
                    <div class="progress mb-1" style="width: 100px; height: 8px;">
                        <div class="progress-bar ${progressColor}" style="width: ${confidencePercent}%"></div>
                    </div>
                    <small class="d-block">${confidencePercent}%</small>
                </td>
                <td class="py-3">
                    <div class="strategy-override-container" data-filename="${analysis.filename}">
                        <div class="mb-2">
                            ${analysis.llm_analysis ? 
                                `<strong>ü§ñ AI Suggested:</strong><br><span class="text-primary">${analysis.processing_strategy === 'single_document' ? 'üöÄ Single Document' : 'üìã Batch Scan'}</span>` :
                                `<strong>‚öôÔ∏è Static Fallback:</strong><br><span class="text-muted">${analysis.processing_strategy === 'single_document' ? 'üöÄ Single Document' : 'üìã Batch Scan'}</span><br><small class="text-warning">AI analysis failed</small>`
                            }
                        </div>
                        <div class="mb-2">
                            <label class="small text-muted">Override Strategy:</label>
                            <select class="form-control form-control-sm strategy-override-select" 
                                    data-filename="${analysis.filename}"
                                    data-original="${analysis.processing_strategy}">
                                <option value="use_suggested">‚úÖ Use Suggestion</option>
                                <option value="single_document">üöÄ Single Document</option>
                                <option value="batch_scan">üìã Batch Scan</option>
                            </select>
                        </div>
                        <div class="override-status text-muted small" style="display: none;">
                            <span class="override-indicator"></span>
                        </div>
                    </div>
                </td>
                <td class="py-3">${reasoningHtml}</td>
                <td class="py-3 text-center">
                    <button type="button" class="btn btn-sm btn-outline-primary view-pdf-btn" 
                            data-filename="${analysis.filename}" 
                            data-strategy="${analysis.processing_strategy}"
                            title="Preview PDF before processing">
                        üìÑ View
                    </button>
                </td>
            </tr>
        `;
    });
    
    tableHtml += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Add action buttons
    const buttonsHtml = `
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h5>üéØ Smart Processing</h5>
                        <p class="text-muted"><strong>Recommended:</strong> Use AI recommendations for optimal processing.</p>
                        <button type="button" class="btn btn-success btn-lg btn-block" 
                                onclick="processWithOverrides('smart')">üöÄ Smart Processing</button>
                        <small class="text-muted mt-2 d-block">Best balance of speed and safety</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h5>üèÉ‚Äç‚ôÇÔ∏è Speed Mode</h5>
                        <p class="text-muted">Process all files as single documents for maximum speed.</p>
                        <form action="{{ url_for('batch.process_batch_all_single') }}" method="post">
                            <button type="submit" class="btn btn-info btn-lg btn-block">‚ö° All as Single Documents</button>
                        </form>
                        <small class="text-muted mt-2 d-block">Fastest processing, skip verification</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h5>üõ°Ô∏è Safety Mode</h5>
                        <p class="text-muted">Process all files as batch scans for maximum control.</p>
                        <form action="{{ url_for('batch.process_batch_force_traditional') }}" method="post">
                            <button type="submit" class="btn btn-warning btn-lg btn-block">üìã All as Batch Scans</button>
                        </form>
                        <small class="text-muted mt-2 d-block">Traditional workflow with verification</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = summaryHtml + tableHtml + buttonsHtml;
    
    // Add event listeners to processing buttons
    const processingButtons = document.querySelectorAll('#analysis-results form button[type="submit"]');
    processingButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            // Clear cached results since user is starting processing
            sessionStorage.removeItem('intake_analysis_results');
            
            const buttonText = this.textContent.trim();
            if (buttonText.includes('Smart Processing')) {
                // Smart processing will redirect to its own progress page
                // Delay button disabling to allow form submission
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Starting Smart Processing...';
                setTimeout(() => {
                    disableAllProcessingButtons();
                }, 100); // Small delay to allow form submission
            } else {
                // Disable ALL processing buttons to prevent multiple simultaneous operations
                disableAllProcessingButtons();
                
                // Other modes show loading state on current page
                document.getElementById('loading-state').style.display = 'block';
                // Other modes show loading state on current page
                document.getElementById('loading-state').style.display = 'block';
                document.getElementById('results-state').style.display = 'none';
                
                // Update loading message for processing
                document.querySelector('#loading-state h4').textContent = '‚öôÔ∏è Processing Your Documents...';
                document.querySelector('#loading-state p').textContent = 'Please wait while we process your files using the selected strategy.';
                
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Processing...';
            }
        });
    });
    
    // Also disable Start Analysis button during processing
    const startAnalysisButtons = document.querySelectorAll('[onclick="startAnalysis()"]');
    startAnalysisButtons.forEach(btn => {
        const originalClick = btn.onclick;
        btn.onclick = function(e) {
            // Allow Smart Processing to always proceed (it has its own progress page)
            const buttonText = this.textContent.trim();
            if (buttonText.includes('Smart Processing')) {
                // Let the form submit normally for Smart Processing
                return true;
            }
            
            if (this.disabled || isProcessingActive()) {
                e.preventDefault();
                return false;
            }
            if (originalClick) {
                originalClick.call(this, e);
            }
        };
    });

    // Add PDF Viewer button handlers
    const viewPdfBtns = document.querySelectorAll('.view-pdf-btn');
    viewPdfBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const filename = this.getAttribute('data-filename');
            const strategy = this.getAttribute('data-strategy');
            if (filename && typeof openPdfViewer === 'function') {
                const pdfUrl = `/original_pdf/${encodeURIComponent(filename)}`;
                const strategyLabel = strategy === 'single_document' ? 'Single Document' : 'Batch Scan';
                const title = `${filename} (${strategyLabel} Strategy)`;
                openPdfViewer(pdfUrl, title);
            } else {
                alert('PDF viewer not available or file not found');
            }
        });
    });
    
    // Initialize strategy override functionality
    setupStrategyOverrides();
}

function disableAllProcessingButtons() {
    // Disable all processing buttons
    const allProcessingButtons = document.querySelectorAll('#analysis-results form button[type="submit"], [onclick="startAnalysis()"]');
    allProcessingButtons.forEach(btn => {
        btn.disabled = true;
        if (!btn.innerHTML.includes('spinner-border')) {
            btn.classList.add('btn-secondary');
            btn.classList.remove('btn-primary', 'btn-success', 'btn-info', 'btn-warning');
        }
    });
}

function enableAllProcessingButtons() {
    // Re-enable all processing buttons (in case of errors)
    const allProcessingButtons = document.querySelectorAll('#analysis-results form button[type="submit"], [onclick="startAnalysis()"]');
    allProcessingButtons.forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('btn-secondary');
        // Restore original button classes based on context
        if (btn.innerHTML.includes('Smart Processing')) {
            btn.classList.add('btn-success');
        } else if (btn.innerHTML.includes('Speed Mode')) {
            btn.classList.add('btn-info');
        } else if (btn.innerHTML.includes('Safety Mode')) {
            btn.classList.add('btn-warning');
        } else {
            btn.classList.add('btn-primary');
        }
    });
}

function isProcessingActive() {
    // Check if any processing is currently active
    const processingButtons = document.querySelectorAll('#analysis-results form button[type="submit"]');
    return Array.from(processingButtons).some(btn => 
        btn.disabled && btn.innerHTML.includes('spinner-border')
    );
}

function toggleLlmDetails(analysisId) {
    const detailsDiv = document.getElementById(analysisId + '_details');
    const toggleSpan = document.getElementById(analysisId + '_toggle');
    
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        toggleSpan.textContent = 'üîº Hide';
    } else {
        detailsDiv.style.display = 'none';
        toggleSpan.textContent = 'üîΩ Details';
    }
}

// Strategy Override Functionality
function setupStrategyOverrides() {
    // Initialize all strategy override dropdowns
    document.querySelectorAll('.strategy-override-select').forEach(select => {
        const filename = select.getAttribute('data-filename');
        const originalStrategy = select.getAttribute('data-original');
        const statusDiv = select.closest('.strategy-override-container').querySelector('.override-status');
        const indicator = statusDiv.querySelector('.override-indicator');
        
        // Check if this document has actual AI analysis or is using static fallback
        const hasAiAnalysis = window.analysisData && window.analysisData.analyses ? 
            window.analysisData.analyses.find(a => a.filename === filename)?.llm_analysis : false;
        
        // Set up change handler
        select.addEventListener('change', function() {
            const selectedValue = this.value;
            
            if (selectedValue === 'use_suggested') {
                // Using original suggestion (AI or static fallback)
                statusDiv.style.display = 'none';
                indicator.innerHTML = '';
            } else {
                // Manual override
                statusDiv.style.display = 'block';
                const overrideText = selectedValue === 'single_document' ? 'üöÄ Single Document' : 'üìã Batch Scan';
                const originalText = originalStrategy === 'single_document' ? 'üöÄ Single Document' : 'üìã Batch Scan';
                
                if (selectedValue === originalStrategy) {
                    if (hasAiAnalysis) {
                        indicator.innerHTML = `üîÑ Override: ${overrideText} <span class="text-success">(matches AI)</span>`;
                    } else {
                        indicator.innerHTML = `üîÑ Override: ${overrideText} <span class="text-info">(matches static fallback)</span>`;
                    }
                } else {
                    if (hasAiAnalysis) {
                        indicator.innerHTML = `üîÑ Override: ${overrideText} <span class="text-warning">(overriding AI)</span>`;
                    } else {
                        indicator.innerHTML = `üîÑ Override: ${overrideText} <span class="text-primary">(overriding static fallback)</span>`;
                    }
                }
            }
        });
    });
}

// Get current strategy overrides for processing
function getStrategyOverrides() {
    const overrides = {};
    document.querySelectorAll('.strategy-override-select').forEach(select => {
        const filename = select.getAttribute('data-filename');
        const selectedValue = select.value;
        const originalStrategy = select.getAttribute('data-original');
        
        if (selectedValue === 'use_suggested') {
            // No override, use original AI suggestion
            overrides[filename] = originalStrategy;
        } else {
            // Manual override
            overrides[filename] = selectedValue;
        }
    });
    return overrides;
}

// Enhanced Smart Processing with overrides
function processWithOverrides(processingMode) {
    const overrides = getStrategyOverrides();
    
    // Create a form with the overrides data
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/process_batch_${processingMode}`;
    
    // Add overrides as hidden inputs
    const overrideInput = document.createElement('input');
    overrideInput.type = 'hidden';
    overrideInput.name = 'strategy_overrides';
    overrideInput.value = JSON.stringify(overrides);
    form.appendChild(overrideInput);
    
    // Submit the form
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}