<!-- Intake Analysis Preview Template -->
{% extends 'base.html' %}

{% block title %}Intake Analysis{% endblock %}

{% block content %}
<div class="container">
    <h1>üìã Document Processing Strategy Analysis</h1>
    
    <!-- Loading State -->
    <div id="loading-state" class="alert alert-primary text-center" style="display: none;">
        <div class="spinner-border text-primary mb-3" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <h4>ü§ñ Analyzing Your Documents...</h4>
        <p class="mb-0">Please wait while we examine your intake files and determine optimal processing strategies.</p>
        <small class="text-muted">This may take a few moments for large files or when consulting the AI...</small>
    </div>
    
    <!-- Results State -->
    <div id="results-state" style="display: none;">
        <div class="alert alert-info">
            <strong>Smart Processing:</strong> The system has analyzed your intake files and suggests the optimal processing strategy for each document. Review the recommendations below before proceeding.
        </div>

        <!-- Results will be populated here by JavaScript -->
        <div id="analysis-results"></div>
    </div>
    
    <!-- No Files State -->
    <div id="no-files-state" style="display: none;">
        <div class="alert alert-warning text-center">
            <h4>üìÅ No PDF Files Found</h4>
            <p>No PDF files were found in the intake directory.</p>
            <p><code>{{ intake_dir }}</code></p>
            <p>Please add some PDF files and try again.</p>
            <a href="{{ url_for('mission_control_page') }}" class="btn btn-secondary">‚Üê Back to Batch Control</a>
        </div>
    </div>
    
    <!-- Error State -->
    <div id="error-state" style="display: none;">
        <div class="alert alert-danger">
            <h4>‚ùå Analysis Error</h4>
            <p>An error occurred while analyzing your documents:</p>
            <p id="error-message"></p>
            <button onclick="startAnalysis()" class="btn btn-primary">üîÑ Retry Analysis</button>
            <a href="{{ url_for('mission_control_page') }}" class="btn btn-secondary ml-2">‚Üê Back to Batch Control</a>
        </div>
    </div>

    {% if False %} <!-- Hide the static template content -->
    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h3>{{ single_count }}</h3>
                    <p>Single Documents<br><small>Fast processing, direct to finalization</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h3>{{ batch_count }}</h3>
                    <p>Batch Scans<br><small>Page-by-page verification workflow</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h3>{{ total_count }}</h3>
                    <p>Total Files<br><small>Ready for processing</small></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analysis Table -->
    <div class="card">
        <div class="card-header">
            <h5>üìÑ File Analysis Details</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Filename</th>
                            <th>Size</th>
                            <th>Pages</th>
                            <th>Processing Strategy</th>
                            <th>Confidence</th>
                            <th>Reasoning</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for analysis in analyses %}
                        <tr>
                            <td>
                                <strong>{{ analysis.filename }}</strong>
                                {% if analysis.filename_hints == "single" %}
                                <span class="badge badge-success">üìÑ Document</span>
                                {% elif analysis.filename_hints == "batch" %}
                                <span class="badge badge-primary">üìö Batch</span>
                                {% endif %}
                            </td>
                            <td>{{ "%.1f"|format(analysis.file_size_mb) }} MB</td>
                            <td>{{ analysis.page_count }}</td>
                            <td>
                                {% if analysis.processing_strategy == "single_document" %}
                                <span class="badge badge-success">üöÄ Single Document</span>
                                <br><small class="text-muted">Direct processing</small>
                                {% else %}
                                <span class="badge badge-primary">üìã Batch Scan</span>
                                <br><small class="text-muted">Page verification</small>
                                {% endif %}
                            </td>
                            <td>
                                <div class="progress" style="width: 80px;">
                                    {% set confidence_percent = (analysis.confidence * 100)|int %}
                                    <div class="progress-bar 
                                        {% if confidence_percent >= 70 %}bg-success
                                        {% elif confidence_percent >= 50 %}bg-warning
                                        {% else %}bg-secondary{% endif %}" 
                                        style="width: {{ confidence_percent }}%">
                                    </div>
                                </div>
                                <small>{{ "%.0f"|format(analysis.confidence * 100) }}%</small>
                            </td>
                            <td>
                                <ul class="list-unstyled mb-0" style="font-size: 0.85em;">
                                    {% for reason in analysis.reasoning[:3] %}
                                    <li>‚Ä¢ {{ reason }}</li>
                                    {% endfor %}
                                    {% if analysis.reasoning|length > 3 %}
                                    <li><small class="text-muted">... and {{ analysis.reasoning|length - 3 }} more</small></li>
                                    {% endif %}
                                </ul>
                                {% if analysis.llm_analysis %}
                                <div class="mt-2 p-2 bg-light rounded" style="font-size: 0.8em;">
                                    <strong>ü§ñ LLM Analysis:</strong>
                                    <br><span class="text-primary">{{ analysis.llm_analysis.classification|title }}</span> 
                                    ({{ analysis.llm_analysis.confidence }}% confidence)
                                    <br><small class="text-muted">{{ analysis.llm_analysis.reasoning[:80] }}{% if analysis.llm_analysis.reasoning|length > 80 %}...{% endif %}</small>
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Content Samples (if available) -->
    {% set sample_analyses = analyses[:3] %}
    {% if sample_analyses %}
    <div class="card mt-4">
        <div class="card-header">
            <h5>üìù Content Samples</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for analysis in sample_analyses %}
                {% if analysis.content_sample %}
                <div class="col-md-4 mb-3">
                    <div class="card border-secondary">
                        <div class="card-header bg-light">
                            <small><strong>{{ analysis.filename }}</strong></small>
                        </div>
                        <div class="card-body" style="max-height: 150px; overflow-y: auto;">
                            <small class="text-monospace">{{ analysis.content_sample }}</small>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h5>üéØ Smart Processing</h5>
                    <p class="text-muted"><strong>Recommended:</strong> Use AI recommendations for optimal processing.</p>
                    <form action="{{ url_for('process_batch_smart') }}" method="post">
                        <button type="submit" class="btn btn-success btn-lg btn-block">
                            üöÄ Smart Processing
                        </button>
                    </form>
                    <small class="text-muted mt-2 d-block">Best balance of speed and safety</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h5>üèÉ‚Äç‚ôÇÔ∏è Speed Mode</h5>
                    <p class="text-muted">Process all files as single documents for maximum speed.</p>
                    <form action="{{ url_for('process_batch_all_single') }}" method="post">
                        <button type="submit" class="btn btn-info btn-lg btn-block">
                            ‚ö° All as Single Documents
                        </button>
                    </form>
                    <small class="text-muted mt-2 d-block">Fastest processing, skip verification</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h5>ÔøΩÔ∏è Safety Mode</h5>
                    <p class="text-muted">Process all files as batch scans for maximum control.</p>
                    <form action="{{ url_for('process_batch_force_traditional') }}" method="post">
                        <button type="submit" class="btn btn-warning btn-lg btn-block">
                            üìã All as Batch Scans
                        </button>
                    </form>
                    <small class="text-muted mt-2 d-block">Traditional workflow with verification</small>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Files Found -->
    <div class="alert alert-warning text-center">
        <h4>üìÅ No PDF Files Found</h4>
        <p>No PDF files were found in the intake directory.</p>
        <p><code>{{ intake_dir }}</code></p>
        <p>Please add some PDF files and try again.</p>
        <a href="{{ url_for('mission_control_page') }}" class="btn btn-secondary">‚Üê Back to Batch Control</a>
    </div>
    {% endif %}

    <!-- Help Section -->
    <div class="card mt-4 border-info">
        <div class="card-header bg-info text-white">
            <h5>üí° Processing Strategy Guide</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6>üéØ Smart Processing</h6>
                    <ul>
                        <li><strong>Uses AI recommendations</strong></li>
                        <li><strong>Best balance</strong> of speed and safety</li>
                        <li><strong>Single docs:</strong> Fast track (~30s each)</li>
                        <li><strong>Batch scans:</strong> Full verification</li>
                        <li><strong>Recommended</strong> for most users</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6>‚ö° All as Single Documents</h6>
                    <ul>
                        <li><strong>Speed mode:</strong> Fastest processing</li>
                        <li><strong>All files:</strong> Direct to export</li>
                        <li><strong>Time:</strong> ~30 seconds per document</li>
                        <li><strong>Best for:</strong> Trusted individual files</li>
                        <li><strong>Risk:</strong> No verification step</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6>ÔøΩÔ∏è All as Batch Scans</h6>
                    <ul>
                        <li><strong>Safety mode:</strong> Maximum control</li>
                        <li><strong>All files:</strong> Full verification workflow</li>
                        <li><strong>Time:</strong> ~2-5 minutes per document</li>
                        <li><strong>Best for:</strong> Unknown or complex files</li>
                        <li><strong>Benefit:</strong> Human verification of everything</li>
                    </ul>
                </div>
            </div>
            <div class="alert alert-success mt-3">
                <strong>üéØ For 278 PDFs:</strong> Smart Processing is recommended - it will automatically fast-track obvious single documents while ensuring complex files get proper human verification. This typically saves 50-70% processing time.
            </div>
        </div>
    </div>
    </div> <!-- Close results-state -->
</div>

<style>
.progress {
    height: 10px;
}
.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.badge {
    font-size: 0.75em;
}
.spinner-border {
    width: 3rem;
    height: 3rem;
}
</style>

<script>
// Start analysis automatically when page loads
document.addEventListener('DOMContentLoaded', function() {
    startAnalysis();
});

function startAnalysis() {
    // Show loading state
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('results-state').style.display = 'none';
    document.getElementById('no-files-state').style.display = 'none';
    document.getElementById('error-state').style.display = 'none';
    
    // Fetch analysis results
    fetch('/api/analyze_intake')
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading-state').style.display = 'none';
            
            if (data.success) {
                if (data.analyses.length === 0) {
                    document.getElementById('no-files-state').style.display = 'block';
                } else {
                    document.getElementById('results-state').style.display = 'block';
                    populateResults(data);
                }
            } else {
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-message').textContent = data.error;
            }
        })
        .catch(error => {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            document.getElementById('error-message').textContent = 'Network error: ' + error.message;
        });
}

function populateResults(data) {
    const resultsDiv = document.getElementById('analysis-results');
    
    // Create summary statistics
    const summaryHtml = `
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h3>${data.single_count}</h3>
                        <p>Single Documents<br><small>Fast processing, direct to finalization</small></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h3>${data.batch_count}</h3>
                        <p>Batch Scans<br><small>Page-by-page verification workflow</small></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h3>${data.total_count}</h3>
                        <p>Total Files<br><small>Ready for processing</small></p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Create analysis table
    let tableHtml = `
        <div class="card">
            <div class="card-header">
                <h5>üìÑ File Analysis Details</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Size</th>
                                <th>Pages</th>
                                <th>Processing Strategy</th>
                                <th>Confidence</th>
                                <th>Reasoning</th>
                            </tr>
                        </thead>
                        <tbody>
    `;
    
    data.analyses.forEach(analysis => {
        const confidencePercent = Math.round(analysis.confidence * 100);
        const progressColor = confidencePercent >= 70 ? 'bg-success' : (confidencePercent >= 50 ? 'bg-warning' : 'bg-secondary');
        
        let strategyBadge = analysis.processing_strategy === 'single_document' 
            ? '<span class="badge badge-success">üöÄ Single Document</span><br><small class="text-muted">Direct processing</small>'
            : '<span class="badge badge-primary">üìã Batch Scan</span><br><small class="text-muted">Page verification</small>';
            
        let filenameHints = '';
        if (analysis.filename_hints === 'single') {
            filenameHints = '<span class="badge badge-success">üìÑ Document</span>';
        } else if (analysis.filename_hints === 'batch') {
            filenameHints = '<span class="badge badge-primary">üìö Batch</span>';
        }
        
        let reasoningHtml = '<ul class="list-unstyled mb-0" style="font-size: 0.85em;">';
        analysis.reasoning.slice(0, 3).forEach(reason => {
            reasoningHtml += `<li>‚Ä¢ ${reason}</li>`;
        });
        if (analysis.reasoning.length > 3) {
            reasoningHtml += `<li><small class="text-muted">... and ${analysis.reasoning.length - 3} more</small></li>`;
        }
        reasoningHtml += '</ul>';
        
        // Add LLM analysis if available
        if (analysis.llm_analysis) {
            reasoningHtml += `
                <div class="mt-2 p-2 bg-light rounded" style="font-size: 0.8em;">
                    <strong>ü§ñ LLM Analysis:</strong>
                    <br><span class="text-primary">${analysis.llm_analysis.classification.replace('_', ' ')}</span> 
                    (${analysis.llm_analysis.confidence}% confidence)
                    <br><small class="text-muted">${analysis.llm_analysis.reasoning.substring(0, 80)}${analysis.llm_analysis.reasoning.length > 80 ? '...' : ''}</small>
                </div>
            `;
        }
        
        tableHtml += `
            <tr>
                <td>
                    <strong>${analysis.filename}</strong>
                    ${filenameHints}
                </td>
                <td>${analysis.file_size_mb.toFixed(1)} MB</td>
                <td>${analysis.page_count}</td>
                <td>${strategyBadge}</td>
                <td>
                    <div class="progress" style="width: 80px;">
                        <div class="progress-bar ${progressColor}" style="width: ${confidencePercent}%"></div>
                    </div>
                    <small>${confidencePercent}%</small>
                </td>
                <td>${reasoningHtml}</td>
            </tr>
        `;
    });
    
    tableHtml += `
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Add action buttons
    const buttonsHtml = `
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-body text-center">
                        <h5>üéØ Smart Processing</h5>
                        <p class="text-muted"><strong>Recommended:</strong> Use AI recommendations for optimal processing.</p>
                        <form action="/process_batch_smart" method="post">
                            <button type="submit" class="btn btn-success btn-lg btn-block">üöÄ Smart Processing</button>
                        </form>
                        <small class="text-muted mt-2 d-block">Best balance of speed and safety</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-info">
                    <div class="card-body text-center">
                        <h5>üèÉ‚Äç‚ôÇÔ∏è Speed Mode</h5>
                        <p class="text-muted">Process all files as single documents for maximum speed.</p>
                        <form action="/process_batch_all_single" method="post">
                            <button type="submit" class="btn btn-info btn-lg btn-block">‚ö° All as Single Documents</button>
                        </form>
                        <small class="text-muted mt-2 d-block">Fastest processing, skip verification</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card border-warning">
                    <div class="card-body text-center">
                        <h5>üõ°Ô∏è Safety Mode</h5>
                        <p class="text-muted">Process all files as batch scans for maximum control.</p>
                        <form action="/process_batch_force_traditional" method="post">
                            <button type="submit" class="btn btn-warning btn-lg btn-block">üìã All as Batch Scans</button>
                        </form>
                        <small class="text-muted mt-2 d-block">Traditional workflow with verification</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.innerHTML = summaryHtml + tableHtml + buttonsHtml;
    
    // Add event listeners to processing buttons
    const processingButtons = document.querySelectorAll('#analysis-results form button[type="submit"]');
    processingButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            // Show loading state
            document.getElementById('loading-state').style.display = 'block';
            document.getElementById('results-state').style.display = 'none';
            
            // Update loading message for processing
            document.querySelector('#loading-state h4').textContent = '‚öôÔ∏è Processing Your Documents...';
            document.querySelector('#loading-state p').textContent = 'Please wait while we process your files using the selected strategy.';
            
            // Disable the button to prevent double-clicks
            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Processing...';
        });
    });
}
</script>
{% endblock %}