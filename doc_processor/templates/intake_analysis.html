{% extends 'base.html' %}

{% block title %}Intake Analysis - Document Processing{% endblock %}

{% block content %}
<!-- Include PDF Modal Viewer Component -->
{% include 'components/pdf_modal.html' %}

<style>
/* Enhanced layout combining manipulate.html structure with intake analysis data */
.main-container {
    padding: 20px;
}

.document-section {
    display: flex;
    gap: 20px;
    margin-bottom: 40px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f8f9fa;
}

.document-viewer-pane {
    flex: 1;
    min-width: 400px;
    position: sticky;
    top: 20px;
    height: fit-content;
}

        .universal-viewer {
            width: 100%;
            height: 80vh;
            border: 2px solid #007BFF;
            background-color: #f8f9fa;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 8px;
            position: relative;
        }
        
        .universal-viewer iframe {
            border: none;
            transform-origin: center center;
            transition: transform 0.3s ease;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

.viewer-placeholder {
    text-align: center;
    color: #6c757d;
    padding: 40px;
}

.viewer-controls {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
}

.viewer-controls button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    background-color: #6c757d;
    color: white;
    cursor: pointer;
    font-size: 0.9em;
}

.viewer-controls button:hover {
    background-color: #5a6268;
}

.viewer-controls button.active {
    background-color: #007BFF;
}

.rotation-info {
    margin-top: 10px;
    padding: 8px 12px;
    background-color: #e3f2fd;
    border-radius: 4px;
    font-size: 0.9em;
    text-align: center;
}

.document-info-pane {
    flex: 1;
    min-width: 400px;
}

.info-card {
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
}

.info-card-header {
    background-color: #f8f9fa;
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.info-card-body {
    padding: 20px;
}

.info-grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 10px 20px;
    margin-bottom: 15px;
}

.info-label {
    font-weight: bold;
    color: #495057;
}

.info-value {
    color: #212529;
}

.confidence-bar {
    display: flex;
    align-items: center;
    gap: 10px;
}

.progress-bar-container {
    flex: 1;
    height: 8px;
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    transition: width 0.3s ease;
}

.reasoning-list {
    max-height: 150px;
    overflow-y: auto;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 15px;
}

.reasoning-list ul {
    margin: 0;
    padding: 0;
    list-style-type: disc;
    padding-left: 20px;
}

.reasoning-list li {
    margin-bottom: 8px;
    font-size: 0.9em;
}

.strategy-section {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.strategy-badge {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
}

.strategy-single {
    background-color: #d4edda;
    color: #155724;
}

.strategy-batch {
    background-color: #cce5ff;
    color: #004085;
}

.override-controls {
    display: flex;
    gap: 8px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 0.8em;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: white;
    cursor: pointer;
}

.btn-sm:hover {
    background-color: #f8f9fa;
}

.btn-sm.active {
    background-color: #007BFF;
    color: white;
    border-color: #007BFF;
}

.llm-analysis-box {
    background-color: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 4px;
    padding: 15px;
    margin-top: 15px;
}

.content-sample {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    max-height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.batch-controls {
    position: sticky;
    bottom: 0;
    background-color: white;
    border-top: 2px solid #007BFF;
    padding: 20px;
    margin-top: 40px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.batch-controls-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
}

.batch-summary {
    font-size: 1.1em;
}

.batch-actions {
    display: flex;
    gap: 15px;
}

.btn-primary {
    background-color: #007BFF;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
}

.btn-success {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
}

@media (max-width: 1024px) {
    .document-section {
        flex-direction: column;
    }
    
    .document-viewer-pane {
        position: static;
    }
    
    .universal-viewer {
        height: 80vh;
    }
}

/* Status Notifications */
.status-notifications {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    max-width: 400px;
}

.status-notification {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 12px 16px;
    margin-bottom: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
}

.status-notification.show {
    opacity: 1;
    transform: translateX(0);
}

.status-notification.success {
    border-left: 4px solid #28a745;
    background-color: #f8fff9;
}

.status-notification.error {
    border-left: 4px solid #dc3545;
    background-color: #fff8f8;
}

.status-notification.info {
    border-left: 4px solid #17a2b8;
    background-color: #f8fdff;
}

.status-notification .status-title {
    font-weight: bold;
    margin-bottom: 4px;
}

.status-notification .status-details {
    font-size: 0.9em;
    color: #666;
    word-wrap: break-word;
}
</style>

<div class="main-container">
    <h1>üìÑ Document Analysis & Processing</h1>
    
    <!-- Status Notification Area -->
    <div id="status-notifications" class="status-notifications"></div>
    
    <!-- Analysis State Display -->
    <div id="analysis-state" class="mb-4">
        {% if not analyses %}
        <!-- No Analysis Results State -->
        <div class="card">
            <div class="card-body text-center">
                <h4>üìÅ No Documents Analyzed Yet</h4>
                <p>Click the button below to analyze documents in the intake directory.</p>
                <button onclick="startAnalysis()" class="btn btn-primary btn-lg">
                    üöÄ Start Analysis
                </button>
            </div>
        </div>
        {% else %}
        <!-- Analysis Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>üìä Analysis Summary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Total Documents:</strong> {{ analyses|length }}
                    </div>
                    <div class="col-md-3">
                        <strong>Single Document:</strong> {{ analyses|selectattr("processing_strategy", "equalto", "single_document")|list|length }}
                    </div>
                    <div class="col-md-3">
                        <strong>Batch Scan:</strong> {{ analyses|selectattr("processing_strategy", "equalto", "batch_scan")|list|length }}
                    </div>
                    <div class="col-md-3">
                        <strong>Avg Confidence:</strong> {{ "%.1f%%"|format((analyses|map(attribute='confidence')|sum / analyses|length) * 100) }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Document List -->
        {% for analysis in analyses %}
        <div class="document-section" data-filename="{{ analysis.filename }}">
            <!-- Left Pane: Document Viewer -->
            <div class="document-viewer-pane">
                <div class="universal-viewer" id="viewer-{{ loop.index }}">
                    <!-- Now always use PDF iframe since images are converted during analysis -->
                    <iframe src="{{ url_for('export.serve_original_pdf', filename=analysis.filename) }}" 
                            width="100%" height="100%" 
                            style="border: none; transform: rotate({{ analysis.detected_rotation or 0 }}deg);"
                            data-filename="{{ analysis.filename }}"
                            data-rotation="{{ analysis.detected_rotation or 0 }}">
                        <div class="viewer-placeholder">
                            <h4>üìÑ {{ analysis.filename }}</h4>
                            <p>PDF viewer not supported.<br>
                            <a href="{{ url_for('export.serve_original_pdf', filename=analysis.filename) }}" target="_blank">Open in new tab</a></p>
                        </div>
                    </iframe>
                </div>
                
                <div class="viewer-controls">
                    <button onclick="rotateDocument('{{ analysis.filename }}', 90)">
                        ‚Üª Rotate Right
                    </button>
                    <button onclick="rotateDocument('{{ analysis.filename }}', -90)">
                        ‚Ü∫ Rotate Left
                    </button>
                    <button onclick="resetRotation('{{ analysis.filename }}')">
                        üîÑ Reset
                    </button>
                </div>
                
                <div class="rotation-info">
                    <div><strong>Original:</strong> <span class="original-rotation">{{ analysis.detected_rotation or 0 }}¬∞ detected</span></div>
                    <div><strong>Current:</strong> <span class="current-rotation text-info">{{ analysis.detected_rotation or 0 }}¬∞</span></div>
                </div>
            </div>

            <!-- Right Pane: Document Information -->
            <div class="document-info-pane">
                <!-- Basic File Information -->
                <div class="info-card">
                    <div class="info-card-header">
                        <h6>üìã File Information</h6>
                        <span class="badge badge-info">{{ analysis.filename.split('.')[-1].upper() }}</span>
                    </div>
                    <div class="info-card-body">
                        <div class="info-grid">
                            <span class="info-label">Filename:</span>
                            <span class="info-value">{{ analysis.filename }}</span>
                            
                            <span class="info-label">File Size:</span>
                            <span class="info-value">{{ "%.1f"|format(analysis.file_size_mb) }} MB</span>
                            
                            <span class="info-label">Pages:</span>
                            <span class="info-value">{{ analysis.page_count }}</span>
                            
                            <span class="info-label">Hints:</span>
                            <span class="info-value">
                                {% if analysis.filename_hints == "single" %}
                                    <span class="badge badge-success">Single Document</span>
                                {% elif analysis.filename_hints == "batch" %}
                                    <span class="badge badge-warning">Batch Document</span>
                                {% else %}
                                    <span class="badge badge-secondary">Unknown</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Processing Strategy -->
                <div class="info-card">
                    <div class="info-card-header">
                        <h6>‚öôÔ∏è Processing Strategy</h6>
                        <div class="override-controls">
                            <button class="btn-sm {{ 'active' if analysis.processing_strategy == 'single_document' else '' }}" 
                                    onclick="setStrategy('{{ analysis.filename }}', 'single_document')">
                                üöÄ Single
                            </button>
                            <button class="btn-sm {{ 'active' if analysis.processing_strategy == 'batch_scan' else '' }}" 
                                    onclick="setStrategy('{{ analysis.filename }}', 'batch_scan')">
                                üìã Batch
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        <div class="strategy-section">
                            {% if analysis.processing_strategy == "single_document" %}
                                <span class="strategy-badge strategy-single">üöÄ Single Document Processing</span>
                                <small class="text-muted">Direct processing - file will be processed as individual document</small>
                            {% else %}
                                <span class="strategy-badge strategy-batch">üìã Batch Scan Processing</span>
                                <small class="text-muted">Page verification - each page will be reviewed individually</small>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Analysis Confidence -->
                <div class="info-card">
                    <div class="info-card-header">
                        <h6>üìä Analysis Confidence</h6>
                        <button class="btn-sm" onclick="rescanOCR('{{ analysis.filename }}')">
                            üîç Rescan OCR
                        </button>
                    </div>
                    <div class="info-card-body">
                        {% set confidence_percent = (analysis.confidence * 100)|int %}
                        <div class="confidence-bar">
                            <div class="progress-bar-container">
                                <div class="progress-bar 
                                    {% if confidence_percent >= 70 %}bg-success
                                    {% elif confidence_percent >= 50 %}bg-warning
                                    {% else %}bg-danger{% endif %}" 
                                    style="width: {{ confidence_percent }}%">
                                </div>
                            </div>
                            <strong>{{ confidence_percent }}%</strong>
                        </div>
                        
                        <div class="reasoning-list">
                            <strong>Reasoning:</strong>
                            <ul>
                                {% for reason in analysis.reasoning[:5] %}
                                <li>{{ reason }}</li>
                                {% endfor %}
                                {% if analysis.reasoning|length > 5 %}
                                <li><em>... and {{ analysis.reasoning|length - 5 }} more reasons</em></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- LLM Analysis -->
                {% if analysis.llm_analysis %}
                <div class="info-card">
                    <div class="info-card-header">
                        <h6>ü§ñ AI Analysis</h6>
                        <button class="btn-sm" onclick="reanalyzeLLM('{{ analysis.filename }}')">
                            ü§ñ Re-analyze
                        </button>
                    </div>
                    <div class="info-card-body">
                        <div class="llm-analysis-box">
                            <div class="info-grid">
                                <span class="info-label">Classification:</span>
                                <span class="info-value text-primary">{{ analysis.llm_analysis.classification|title }}</span>
                                
                                <span class="info-label">Confidence:</span>
                                <span class="info-value">{{ analysis.llm_analysis.confidence }}%</span>
                                
                                <span class="info-label">Reasoning:</span>
                                <span class="info-value">{{ analysis.llm_analysis.reasoning }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Content Sample -->
                {% if analysis.content_sample %}
                <div class="info-card">
                    <div class="info-card-header">
                        <h6>üìÑ Content Sample</h6>
                    </div>
                    <div class="info-card-body">
                        <div class="content-sample">{{ analysis.content_sample }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>

<!-- Loading State (hidden by default) -->
<div id="loading-state" class="alert alert-primary text-center" style="display: none;">
    <div class="spinner-border text-primary mb-3" role="status">
    </div>
    <h4>ü§ñ Analyzing Your Documents...</h4>
    <p class="mb-3">Please wait while we examine your intake files and determine optimal processing strategies.</p>
    
    <!-- Progress Bar -->
    <div class="progress mb-3" style="height: 30px; max-width: 500px; margin: 0 auto;">
        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
             role="progressbar" 
             style="width: 0%; white-space: nowrap; font-weight: 500; font-size: 14px; line-height: 30px;"
             aria-valuenow="0" 
             aria-valuemin="0" 
             aria-valuemax="100">
            0 of 0 PDFs
        </div>
    </div>
    
    <small class="text-muted">This may take a few moments for large files or when consulting the AI...</small>
</div>

<!-- Error State (hidden by default) -->
<div id="error-state" class="alert alert-danger text-center" style="display: none;">
    <h4>‚ùå Analysis Failed</h4>
    <p id="error-message">An error occurred during analysis.</p>
    <button onclick="startAnalysis()" class="btn btn-primary">
        üîÑ Retry Analysis
    </button>
</div>

<!-- Batch Processing Controls -->
{% if analyses %}
<div class="batch-controls">
    <div class="batch-controls-content">
        <div class="batch-summary">
            <strong>{{ analyses|length }} documents ready for processing</strong>
        </div>
        <div class="batch-actions">
            <button onclick="startBatchProcessing('smart')" class="btn-success">
                üöÄ Start Smart Processing
            </button>
            <button onclick="refreshAnalysis()" class="btn-secondary">
                üîÑ Refresh Analysis
            </button>
        </div>
    </div>
</div>
{% endif %}

<script>
// Status notification system
function showStatusNotification(type, title, details) {
    const container = document.getElementById('status-notifications');
    const notification = document.createElement('div');
    notification.className = `status-notification ${type}`;
    notification.innerHTML = `
        <div class="status-title">${title}</div>
        <div class="status-details">${details}</div>
    `;
    
    container.appendChild(notification);
    
    // Trigger animation
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    // Auto-remove after 5 seconds (or 8 for errors)
    const timeout = type === 'error' ? 8000 : 5000;
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, timeout);
    
    // Log to console as well
    console.log(`${type.toUpperCase()}: ${title} - ${details}`);
}

function showSuccess(title, details) {
    showStatusNotification('success', title, details);
}

function showError(title, details) {
    showStatusNotification('error', title, details);
}

function showInfo(title, details) {
    showStatusNotification('info', title, details);
}

// Document rotation tracking
window.documentRotations = {};
window.originalRotations = {};

// Initialize rotation data
{% if analyses %}
{% for analysis in analyses %}
window.originalRotations['{{ analysis.filename }}'] = {{ analysis.detected_rotation or 0 }};
window.documentRotations['{{ analysis.filename }}'] = {{ analysis.detected_rotation or 0 }};
{% endfor %}
{% endif %}

// Rotation functions
function rotateDocument(filename, degrees) {
    const currentRotation = window.documentRotations[filename] || 0;
    const newRotation = (currentRotation + degrees + 360) % 360;
    
    window.documentRotations[filename] = newRotation;
    
    // Save rotation to server
    saveRotation(filename, newRotation);
    
    // Update display
    updateRotationDisplay(filename);
    
    // Update rotation for both iframe (PDF) and img (images)
    const iframe = document.querySelector(`iframe[data-filename="${filename}"]`);
    const img = document.querySelector(`img[data-filename="${filename}"]`);
    
    if (iframe) {
        // For PDFs, apply rotation and adjust size with better scaling
        const isLandscape = (newRotation % 180 === 90);
        iframe.style.transform = `rotate(${newRotation}deg) scale(${isLandscape ? 0.7 : 1})`;
        iframe.setAttribute('data-rotation', newRotation);
    }
    if (img) {
        // For images, apply rotation and adjust size
        const isLandscape = (newRotation % 180 === 90);
        img.style.transform = `rotate(${newRotation}deg) scale(${isLandscape ? 0.7 : 1})`;
        img.setAttribute('data-rotation', newRotation);
    }
    
    console.log(`Rotated ${filename} by ${degrees}¬∞ to ${newRotation}¬∞`);
}

function resetRotation(filename) {
    const originalRotation = window.originalRotations[filename] || 0;
    window.documentRotations[filename] = originalRotation;
    
    // Save reset rotation to server
    saveRotation(filename, originalRotation);
    
    // Update display
    updateRotationDisplay(filename);
    
    // Update rotation for both iframe (PDF) and img (images)
    const iframe = document.querySelector(`iframe[data-filename="${filename}"]`);
    const img = document.querySelector(`img[data-filename="${filename}"]`);
    
    if (iframe) {
        // For PDFs, apply rotation and adjust size with better scaling
        const isLandscape = (originalRotation % 180 === 90);
        iframe.style.transform = `rotate(${originalRotation}deg) scale(${isLandscape ? 0.7 : 1})`;
        iframe.setAttribute('data-rotation', originalRotation);
    }
    if (img) {
        // For images, apply rotation and adjust size
        const isLandscape = (originalRotation % 180 === 90);
        img.style.transform = `rotate(${originalRotation}deg) scale(${isLandscape ? 0.7 : 1})`;
        img.setAttribute('data-rotation', originalRotation);
    }
    
    console.log(`Reset rotation for ${filename} to original ${originalRotation}¬∞`);
}

// Save rotation to server for persistence
function saveRotation(filename, rotation) {
    fetch('/save_rotation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            filename: filename,
            rotation: rotation
        })
    })
    .then(response => {
        if (!response.ok) {
            console.warn('Failed to save rotation to server');
        }
    })
    .catch(error => {
        console.warn('Error saving rotation:', error);
    });
}

function updateInlineViewerRotation(filename, rotation) {
    const section = document.querySelector(`[data-filename="${filename}"]`);
    const viewer = section.querySelector('.universal-viewer');
    
    if (!viewer) return;
    
    // Find iframe or img element and update rotation
    const iframe = viewer.querySelector('iframe');
    const img = viewer.querySelector('img');
    
    if (iframe) {
        iframe.style.transform = `rotate(${rotation}deg)`;
    }
    if (img) {
        img.style.transform = `rotate(${rotation}deg)`;
    }
}

function updateRotationDisplay(filename) {
    const section = document.querySelector(`[data-filename="${filename}"]`);
    if (!section) return;
    
    const currentRotationSpan = section.querySelector('.current-rotation');
    const originalRotation = window.originalRotations[filename] || 0;
    const currentRotation = window.documentRotations[filename] || 0;
    
    if (currentRotationSpan) {
        currentRotationSpan.textContent = `${currentRotation}¬∞`;
        
        if (currentRotation !== originalRotation) {
            currentRotationSpan.className = 'current-rotation text-warning';
        } else {
            currentRotationSpan.className = 'current-rotation text-info';
        }
    }
}

// Strategy override functions
function setStrategy(filename, strategy) {
    console.log(`Setting strategy for ${filename} to ${strategy}`);
    
    // Update UI buttons
    const section = document.querySelector(`[data-filename="${filename}"]`);
    if (section) {
        const buttons = section.querySelectorAll('.override-controls .btn-sm');
        buttons.forEach(btn => btn.classList.remove('active'));
        
        const activeBtn = section.querySelector(`[onclick*="${strategy}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
    }
    
    // TODO: Send to backend
    // fetch('/intake/set_strategy', {
    //     method: 'POST',
    //     headers: { 'Content-Type': 'application/json' },
    //     body: JSON.stringify({ filename: filename, strategy: strategy })
    // });
}

// OCR and LLM functions
function rescanOCR(filename) {
    console.log(`Rescanning OCR for ${filename}`);
    
    // Get current rotation
    const currentRotation = window.documentRotations[filename] || 0;
    
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'üîÑ Rescanning...';
    
    // Perform OCR rescan
    fetch('/rescan_ocr', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            filename: filename,
            rotation: currentRotation
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const details = `File: ${filename}\nRotation: ${currentRotation}¬∞\nText extracted: ${data.content_sample ? data.content_sample.length : 0} characters`;
            showSuccess('OCR Rescan Completed', details);
            // Optionally refresh the analysis
            location.reload();
        } else {
            showError('OCR Rescan Failed', data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('OCR rescan error:', error);
        showError('OCR Rescan Failed', error.message || 'Network or server error');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

function reanalyzeLLM(filename) {
    console.log(`Re-analyzing LLM for ${filename}`);
    
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.disabled = true;
    button.textContent = 'ü§ñ Re-analyzing...';
    
    // Perform LLM re-analysis
    fetch('/reanalyze_llm', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            filename: filename
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const details = `File: ${filename}\nType: ${data.processing_strategy}\nConfidence: ${data.confidence}%\nReasoning: ${data.reasoning}`;
            showSuccess('LLM Re-Analysis Completed', details);
            // Optionally refresh the analysis
            location.reload();
        } else {
            showError('LLM Re-Analysis Failed', data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('LLM re-analysis error:', error);
        showError('LLM Re-Analysis Failed', error.message || 'Network or server error');
    })
    .finally(() => {
        button.disabled = false;
        button.textContent = originalText;
    });
}

// Get current strategy overrides for processing
function getStrategyOverrides() {
    const overrides = {};
    document.querySelectorAll('.override-controls .btn-sm').forEach(btn => {
        if (btn.classList.contains('active')) {
            const filename = btn.closest('[data-filename]').getAttribute('data-filename');
            const strategy = btn.onclick.toString().includes('single_document') ? 'single_document' : 'batch_scan';
            overrides[filename] = strategy;
        }
    });
    return overrides;
}

// Batch processing functions
function startBatchProcessing(mode) {
    console.log(`Starting batch processing in ${mode} mode`);
    
    // Get strategy overrides from UI
    const overrides = getStrategyOverrides();
    
    // Create a form with the overrides data
    const form = document.createElement('form');
    form.method = 'post';
    form.action = `/batch/process_${mode}`;
    
    // Add overrides as hidden inputs
    const overrideInput = document.createElement('input');
    overrideInput.type = 'hidden';
    overrideInput.name = 'strategy_overrides';
    overrideInput.value = JSON.stringify(overrides);
    form.appendChild(overrideInput);
    
    // Submit the form to start processing
    document.body.appendChild(form);
    form.submit();
}

function refreshAnalysis() {
    console.log('Refreshing analysis - clearing cache and re-analyzing');
    
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Clearing Cache...';
    
    // Clear cache first, then start fresh analysis
    fetch('/admin/clear_analysis_cache', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        if (response.ok) {
            // Cache cleared successfully
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Starting Analysis...';
            
            // Small delay to show the status change, then start analysis
            setTimeout(() => {
                // Start fresh analysis
                startAnalysis();
            }, 500);
        } else {
            throw new Error('Failed to clear cache');
        }
    })
    .catch(error => {
        console.error('Error clearing cache:', error);
        // Reset button and try to start analysis anyway
        btn.disabled = false;
        btn.innerHTML = originalText;
        showError('Cache Clear Failed', 'Failed to clear cache, but will try to re-analyze anyway.');
        startAnalysis();
    });
}



// Analysis functions (from original template)
function startAnalysis() {
    console.log('Starting document analysis');
    
    // Disable and update button state
    const startBtns = document.querySelectorAll('[onclick="startAnalysis()"]');
    startBtns.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary');
    });
    
    // Show loading state
    const loadingState = document.getElementById('loading-state');
    const resultsState = document.getElementById('results-state');
    const noFilesState = document.getElementById('no-files-state');
    const errorState = document.getElementById('error-state');
    const analysisState = document.getElementById('analysis-state');
    
    if (loadingState) loadingState.style.display = 'block';
    if (resultsState) resultsState.style.display = 'none';
    if (noFilesState) noFilesState.style.display = 'none';
    if (errorState) errorState.style.display = 'none';
    if (analysisState) analysisState.style.display = 'none';
    
    // Use Server-Sent Events for real-time progress
    const eventSource = new EventSource('/api/analyze_intake_progress');
    
    eventSource.onmessage = function(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('Analysis progress:', data);
            
            if (data.error) {
                eventSource.close();
                if (loadingState) loadingState.style.display = 'none';
                if (analysisState) analysisState.style.display = 'none';
                if (errorState) {
                    errorState.style.display = 'block';
                    const errorMsg = errorState.querySelector('#error-message');
                    if (errorMsg) errorMsg.textContent = data.error;
                }
                resetStartButtons();
                return;
            }
            
            if (data.complete) {
                // Analysis complete
                console.log('Analysis complete:', data);
                eventSource.close();
                resetStartButtons();
                if (loadingState) loadingState.style.display = 'none';
                
                if (data.analyses && data.analyses.length === 0) {
                    if (noFilesState) noFilesState.style.display = 'block';
                } else {
                    // Reload page to show results
                    window.location.reload();
                }
            } else {
                // Progress update
                updateAnalysisProgress(data);
            }
        } catch (parseError) {
            console.error('Error parsing SSE data:', parseError, event.data);
        }
    };
    
    eventSource.onerror = function(error) {
        console.error('EventSource error:', error);
        eventSource.close();
        if (loadingState) loadingState.style.display = 'none';
        if (analysisState) analysisState.style.display = 'none';
        if (errorState) {
            errorState.style.display = 'block';
            const errorMsg = errorState.querySelector('#error-message');
            if (errorMsg) errorMsg.textContent = 'Connection lost during analysis.';
        }
        resetStartButtons();
    };
}

function resetStartButtons() {
    const startBtns = document.querySelectorAll('[onclick="startAnalysis()"]');
    startBtns.forEach(btn => {
        btn.disabled = false;
        btn.innerHTML = 'üöÄ Start Analysis';
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
    });
}

function updateAnalysisProgress(data) {
    console.log('Progress update received:', data); // Debug logging
    
    const progressPercent = data.total > 0 ? Math.round((data.progress / data.total) * 100) : 0;
    const progressText = data.total > 0 ? `${data.progress} of ${data.total} PDFs` : '0 of 0 PDFs';
    
    // Update progress bar if it exists
    const progressBar = document.querySelector('#loading-state .progress-bar');
    if (progressBar) {
        progressBar.style.width = progressPercent + '%';
        progressBar.textContent = progressText;
        console.log(`Updated progress bar: ${progressPercent}% - ${progressText}`); // Debug logging
    } else {
        console.log('Progress bar not found!'); // Debug logging
    }
    
    // Update status message
    const statusMessage = document.querySelector('#loading-state p');
    if (statusMessage) {
        if (data.current_file) {
            statusMessage.textContent = `${data.message || 'Analyzing: ' + data.current_file}`;
            console.log(`Updated status: ${data.message || 'Analyzing: ' + data.current_file}`); // Debug logging
        } else if (data.message) {
            statusMessage.textContent = data.message;
            console.log(`Updated status: ${data.message}`); // Debug logging
        }
    } else {
        console.log('Status message element not found!'); // Debug logging
    }
    
    console.log(`Progress: ${progressText} (${progressPercent}%)`);
}
</script>
{% endblock %}