{% extends 'base.html' %}

{% block title %}Intake Analysis - Document Processing{% endblock %}

{% block content %}
<!-- Include PDF Modal Viewer Component -->
{% include 'components/pdf_modal.html' %}

<style>
/* Enhanced layout combining manipulate.html structure with intake analysis data */
.main-container {
    padding: 20px;
}

.document-section {
    display: flex;
    gap: 20px;
    margin-bottom: 40px;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f8f9fa;
}

.document-viewer-pane {
    flex: 1;
    min-width: 400px;
    position: sticky;
    top: 20px;
    height: fit-content;
}

.universal-viewer {
    width: 100%;
    height: 70vh;
    border: 2px solid #007BFF;
    background-color: white;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

.viewer-placeholder {
    text-align: center;
    color: #6c757d;
    padding: 40px;
}

.viewer-controls {
    margin-top: 15px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
}

.viewer-controls button {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    background-color: #6c757d;
    color: white;
    cursor: pointer;
    font-size: 0.9em;
}

.viewer-controls button:hover {
    background-color: #5a6268;
}

.viewer-controls button.active {
    background-color: #007BFF;
}

.rotation-info {
    margin-top: 10px;
    padding: 8px 12px;
    background-color: #e3f2fd;
    border-radius: 4px;
    font-size: 0.9em;
    text-align: center;
}

.document-info-pane {
    flex: 1;
    min-width: 400px;
}

.info-card {
    background-color: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
}

.info-card-header {
    background-color: #f8f9fa;
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.info-card-body {
    padding: 20px;
}

.info-grid {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 10px 20px;
    margin-bottom: 15px;
}

.info-label {
    font-weight: bold;
    color: #495057;
}

.info-value {
    color: #212529;
}

.confidence-bar {
    display: flex;
    align-items: center;
    gap: 10px;
}

.progress-bar-container {
    flex: 1;
    height: 8px;
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    transition: width 0.3s ease;
}

.reasoning-list {
    max-height: 150px;
    overflow-y: auto;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 15px;
}

.reasoning-list ul {
    margin: 0;
    padding: 0;
    list-style-type: disc;
    padding-left: 20px;
}

.reasoning-list li {
    margin-bottom: 8px;
    font-size: 0.9em;
}

.strategy-section {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.strategy-badge {
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
}

.strategy-single {
    background-color: #d4edda;
    color: #155724;
}

.strategy-batch {
    background-color: #cce5ff;
    color: #004085;
}

.override-controls {
    display: flex;
    gap: 8px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 0.8em;
    border: 1px solid #ddd;
    border-radius: 4px;
    background-color: white;
    cursor: pointer;
}

.btn-sm:hover {
    background-color: #f8f9fa;
}

.btn-sm.active {
    background-color: #007BFF;
    color: white;
    border-color: #007BFF;
}

.llm-analysis-box {
    background-color: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 4px;
    padding: 15px;
    margin-top: 15px;
}

.content-sample {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    max-height: 200px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.batch-controls {
    position: sticky;
    bottom: 0;
    background-color: white;
    border-top: 2px solid #007BFF;
    padding: 20px;
    margin-top: 40px;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
}

.batch-controls-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
}

.batch-summary {
    font-size: 1.1em;
}

.batch-actions {
    display: flex;
    gap: 15px;
}

.btn-primary {
    background-color: #007BFF;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
}

.btn-success {
    background-color: #28a745;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 5px;
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
}

@media (max-width: 1024px) {
    .document-section {
        flex-direction: column;
    }
    
    .document-viewer-pane {
        position: static;
    }
    
    .universal-viewer {
        height: 50vh;
    }
}
</style>

<div class="main-container">
    <h1>üìÑ Document Analysis & Processing</h1>
    
    <!-- Analysis State Display -->
    <div id="analysis-state" class="mb-4">
        {% if not analyses %}
        <!-- No Analysis Results State -->
        <div class="card">
            <div class="card-body text-center">
                <h4>üìÅ No Documents Analyzed Yet</h4>
                <p>Click the button below to analyze documents in the intake directory.</p>
                <button onclick="startAnalysis()" class="btn btn-primary btn-lg"{{ testid('start-analysis') }}>
                    üöÄ Start Analysis
                </button>
            </div>
        </div>
        {% else %}
        <!-- Analysis Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>üìä Analysis Summary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Total Documents:</strong> {{ analyses|length }}
                    </div>
                    <div class="col-md-3">
                        <strong>Single Document:</strong> {{ analyses|selectattr("processing_strategy", "equalto", "single_document")|list|length }}
                    </div>
                    <div class="col-md-3">
                        <strong>Batch Scan:</strong> {{ analyses|selectattr("processing_strategy", "equalto", "batch_scan")|list|length }}
                    </div>
                    <div class="col-md-3">
                        <strong>Avg Confidence:</strong> {{ "%.1f%%"|format((analyses|map(attribute='confidence')|sum / analyses|length) * 100) }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Document List -->
        {% for analysis in analyses %}
        <div class="document-section" data-filename="{{ analysis.filename }}">
            <!-- Left Pane: Document Viewer -->
            <div class="document-viewer-pane">
                <div class="universal-viewer" id="viewer-{{ loop.index }}">
                    <div class="viewer-placeholder">
                        <h5>{{ analysis.filename }}</h5>
                        <p>Click "View Document" to load preview</p>
                    </div>
                </div>
                
                <div class="viewer-controls">
                    <button onclick="openDocumentViewer('{{ analysis.filename }}', {{ analysis.detected_rotation or 0 }})" class="btn-primary" data-analysis-index="{{ loop.index }}"{{ testid('analysis-view-'+loop.index|string) }}>üëÅÔ∏è View</button>
                    <button onclick="rotateDocument('{{ analysis.filename }}', 90)"{{ testid('rotate-right') }}>‚Üª Right</button>
                    <button onclick="rotateDocument('{{ analysis.filename }}', -90)"{{ testid('rotate-left') }}>‚Ü∫ Left</button>
                    <button onclick="resetRotation('{{ analysis.filename }}')"{{ testid('rotate-reset') }}>üîÑ Reset</button>
                    <button onclick="cycleFitModeFor('{{ analysis.filename }}', this)"{{ testid('fit-mode') }}>üñºÔ∏è Fit: Auto</button>
                </div>
                <div class="rotation-info">
                  <div><strong>Original:</strong> <span class="original-rotation">{{ analysis.detected_rotation or 0 }}¬∞ detected</span></div>
                  <div><strong>Current:</strong> <span class="current-rotation text-info" data-filename="{{ analysis.filename }}">{{ analysis.detected_rotation or 0 }}¬∞</span></div>
                </div>
            </div>

            <!-- Right Pane: Document Information -->
            <div class="document-info-pane">
                <!-- Basic File Information -->
                <div class="info-card">
                    <div class="info-card-header">
                        <h6>üìã File Information</h6>
                        <span class="badge badge-info">{{ analysis.filename.split('.')[-1].upper() }}</span>
                    </div>
                    <div class="info-card-body">
                        <div class="info-grid">
                            <span class="info-label">Filename:</span>
                            <span class="info-value">{{ analysis.filename }}</span>
                            
                            <span class="info-label">File Size:</span>
                            <span class="info-value">{{ "%.1f"|format(analysis.file_size_mb) }} MB</span>
                            
                            <span class="info-label">Pages:</span>
                            <span class="info-value">{{ analysis.page_count }}</span>
                            
                            <span class="info-label">Hints:</span>
                            <span class="info-value">
                                {% if analysis.filename_hints == "single" %}
                                    <span class="badge badge-success">Single Document</span>
                                {% elif analysis.filename_hints == "batch" %}
                                    <span class="badge badge-warning">Batch Document</span>
                                {% else %}
                                    <span class="badge badge-secondary">Unknown</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Processing Strategy -->
                <div class="info-card">
                    <div class="info-card-header">
                        <h6>‚öôÔ∏è Processing Strategy</h6>
                        <div class="override-controls">
                            <button class="btn-sm {{ 'active' if analysis.processing_strategy == 'single_document' else '' }}" 
                                {{ testid('analysis-strategy-single-new-'+loop.index|string) }}
                                    onclick="setStrategy('{{ analysis.filename }}', 'single_document')">
                                üöÄ Single
                            </button>
                            <button class="btn-sm {{ 'active' if analysis.processing_strategy == 'batch_scan' else '' }}" 
                                {{ testid('analysis-strategy-batch-new-'+loop.index|string) }}
                                    onclick="setStrategy('{{ analysis.filename }}', 'batch_scan')">
                                üìã Batch
                            </button>
                        </div>
                    </div>
                    <div class="info-card-body">
                        <div class="strategy-section">
                            {% if analysis.processing_strategy == "single_document" %}
                                <span class="strategy-badge strategy-single">üöÄ Single Document Processing</span>
                                <small class="text-muted">Direct processing - file will be processed as individual document</small>
                            {% else %}
                                <span class="strategy-badge strategy-batch">üìã Batch Scan Processing</span>
                                <small class="text-muted">Page verification - each page will be reviewed individually</small>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Analysis Confidence -->
                <div class="info-card">
                    <div class="info-card-header">
                        <h6>üìä Analysis Confidence</h6>
                        <button class="btn-sm" onclick="rescanOCR('{{ analysis.filename }}')"{{ testid('analysis-rescan-ocr-new-'+loop.index|string) }}>
                            üîç Rescan OCR
                        </button>
                    </div>
                    <div class="info-card-body">
                        {% set confidence_percent = (analysis.confidence * 100)|int %}
                        <div class="confidence-bar">
                            <div class="progress-bar-container">
                                <div class="progress-bar 
                                    {% if confidence_percent >= 70 %}bg-success
                                    {% elif confidence_percent >= 50 %}bg-warning
                                    {% else %}bg-danger{% endif %}" 
                                    style="width: {{ confidence_percent }}%">
                                </div>
                            </div>
                            <strong>{{ confidence_percent }}%</strong>
                        </div>
                        
                        <div class="reasoning-list">
                            <strong>Reasoning:</strong>
                            <ul>
                                {% for reason in analysis.reasoning[:5] %}
                                <li>{{ reason }}</li>
                                {% endfor %}
                                {% if analysis.reasoning|length > 5 %}
                                <li><em>... and {{ analysis.reasoning|length - 5 }} more reasons</em></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- LLM Analysis -->
                {% if analysis.llm_analysis %}
                <div class="info-card">
                    <div class="info-card-header">
                        <h6>ü§ñ AI Analysis</h6>
                        <button class="btn-sm" onclick="reanalyzeLLM('{{ analysis.filename }}')"{{ testid('analysis-reanalyze-new-'+loop.index|string) }}>
                            ü§ñ Re-analyze
                        </button>
                    </div>
                    <div class="info-card-body">
                        <div class="llm-analysis-box">
                            <div class="info-grid">
                                <span class="info-label">Classification:</span>
                                <span class="info-value text-primary">{{ analysis.llm_analysis.classification|title }}</span>
                                
                                <span class="info-label">Confidence:</span>
                                <span class="info-value">{{ analysis.llm_analysis.confidence }}%</span>
                                
                                <span class="info-label">Reasoning:</span>
                                <span class="info-value">{{ analysis.llm_analysis.reasoning }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Content Sample -->
                {% if analysis.content_sample %}
                <div class="info-card">
                    <div class="info-card-header">
                        <h6>üìÑ Content Sample</h6>
                    </div>
                    <div class="info-card-body">
                        <div class="content-sample">{{ analysis.content_sample }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>

<!-- Batch Processing Controls -->
{% if analyses %}
<div class="batch-controls">
    <div class="batch-controls-content">
        <div class="batch-summary">
            <strong>{{ analyses|length }} documents ready for processing</strong>
        </div>
        <div class="batch-actions">
            <button onclick="startBatchProcessing('smart')" class="btn-success"{{ testid('start-smart-processing') }}>
                üöÄ Start Smart Processing
            </button>
            <button onclick="refreshAnalysis()" class="btn-secondary"{{ testid('refresh-analysis') }}>
                üîÑ Refresh Analysis
            </button>
            <button onclick="exportResults()" class="btn-primary"{{ testid('export-results') }}>
                üìã Export Results
            </button>
        </div>
    </div>
</div>
{% endif %}

<script>
// Rotation tracking leveraging shared rotation_utils.js
window.documentRotations = window.documentRotations || {};
window.originalRotations = window.originalRotations || {};
{% if analyses %}{% for analysis in analyses %}
window.originalRotations['{{ analysis.filename }}'] = {{ analysis.detected_rotation or 0 }};
window.documentRotations['{{ analysis.filename }}'] = {{ analysis.detected_rotation or 0 }};
{% endfor %}{% endif %}

// Document viewer functions using the existing PDF modal
function openDocumentViewer(filename, initialRotation = 0) {
    console.log(`Opening viewer for ${filename} with rotation ${initialRotation}¬∞`);
    
    // Create document URL based on file type
    const documentUrl = `/intake/view_document/${encodeURIComponent(filename)}`;
    const title = filename;
    
    // Use current rotation if available
    const currentRotation = window.documentRotations[filename] || initialRotation;
    
    // Open the universal PDF modal viewer
    if (window.openPdfViewer) {
        window.openPdfViewer(documentUrl, title, currentRotation);
    } else {
        console.error('PDF viewer not available');
        alert('Document viewer not available');
    }
}

// Rotation functions using shared utilities
function rotateDocument(filename, degrees){
    const current = window.documentRotations[filename] || 0;
    const next = (current + degrees + 360) % 360;
    window.documentRotations[filename] = next;
    applyRotationVisual(filename, next);
}
function resetRotation(filename){
    const base = window.originalRotations[filename] || 0;
    window.documentRotations[filename] = base;
    applyRotationVisual(filename, base, true);
}
function cycleFitModeFor(filename, btn){
    const iframe = document.querySelector(`.universal-viewer[data-filename="${filename}"] iframe`);
    if(!iframe || !window.RotationUtils) return;
    const mode = window.RotationUtils.cycleFitMode(iframe);
    const angle = window.documentRotations[filename] || 0;
    window.RotationUtils.applyScaledRotation(iframe, angle);
    btn.textContent = `üñºÔ∏è Fit: ${mode.charAt(0).toUpperCase()+mode.slice(1)}`;
}
function applyRotationVisual(filename, angle, isReset=false){
    const section = document.querySelector(`[data-filename="${filename}"]`);
    if(section){
        const span = section.querySelector('.current-rotation');
        if(span){ span.textContent = `${angle}¬∞`; span.className = `current-rotation ${angle !== (window.originalRotations[filename]||0) ? 'text-warning':'text-info'}`; }
        // On first view injection, we lazily load iframe; if present apply transform
        const iframe = section.querySelector('iframe');
        if(iframe && window.RotationUtils){
            if(isReset){ window.RotationUtils.reset(iframe); } else { window.RotationUtils.applyScaledRotation(iframe, angle); }
        }
    }
}

// Strategy override functions
function setStrategy(filename, strategy) {
    console.log(`Setting strategy for ${filename} to ${strategy}`);
    
    // Update UI buttons
    const section = document.querySelector(`[data-filename="${filename}"]`);
    if (section) {
        const buttons = section.querySelectorAll('.override-controls .btn-sm');
        buttons.forEach(btn => btn.classList.remove('active'));
        
        const activeBtn = section.querySelector(`[onclick*="${strategy}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }
    }
    
    // TODO: Send to backend
    // fetch('/intake/set_strategy', {
    //     method: 'POST',
    //     headers: { 'Content-Type': 'application/json' },
    //     body: JSON.stringify({ filename: filename, strategy: strategy })
    // });
}

// OCR and LLM functions
function rescanOCR(filename) {
    console.log(`Rescanning OCR for ${filename}`);
    
    // Get current rotation
    const currentRotation = window.documentRotations[filename] || 0;
    
    // TODO: Implement OCR rescan with rotation
    alert(`OCR rescan for ${filename} with ${currentRotation}¬∞ rotation - TODO: Implement`);
}

function reanalyzeLLM(filename) {
    console.log(`Re-analyzing LLM for ${filename}`);
    
    // TODO: Implement LLM re-analysis
    alert(`LLM re-analysis for ${filename} - TODO: Implement`);
}

// Batch processing functions
function startBatchProcessing(mode) {
    console.log(`Starting batch processing in ${mode} mode`);
    
    // TODO: Implement batch processing
    alert(`Batch processing (${mode}) - TODO: Implement`);
}

function refreshAnalysis(){ console.log('Refreshing analysis'); window.location.reload(); }

function exportResults(){ console.log('Exporting results'); alert('Export results - TODO: Implement'); }

// Analysis functions (from original template)
function startAnalysis(){ console.log('Starting document analysis'); alert('Start analysis - TODO: Implement'); }
</script>
<script src="{{ url_for('static', filename='js/rotation_utils.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
    // Initialize any already-injected iframes (placeholder currently)
    document.querySelectorAll('.universal-viewer iframe').forEach(ifr=>{ if(window.RotationUtils){ window.RotationUtils.applyScaledRotation(ifr, 0); }});
});
</script>
{% endblock %}