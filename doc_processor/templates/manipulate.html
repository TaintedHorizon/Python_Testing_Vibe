{% extends 'base.html' %}

{% block title %}Manipulate Single Documents{% endblock %}

{% block content %}
<!-- Include PDF Modal Viewer Component -->
{% include 'components/pdf_modal.html' %}
<h1>üõ†Ô∏è Manipulate Single Documents</h1>
<p>Edit AI-suggested category and filename for each document in this batch. Review and finalize before export.</p>

<form method="post" action="{{ url_for('manipulate_batch_page', batch_id=batch_id) }}">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Original Filename</th>
                <th>AI Category</th>
                <th>AI Filename</th>
                <th>AI Confidence</th>
                <th>Summary</th>
                <th>Edit Category</th>
                <th>Edit Filename</th>
                <th>Preview</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
            <tr>
                <td>{{ doc.original_filename }}</td>
                <td>{{ doc.ai_suggested_category }}</td>
                <td>{{ doc.ai_suggested_filename }}</td>
                <td>{{ '%.2f'|format(doc.ai_confidence) }}</td>
                <td>{{ doc.ai_summary }}</td>
                <td>
                    <input type="text" name="category_{{ doc.id }}" value="{{ doc.ai_suggested_category }}" class="form-control" />
                </td>
                <td>
                    <input type="text" name="filename_{{ doc.id }}" value="{{ doc.ai_suggested_filename }}" class="form-control" />
                </td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-primary view-pdf-btn" 
                            data-filename="{{ doc.original_filename }}" 
                            data-category="{{ doc.ai_suggested_category }}"
                            data-suggested="{{ doc.ai_suggested_filename }}"
                            title="Preview original PDF to verify AI suggestions">
                        üìÑ View PDF
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary">Save Changes</button>
</form>

<!-- Separate form for finalization to avoid conflicts -->
<form method="post" action="{{ url_for('finalize_single_documents_batch_action', batch_id=batch_id) }}" style="display: inline;">
    <button type="submit" class="btn btn-success" onclick="return confirm('Are you sure you want to export all documents to their category folders? This action cannot be undone.');">üéØ Finalize & Export Single Documents</button>
</form>
<a href="{{ url_for('batch_control_page') }}" class="btn btn-secondary">Back to Batch Control</a>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // PDF Viewer button handlers
    const viewPdfBtns = document.querySelectorAll('.view-pdf-btn');
    viewPdfBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const filename = this.getAttribute('data-filename');
            const category = this.getAttribute('data-category');
            const suggested = this.getAttribute('data-suggested');
            
            if (filename && typeof openPdfViewer === 'function') {
                const pdfUrl = `/original_pdf/${encodeURIComponent(filename)}`;
                const title = `${filename} - AI Suggested: "${suggested}" (${category})`;
                openPdfViewer(pdfUrl, title);
            } else {
                alert('PDF viewer not available or source file not found');
            }
        });
    });
});
</script>
{% endblock %}