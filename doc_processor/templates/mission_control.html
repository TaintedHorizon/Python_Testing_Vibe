{% extends 'base.html' %}

{% block title %}Mission Control{% endblock %}

{% block content %}
<style>
    /* General table styling */
    .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .history-table th, .history-table td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
    .history-table th { background-color: #f2f2f2; font-weight: bold; }
    
    /* Styling for action buttons to make them look distinct */
    .action-btn { display: inline-block; padding: 8px 12px; text-decoration: none; color: white; border-radius: 5px; font-size: 0.9em; margin-right: 5px; margin-bottom: 5px; border: none; cursor: pointer; }
    .btn-verify { background-color: #007BFF; } /* Blue */
    .btn-review { background-color: #ffc107; color: black; } /* Yellow */
    .btn-group { background-color: #28a745; } /* Green */
    .btn-order { background-color: #6f42c1; } /* Purple */
    .btn-revisit { background-color: #6c757d; } /* Gray */
    .btn-reset { background-color: #dc3545; } /* Red */
    
    /* Styling for the new batch form section */
    .new-batch-form { padding: 20px; background-color: white; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 30px; text-align: center; }
    .new-batch-form button { font-size: 1.2em; padding: 10px 20px; cursor: pointer; width: 100%; background-color: #3182ce; color: white; border-radius: 5px; border: none; }
    .new-batch-form button:hover { background-color: #2c5282; }
</style>

<h1>Mission Control</h1>
<p>This is the central hub for managing all batches. Start a new batch or continue with an existing one below.</p>

<!-- Form to initiate a new batch processing job -->
<div class="new-batch-form">
    <form id="batch-form" action="{{ url_for('handle_batch_processing') }}" method="post">
        <button id="start-button" type="submit">Start New Batch</button>
    </form>
</div>

<!-- Table displaying the history of all processed batches -->
<table class="history-table">
    <thead>
        <tr>
            <th>Batch ID</th>
            <th>Start Time</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- Loop through each batch passed from the Flask backend -->
        {% for batch in batches %}
        <tr>
            <td>#{{ batch.id }}</td>
            <td>{{ batch.start_time }}</td>
            <td>{{ batch.status | replace('_', ' ') | title }}</td>
            <td>
                {% if batch.status == 'pending_verification' %}
                    <a href="{{ url_for('verify_batch_page', batch_id=batch.id) }}" class="action-btn btn-verify">Verify</a>
                
                {% elif batch.status == 'verification_complete' %}
                    <a href="{{ url_for('group_batch_page', batch_id=batch.id) }}" class="action-btn btn-group">Group ({{ batch.ungrouped_count }} ungrouped)</a>
                    {% if batch.flagged_count > 0 %}
                        <a href="{{ url_for('review_batch_page', batch_id=batch.id) }}" class="action-btn btn-review">Review ({{ batch.flagged_count }} flagged)</a>
                    {% endif %}
                    <a href="{{ url_for('revisit_batch_page', batch_id=batch.id) }}" class="action-btn btn-revisit">Revisit Pages</a>
                
                {% elif batch.status == 'grouping_complete' %}
                    <a href="{{ url_for('order_batch_page', batch_id=batch.id) }}" class="action-btn btn-order">Order Pages</a>
                    <a href="{{ url_for('group_batch_page', batch_id=batch.id) }}" class="action-btn btn-group">Revisit Grouping</a>
                    <a href="{{ url_for('revisit_batch_page', batch_id=batch.id) }}" class="action-btn btn-revisit">Revisit Pages</a>
                
                {% elif batch.status == 'ordering_complete' %}
                    <span style="color:green; font-weight: bold;">âœ“ Complete</span>
                    <a href="{{ url_for('view_batch_page', batch_id=batch.id) }}" class="action-btn btn-revisit">View Pages</a>

                {% else %}
                    <a href="{{ url_for('revisit_batch_page', batch_id=batch.id) }}" class="action-btn btn-revisit">Revisit Batch</a>
                {% endif %}

                {% if batch.status != 'pending_verification' and batch.status != 'Exported' %}
                    <form action="{{ url_for('reset_batch_action', batch_id=batch.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to completely reset this batch? All grouping and ordering will be lost.');">
                        <button type="submit" class="action-btn btn-reset">Reset Batch</button>
                    </form>
                {% endif %}

            </td>
        </tr>
        {% else %}
        <!-- This row is shown if there are no batches in the database yet. -->
        <tr>
            <td colspan="4" style="text-align: center;">No batches have been processed yet. Click "Start New Batch" to begin.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    // This script provides simple feedback to the user after they click the "Start New Batch" button.
    const batchForm = document.getElementById('batch-form');
    if (batchForm) {
        batchForm.addEventListener('submit', function() {
            const button = document.getElementById('start-button');
            // Disable the button to prevent multiple clicks while the backend is working.
            button.disabled = true;
            // Update the button text to show that something is happening.
            button.innerText = 'Processing... Please Wait...';
        });
    }
</script>
{% endblock %}
