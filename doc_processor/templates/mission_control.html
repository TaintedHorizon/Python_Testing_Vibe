{% extends 'base.html' %}

<!-- Sets the browser tab title for the Mission Control page. -->
{% block title %}Mission Control{% endblock %}

<!-- Main content block for the Mission Control dashboard. -->
{% block content %}
<style>
    /* General table styling for the batch history table. */
    .history-table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 20px; 
        background-color: white; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* Adds a subtle shadow for depth. */
    }
    .history-table th, .history-table td { 
        border: 1px solid #ddd; 
        padding: 12px; 
        text-align: left; 
        vertical-align: middle; 
    }
    .history-table th { 
        background-color: #f2f2f2; 
        font-weight: bold; 
    }
    
    /* Styling for action buttons to make them visually distinct and workflow-specific. */
    .action-btn { 
        display: inline-block; 
        padding: 8px 12px; 
        text-decoration: none; 
        color: white; 
        border-radius: 5px; 
        font-size: 0.9em; 
        margin-right: 5px; 
        margin-bottom: 5px; 
        border: none; 
        cursor: pointer; 
        transition: background-color 0.2s; /* Smooth transition for hover effects. */
    }
    .action-btn:hover:not(.disabled) { opacity: 0.9; } /* Slight opacity change on hover for non-disabled buttons. */

    /* Specific color schemes for different action types to improve visual recognition. */
    .btn-verify { background-color: #007BFF; } /* Blue for verification. */
    .btn-review { background-color: #ffc107; color: black; } /* Yellow for review, with black text for contrast. */
    .btn-group { background-color: #28a745; } /* Green for grouping. */
    .btn-order { background-color: #6f42c1; } /* Purple for ordering. */
    .btn-finalize { background-color: #17a2b8; } /* Teal for finalization. */
    .btn-view-docs { background-color: #20c997; } /* Brighter Teal for viewing exported documents. */
    .btn-revisit { background-color: #6c757d; } /* Gray for read-only revisit actions. */
    .btn-reset { background-color: #dc3545; } /* Red for destructive reset actions. */

    /* Style for a disabled-looking link/button to indicate it's not clickable. */
    .action-btn.disabled {
        background-color: #6c757d; /* Grey out the button. */
        pointer-events: none; /* Prevents click events. */
        cursor: not-allowed; /* Changes cursor to indicate non-interactivity. */
        opacity: 0.7; /* Slightly faded appearance. */
    }
    
    /* Styling for the "Start New Batch" form section. */
    .new-batch-form { 
        padding: 20px; 
        background-color: white; 
        border: 1px solid #ccc; 
        border-radius: 5px; 
        margin-bottom: 30px; 
        text-align: center; 
    }
    .new-batch-form button { 
        font-size: 1.2em; 
        padding: 10px 20px; 
        cursor: pointer; 
        width: 100%; 
        background-color: #3182ce; 
        color: white; 
        border-radius: 5px; 
        border: none; 
        transition: background-color 0.2s; 
    }
    .new-batch-form button:hover { 
        background-color: #2c5282; 
    }
</style>

<h1>Mission Control</h1>
<p>This is the central hub for managing all batches. Start a new batch or continue with an existing one below.</p>

<!-- Section for initiating a new batch processing. -->
<div class="new-batch-form">
    <!-- This form submits a POST request to the `handle_batch_processing` route. -->
    <form id="batch-form" action="{{ url_for('handle_batch_processing') }}" method="post">
        <button id="start-button" type="submit">Start New Batch</button>
    </form>
</div>

<!-- Table to display the history and status of all processed batches. -->
<table class="history-table">
    <thead>
        <tr>
            <th>Batch ID</th>
            <th>Start Time</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- Jinja2 loop to iterate through each batch passed from the Flask backend. -->
        {% for batch in batches %}
        <tr>
            <td>#{{ batch.id }}</td>
            <td>{{ batch.start_time }}</td>
            <!-- Format the status string for better readability (e.g., "pending_verification" -> "Pending Verification"). -->
            <td>{{ batch.status | replace('_', ' ') | title }}</td>
            <td>
                <!-- Conditional rendering of action buttons based on the current status of the batch. -->
                {% if batch.status == 'pending_verification' %}
                    <!-- If the batch is pending verification, provide a button to start the verification process. -->
                    <a href="{{ url_for('verify_batch_page', batch_id=batch.id) }}" class="action-btn btn-verify">Verify</a>
                
                {% elif batch.status == 'verification_complete' %}
                    <!-- If verification is complete, provide options for grouping, reviewing flagged pages, or revisiting pages. -->
                    <a href="{{ url_for('group_batch_page', batch_id=batch.id) }}" class="action-btn btn-group">Group ({{ batch.ungrouped_count }} ungrouped)</a>
                    {% if batch.flagged_count > 0 %}
                        <!-- Only show the review button if there are actual flagged pages. -->
                        <a href="{{ url_for('review_batch_page', batch_id=batch.id) }}" class="action-btn btn-review">Review ({{ batch.flagged_count }} flagged)</a>
                    {% endif %}
                    <a href="{{ url_for('revisit_batch_page', batch_id=batch.id) }}" class="action-btn btn-revisit">Revisit Pages</a>
                
                {% elif batch.status == 'grouping_complete' %}
                    <!-- If grouping is complete, provide options for ordering pages, revisiting grouping, or revisiting pages. -->
                    <a href="{{ url_for('order_batch_page', batch_id=batch.id) }}" class="action-btn btn-order">Order Pages</a>
                    <a href="{{ url_for('group_batch_page', batch_id=batch.id) }}" class="action-btn btn-group">Revisit Grouping</a>
                    <a href="{{ url_for('revisit_batch_page', batch_id=batch.id) }}" class="action-btn btn-revisit">Revisit Pages</a>
                
                {% elif batch.status == 'ordering_complete' %}
                    <!-- If ordering is complete, provide options for finalization/export or viewing pages. -->
                    <a href="{{ url_for('finalize_batch_page', batch_id=batch.id) }}" class="action-btn btn-finalize">Finalize & Export</a>
                    <a href="{{ url_for('view_batch_page', batch_id=batch.id) }}" class="action-btn btn-revisit">View Pages</a>

                {% elif batch.status == 'Exported' %}
                    <!-- If the batch has been exported, provide a link to view the final documents. -->
                    <a href="{{ url_for('view_documents_page', batch_id=batch.id) }}" class="action-btn btn-view-docs">View Documents</a>

                {% else %}
                    <!-- Default action for any other status, typically a read-only revisit. -->
                    <a href="{{ url_for('revisit_batch_page', batch_id=batch.id) }}" class="action-btn btn-revisit">Revisit Batch</a>
                {% endif %}

                <!-- The "Reset Batch" button is available for most active batches, but not for newly created or already exported ones. -->
                {% if batch.status != 'pending_verification' and batch.status != 'Exported' %}
                    <!-- This form submits a POST request to reset the batch. A JavaScript confirmation is added for safety. -->
                    <form action="{{ url_for('reset_batch_action', batch_id=batch.id) }}" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to completely reset this batch? All grouping and ordering will be lost.');">
                        <button type="submit" class="action-btn btn-reset">Reset Batch</button>
                    </form>
                {% endif %}
            </td>
        </tr>
        {% else %}
        <!-- This `else` block for the loop is displayed if the `batches` list is empty (i.e., no batches have been processed yet). -->
        <tr>
            <td colspan="4" style="text-align: center;">No batches have been processed yet. Click "Start New Batch" to begin.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    // Ensures the script runs after the entire HTML document has been loaded and parsed.
    document.addEventListener('DOMContentLoaded', function() {
        // Script for the "Start New Batch" button to provide immediate user feedback.
        const batchForm = document.getElementById('batch-form');
        if (batchForm) {
            batchForm.addEventListener('submit', function() {
                const button = document.getElementById('start-button');
                button.disabled = true; // Disable the button to prevent multiple submissions.
                button.innerText = 'Processing... Please Wait...'; // Change text to indicate ongoing process.
            });
        }

        // Script for the "Finalize & Export" button to provide immediate user feedback.
        const finalizeLinks = document.querySelectorAll('.btn-finalize');
        finalizeLinks.forEach(link => {
            link.addEventListener('click', function(event) {
                // Add a 'disabled' class and change text to indicate loading.
                link.classList.add('disabled');
                link.textContent = 'Loading...';
            });
        });
    });
</script>
{% endblock %}