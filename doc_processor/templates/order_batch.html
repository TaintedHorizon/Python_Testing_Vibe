{% extends 'base.html' %}

{% block title %}Order Documents for Batch {{ batch_id }}{% endblock %}

{% block content %}
<!-- Include PDF Modal Viewer Component -->
{% include 'components/pdf_modal.html' %}
<style>
    .doc-list-container { max-width: 800px; margin: auto; background-color: white; padding: 20px; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .doc-list-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .doc-list-table th, .doc-list-table td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
    .doc-list-table th { background-color: #f2f2f2; }
    .action-btn { display: inline-block; padding: 8px 12px; text-decoration: none; color: white; border-radius: 5px; font-size: 0.9em; }
    .btn-order { background-color: #007BFF; }
    .btn-revisit { background-color: #6c757d; }
    .finish-form { margin-top: 20px; text-align: center; }
    .finish-btn {
        padding: 10px 25px;
        background-color: #28a745;
        color: white;
        border-radius: 5px;
        font-size: 1.1em;
        border: none;
        cursor: pointer;
    }
</style>

<div class="doc-list-container">
    <h1>Order Documents for Batch #{{ batch_id }}</h1>
    <p>This is the third step of the workflow. This page lists all documents that have multiple pages and may require manual ordering. Single-page documents are considered ordered by default.</p>

    <!-- Table listing all multi-page documents in the batch -->
    <table class="doc-list-table">
        <thead>
            <tr>
                <th>Document Name</th>
                <th>Status</th>
                <th>Action</th>
                <th>Preview</th>
            </tr>
        </thead>
        <tbody>
            <!-- Loop through the documents passed from the Flask backend -->
            {% for doc in documents %}
            <tr>
                <td>{{ doc.document_name }}</td>
                <td>
                    <!-- Display the ordering status of the document -->
                    {% if doc.status == 'order_set' %}
                        <span style="color: green; font-weight: bold;">Order Set</span>
                    {% else %}
                        <span style="color: orange; font-weight: bold;">Pending Order</span>
                    {% endif %}
                </td>
                <td>
                    <!-- Provide a link to the ordering page for this specific document -->
                    {% if doc.status == 'order_set' %}
                        <form method="post" action="{{ url_for('revisit_ordering_document_action', document_id=doc.id) }}" style="display:inline;">
                            <button type="submit" class="action-btn btn-revisit" onclick="event.stopPropagation();">Revisit Order</button>
                        </form>
                    {% else %}
                        <a href="{{ url_for('order_document_page', document_id=doc.id) }}" class="action-btn btn-order">Order Pages</a>
                    {% endif %}
                </td>
                <td>
                    <!-- PDF Viewer button -->
                    {% if doc.source_filename %}
                        <button type="button" class="view-pdf-btn action-btn" data-filename="{{ doc.source_filename }}" data-docname="{{ doc.document_name }}" style="background:#007BFF; color:white; font-size:0.9em;">
                            ðŸ“„ View PDF
                        </button>
                    {% else %}
                        <span style="color:#999; font-size:0.8em;">No source</span>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <!-- This message is shown if there are no documents in the batch (or none that need ordering) -->
            <tr>
                <td colspan="4" style="text-align: center;">No multi-page documents require ordering in this batch.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Form to finish ordering and return to Batch Control -->
    <form class="finish-form" action="{{ url_for('finish_ordering_action', batch_id=batch_id) }}" method="post">
        <button type="submit" class="finish-btn">Finish Ordering</button>
    </form>
    <script>
    // Intercept the document-level revisit order form submit to redirect to the correct document after POST
    document.querySelectorAll('form[action*="revisit_ordering_document"]').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            var docId = form.action.split('/').pop();
            fetch(form.action, {method: 'POST'})
                .then(function() {
                    window.location.href = '/order/' + docId;
                });
        });
    });

    // PDF Viewer button handlers
    document.addEventListener('DOMContentLoaded', function() {
        const viewPdfBtns = document.querySelectorAll('.view-pdf-btn');
        viewPdfBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const sourceFilename = this.getAttribute('data-filename');
                const docName = this.getAttribute('data-docname');
                if (sourceFilename && typeof openPdfViewer === 'function') {
                    const pdfUrl = `/original_pdf/${encodeURIComponent(sourceFilename)}`;
                    const title = `${docName} (Source: ${sourceFilename})`;
                    openPdfViewer(pdfUrl, title);
                } else {
                    alert('PDF viewer not available or source file not found');
                }
            });
        });
    });
    </script>
</div>
{% endblock %}
