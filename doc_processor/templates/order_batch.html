{% extends 'base.html' %}

{% block title %}Order Documents for Batch {{ batch_id }}{% endblock %}

{% block content %}
<style>
    .doc-list-container { max-width: 800px; margin: auto; background-color: white; padding: 20px; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .doc-list-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .doc-list-table th, .doc-list-table td { border: 1px solid #ddd; padding: 12px; text-align: left; vertical-align: middle; }
    .doc-list-table th { background-color: #f2f2f2; }
    .action-btn { display: inline-block; padding: 8px 12px; text-decoration: none; color: white; border-radius: 5px; font-size: 0.9em; }
    .btn-order { background-color: #007BFF; }
    .btn-revisit { background-color: #6c757d; }
    .finish-form { margin-top: 20px; text-align: center; }
    .finish-btn {
        padding: 10px 25px;
        background-color: #28a745;
        color: white;
        border-radius: 5px;
        font-size: 1.1em;
        border: none;
        cursor: pointer;
    }
</style>

<div class="doc-list-container">
    <h1>ðŸ“‹ Order Documents for Batch #{{ batch_id }}</h1>
    <p>This is the third step of the workflow. This page lists all documents that have multiple pages and may require manual ordering. Single-page documents are considered ordered by default.</p>

    <!-- Table listing all multi-page documents in the batch -->
    <table class="doc-list-table">
        <thead>
            <tr>
                <th>Document Name</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Loop through the documents passed from the Flask backend -->
            {% for doc in documents %}
            <tr>
                <td>{{ doc.document_name }}</td>
                <td>
                    <!-- Display the ordering status of the document -->
                    {% if doc.status == 'order_set' %}
                        <span style="color: green; font-weight: bold;">Order Set</span>
                    {% else %}
                        <span style="color: orange; font-weight: bold;">Pending Order</span>
                    {% endif %}
                </td>
                <td>
                    <!-- Provide a link to the ordering page for this specific document -->
                    {% if doc.status == 'order_set' %}
                        <form method="post" action="{{ url_for('manipulation.revisit_ordering_document', document_id=doc.id) }}" style="display:inline;">
                            <button type="submit" class="action-btn btn-revisit" onclick="event.stopPropagation();">Revisit Order</button>
                        </form>
                    {% else %}
                        <a href="{{ url_for('manipulation.order_single_document', document_id=doc.id) }}" class="action-btn btn-order">Order Pages</a>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <!-- This message is shown if there are no documents in the batch (or none that need ordering) -->
            <tr>
                <td colspan="3" style="text-align: center;">No multi-page documents require ordering in this batch.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Form to finish ordering and return to Batch Control -->
    <form class="finish-form" action="{{ url_for('manipulation.finish_ordering', batch_id=batch_id) }}" method="post">
        <button type="submit" class="finish-btn">Finish Ordering</button>
    </form>
    <script>
    // Intercept the document-level revisit order form submit to redirect to the correct document after POST
    document.querySelectorAll('form[action*="revisit_ordering_document"]').forEach(function(form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            var docId = form.action.split('/').pop();
            fetch(form.action, {method: 'POST'})
                .then(function() {
                    window.location.href = '/order/' + docId;
                });
        });
    });
    </script>
</div>
{% endblock %}
