{% extends 'base.html' %}
{% block title %}Order Pages{% endblock %}
{% block content %}
<style>
    /* --- FIX: New two-column layout styles --- */
    .main-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        align-items: start;
        max-width: 1600px;
        margin: auto;
    }
    .preview-pane {
        border: 1px solid #ccc;
        padding: 15px;
        background-color: white;
        border-radius: 5px;
        position: sticky;
        top: 20px; /* Makes the preview pane stick to the top on scroll */
    }
    .preview-wrapper {
        width: 100%;
        height: 80vh;
        border: 1px solid #ddd;
        background-color: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        color: #888;
    }
    .preview-wrapper img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    .order-pane {
        background-color: white;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    #sortable-pages {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        list-style-type: none;
        padding: 10px;
        border: 1px dashed #ccc;
        background-color: #f9f9f9;
        min-height: 200px;
    }
    .page-item {
        width: 150px;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
        text-align: center;
        cursor: grab;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s, transform 0.2s, border-color 0.2s;
    }
    .page-item.selected {
        border-color: #007BFF;
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.4);
    }
    .page-item:active {
        cursor: grabbing;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        transform: scale(1.05);
    }
    .page-item img {
        width: 100%;
        height: auto;
        border-bottom: 1px solid #eee;
        margin-bottom: 8px;
    }
    .page-info {
        font-size: 0.8em;
        color: #555;
        word-wrap: break-word;
    }
    .actions-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }
    .status-message { font-style: italic; color: #555; }
    .btn { display: inline-block; padding: 10px 20px; text-decoration: none; color: white; border-radius: 5px; border: none; font-size: 1em; cursor: pointer; margin-left: 10px; }
    .btn-save { background-color: #28a745; }
    .btn-cancel { background-color: #6c757d; }
    .btn-ai { background-color: #17a2b8; }
</style>

<div class="main-container">
    <div class="preview-pane">
        <h3>Page Preview</h3>
        <div class="preview-wrapper">
            <span id="preview-placeholder">Click a thumbnail on the right to see a larger preview.</span>
            <img id="preview-image" src="" alt="Page Preview" style="display: none;">
        </div>
    </div>

    <div class="order-pane">
        <h1>Reorder Pages</h1>
        <p>Click a page to preview it. Drag and drop pages to set the correct sequence.</p>

        <form id="order-form" action="{{ url_for('order_document_page', document_id=document_id) }}" method="post">
            <input type="hidden" id="page-order-input" name="page_order" value="">

            <ul id="sortable-pages">
                {% for page in pages %}
                <li class="page-item" data-id="{{ page.id }}" data-img-src="{{ url_for('serve_processed_file', filepath=page.relative_image_path) }}">
                    <img src="{{ url_for('serve_processed_file', filepath=page.relative_image_path) }}" alt="Page {{ page.page_number }}">
                    <div class="page-info">
                        <strong>Page ID: {{ page.id }}</strong><br>
                        ({{ page.source_filename }}, Pg {{ page.page_number }})
                    </div>
                </li>
                {% endfor %}
            </ul>

            <div class="actions-container">
                <p id="status-message" class="status-message"></p>
                <div class="actions">
                    <a href="{{ url_for('order_batch_page', batch_id=batch_id) }}" class="btn btn-cancel">Cancel</a>
                    <button type="button" id="suggest-order-btn" class="btn btn-ai">ü§ñ Suggest Order</button>
                    <button type="submit" class="btn btn-save">Save Order</button>
                </div>
            </div>
        </form>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sortableList = document.getElementById('sortable-pages');
        const pageOrderInput = document.getElementById('page-order-input');
        const suggestBtn = document.getElementById('suggest-order-btn');
        const statusMsg = document.getElementById('status-message');
        
        // --- FIX: Preview Pane Logic ---
        const previewImage = document.getElementById('preview-image');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        let selectedItem = null;

        function showPreview(pageItem) {
            // Update selected visual state
            if (selectedItem) {
                selectedItem.classList.remove('selected');
            }
            selectedItem = pageItem;
            selectedItem.classList.add('selected');

            const imgSrc = pageItem.dataset.imgSrc;
            if (imgSrc) {
                previewPlaceholder.style.display = 'none';
                previewImage.style.display = 'block';
                previewImage.src = imgSrc;
            }
        }

        // Add click listeners to all page items for previewing
        sortableList.querySelectorAll('.page-item').forEach(item => {
            item.addEventListener('click', () => showPreview(item));
        });

        // Show the first page by default
        const firstPage = sortableList.querySelector('.page-item');
        if (firstPage) {
            showPreview(firstPage);
        }

        function updatePageOrder() {
            const pageItems = sortableList.querySelectorAll('.page-item');
            const pageIds = Array.from(pageItems).map(item => item.dataset.id);
            pageOrderInput.value = pageIds.join(',');
        }

        const sortable = new Sortable(sortableList, {
            animation: 150,
            onEnd: function (evt) {
                updatePageOrder();
            }
        });

        updatePageOrder();

        suggestBtn.addEventListener('click', async function() {
            statusMsg.textContent = 'ü§ñ Getting AI suggestion...';
            suggestBtn.disabled = true;

            try {
                const response = await fetch(`/api/suggest_order/{{ document_id }}`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    const suggestedOrder = data.page_order;
                    const pageElements = new Map();
                    sortableList.querySelectorAll('.page-item').forEach(el => {
                        pageElements.set(el.dataset.id, el);
                    });

                    suggestedOrder.forEach(pageId => {
                        const pageElement = pageElements.get(String(pageId));
                        if (pageElement) {
                            sortableList.appendChild(pageElement);
                        }
                    });

                    updatePageOrder();
                    statusMsg.textContent = '‚úÖ Suggestion applied! Review and save.';
                } else {
                    statusMsg.textContent = `‚ùå Error: ${data.error}`;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                statusMsg.textContent = '‚ùå Error: Could not contact the server.';
            } finally {
                suggestBtn.disabled = false;
            }
        });
    });
</script>
{% endblock %}