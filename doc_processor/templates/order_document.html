{% extends 'base.html' %}

<!-- Sets the browser tab title for the page, indicating its purpose. -->
{% block title %}Order Pages for Document{% endblock %}

{% block head %}
    <!-- 
        Includes the SortableJS library from a Content Delivery Network (CDN).
        SortableJS is a lightweight JavaScript library that enables drag-and-drop reordering
        of elements in a list, which is crucial for the user interface on this page.
    -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
{% endblock %}

{% block content %}
<style>
    /* Main layout for the ordering page: a two-column grid. */
    .main-container {
        display: grid;
        grid-template-columns: 1fr 1fr; /* Creates two columns of equal width. */
        gap: 20px; /* Spacing between the grid columns. */
        align-items: start; /* Aligns items to the start of their grid area. */
        max-width: 1600px; /* Limits the maximum width for better readability on large screens. */
        margin: auto; /* Centers the container horizontally. */
    }

    /* The left pane, which contains the large image preview. */
    .preview-pane {
        border: 1px solid #ccc;
        padding: 15px;
        background-color: white;
        border-radius: 5px;
        position: sticky; /* Makes the preview pane stick to the top of the viewport when scrolling. */
        top: 20px; /* Distance from the top of the viewport when sticky. */
    }
    .preview-wrapper {
        width: 100%;
        height: 80vh; /* Occupies 80% of the viewport height for a large preview. */
        border: 1px solid #ddd;
        background-color: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        color: #888;
    }
    .preview-wrapper img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain; /* Ensures the entire image is visible within its container without cropping. */
    }

    /* The right pane, which contains the sortable page thumbnails. */
    .order-pane {
        background-color: white;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    #sortable-pages {
        display: flex;
        flex-wrap: wrap; /* Allows page items to wrap to the next line if space is limited. */
        gap: 15px; /* Spacing between individual page items. */
        list-style-type: none; /* Removes default list bullet points. */
        padding: 10px;
        border: 1px dashed #ccc; /* A dashed border to indicate a draggable area. */
        background-color: #f9f9f9;
        min-height: 200px; /* Ensures the area is visible even if empty. */
    }
    .page-item {
        width: 150px; /* Fixed width for each page thumbnail. */
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
        text-align: center;
        cursor: grab; /* Changes cursor to indicate the item is draggable. */
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s; /* Smooth transition for visual effects. */
    }
    .page-item.selected {
        border-color: #007BFF; /* Highlights the currently selected item. */
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.4);
    }
    .page-item:active {
        cursor: grabbing; /* Changes cursor while an item is being dragged. */
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        transform: scale(1.05); /* Slightly enlarges the item while dragging. */
    }
    .page-item img {
        width: 100%;
        height: auto;
        border-bottom: 1px solid #eee;
        margin-bottom: 8px;
    }
    .page-info { font-size: 0.8em; color: #555; word-wrap: break-word; }
    
    /* Container for the action buttons at the bottom of the page. */
    .actions-container { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
    .status-message { font-style: italic; color: #555; }
    .btn { 
        display: inline-block; 
        padding: 10px 20px; 
        text-decoration: none; 
        color: white; 
        border-radius: 5px; 
        border: none; 
        font-size: 1em; 
        cursor: pointer; 
        margin-left: 10px; 
        transition: background-color 0.2s; 
    }
    .btn-save { background-color: #28a745; } /* Green for save action. */
    .btn-cancel { background-color: #6c757d; } /* Grey for cancel action. */
    .btn-ai { background-color: #17a2b8; } /* Teal for AI suggestion button. */
</style>

<div class="main-container">
    <!-- Left Pane: Image Preview Area -->
    <div class="preview-pane">
        <h3>Page Preview</h3>
        <div class="preview-wrapper">
            <!-- Placeholder text displayed until a thumbnail is clicked. -->
            <span id="preview-placeholder">Click a thumbnail on the right to see a larger preview.</span>
            <!-- Image element where the selected page's image will be displayed. Initially hidden. -->
            <img id="preview-image" src="" alt="Page Preview" style="display: none;">
        </div>
    </div>

    <!-- Right Pane: Ordering Controls and Page Thumbnails -->
    <div class="order-pane">
        <h1>Reorder Pages</h1>
        <p>Click a page to preview it. Drag and drop pages to set the correct sequence.</p>

        <!-- The form that will submit the final page order to the backend. -->
        <form id="order-form" action="{{ url_for('order_document_page', document_id=document_id) }}" method="post">
            <!-- This hidden input field is crucial. It will be dynamically updated by JavaScript
                 to store the comma-separated list of page IDs in their current order. -->
            <input type="hidden" id="page-order-input" name="page_order" value="">

            <!-- The `<ul>` element that will contain the draggable page thumbnails.
                 SortableJS will be initialized on this element. -->
            <ul id="sortable-pages">
                {% for page in pages %}
                <!-- Each `<li>` represents a single page thumbnail. -->
                <li class="page-item" 
                    data-id="{{ page.id }}" 
                    data-img-src="{{ url_for('serve_processed_file', filepath=page.relative_image_path) }}">
                    <!-- Thumbnail image of the page. -->
                    <img src="{{ url_for('serve_processed_file', filepath=page.relative_image_path) }}" alt="Page {{ page.page_number }}">
                    <!-- Display basic information about the page. -->
                    <div class="page-info">
                        <strong>Page ID: {{ page.id }}</strong><br>
                        ({{ page.source_filename }}, Pg {{ page.page_number }})
                    </div>
                </li>
                {% endfor %}
            </ul>

            <!-- Container for the action buttons at the bottom of the form. -->
            <div class="actions-container">
                <!-- A paragraph to display status messages to the user (e.g., AI suggestion status). -->
                <p id="status-message" class="status-message"></p>
                <div class="actions">
                    <!-- Cancel button: redirects back to the batch ordering page without saving changes. -->
                    <a href="{{ url_for('order_batch_page', batch_id=batch_id) }}" class="btn btn-cancel">Cancel</a>
                    <!-- AI Suggest Order button: triggers an AJAX call to get an AI-suggested page order. -->
                    <button type="button" id="suggest-order-btn" class="btn btn-ai">🤖 Suggest Order</button>
                    <!-- Save Order button: submits the form with the current page order. -->
                    <button type="submit" class="btn btn-save">Save Order</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    // Ensures the script runs only after the entire HTML document has been loaded and parsed.
    document.addEventListener('DOMContentLoaded', function () {
        const sortableList = document.getElementById('sortable-pages');
        const pageOrderInput = document.getElementById('page-order-input');
        const suggestBtn = document.getElementById('suggest-order-btn');
        const statusMsg = document.getElementById('status-message');
        const previewImage = document.getElementById('preview-image');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        let selectedItem = null; // Tracks the currently selected page item for preview.

        // Function to display a page thumbnail in the large preview pane on the left.
        function showPreview(pageItem) {
            // Remove 'selected' class from previously selected item.
            if (selectedItem) {
                selectedItem.classList.remove('selected');
            }
            // Set the new selected item and add the 'selected' class.
            selectedItem = pageItem;
            selectedItem.classList.add('selected');

            const imgSrc = pageItem.dataset.imgSrc; // Get the image source from the data attribute.
            if (imgSrc) {
                previewPlaceholder.style.display = 'none'; // Hide the placeholder text.
                previewImage.style.display = 'block'; // Show the image element.
                previewImage.src = imgSrc; // Set the image source.
            }
        }

        // Add click listeners to all page items to trigger the preview function.
        sortableList.querySelectorAll('.page-item').forEach(item => {
            item.addEventListener('click', () => showPreview(item));
        });

        // Show the first page in the preview by default when the page loads.
        const firstPage = sortableList.querySelector('.page-item');
        if (firstPage) {
            showPreview(firstPage);
        }

        // Function to update the hidden input field (`page-order-input`) with the current order of page IDs.
        // This function is called whenever the order changes (e.g., after a drag-and-drop or AI suggestion).
        function updatePageOrder() {
            const pageItems = sortableList.querySelectorAll('.page-item');
            // Map each page item to its `data-id` attribute to get a list of IDs in the current order.
            const pageIds = Array.from(pageItems).map(item => item.dataset.id);
            pageOrderInput.value = pageIds.join(','); // Join the IDs with commas for submission.
        }

        // Initialize the SortableJS library on the `sortableList` (the `<ul>` element).
        const sortable = new Sortable(sortableList, {
            animation: 150, // Defines the animation speed in milliseconds when items are reordered.
            onEnd: function (evt) {
                // `onEnd` is a callback function that fires when a drag-and-drop operation is completed.
                updatePageOrder(); // Update the hidden input with the new order.
            }
        });

        // Set the initial order in the hidden input when the page first loads.
        updatePageOrder();

        // Event listener for the "Suggest Order" button.
        suggestBtn.addEventListener('click', async function() {
            statusMsg.textContent = '🤖 Getting AI suggestion...'; // Provide immediate feedback to the user.
            suggestBtn.disabled = true; // Disable the button to prevent multiple clicks while processing.

            try {
                // Make an asynchronous API call (POST request) to the backend to get the AI's suggested order.
                const response = await fetch(`/api/suggest_order/{{ document_id }}`, {
                    method: 'POST'
                });
                const data = await response.json(); // Parse the JSON response from the server.
                if (data.success) {
                    const suggestedOrder = data.page_order; // Get the list of suggested page IDs.
                    const pageElements = new Map();
                    // Create a map to quickly look up HTML elements by their page ID.
                    sortableList.querySelectorAll('.page-item').forEach(el => {
                        pageElements.set(el.dataset.id, el);
                    });

                    // Re-append the HTML elements to the `sortableList` in the new suggested order.
                    // This visually reorders the thumbnails on the page.
                    suggestedOrder.forEach(pageId => {
                        const pageElement = pageElements.get(String(pageId));
                        if (pageElement) {
                            sortableList.appendChild(pageElement);
                        }
                    });

                    updatePageOrder(); // Update the hidden input with the new order.
                    statusMsg.textContent = '✅ Suggestion applied! Review and save.'; // Success message.
                } else {
                    statusMsg.textContent = `❌ Error: ${data.error}`; // Display error message from the backend.
                }
            } catch (error) {
                console.error('Fetch error:', error); // Log any network or parsing errors.
                statusMsg.textContent = '❌ Error: Could not contact the server.'; // Generic error message for the user.
            } finally {
                suggestBtn.disabled = false; // Re-enable the button after the operation completes (success or failure).
            }
        });
    });
</script>
{% endblock %}