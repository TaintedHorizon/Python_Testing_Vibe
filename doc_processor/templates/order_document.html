{% extends 'base.html' %}

{% block title %}Order Pages for Document{% endblock %}

{% block head %}
    <!-- Include the SortableJS library from a CDN for drag-and-drop functionality -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
{% endblock %}

{% block content %}
<style>
    /* Main layout for the ordering page: a two-column grid */
    .main-container {
        display: grid;
        grid-template-columns: 1fr 1fr; /* Two equal columns */
        gap: 20px;
        align-items: start;
        max-width: 1600px;
        margin: auto;
    }

    /* The left pane, which contains the large image preview */
    .preview-pane {
        border: 1px solid #ccc;
        padding: 15px;
        background-color: white;
        border-radius: 5px;
        position: sticky; /* The preview will "stick" to the top of the screen on scroll */
        top: 20px;
    }
    .preview-wrapper {
        width: 100%;
        height: 80vh; /* Takes up most of the viewport height */
        border: 2px solid #007BFF;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        color: #6c757d;
        border-radius: 8px;
        position: relative;
    }
    .pdf-placeholder {
        color: #6c757d;
        text-align: center;
        padding: 40px;
    }

    /* The right pane, which contains the sortable page thumbnails */
    .order-pane {
        background-color: white;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    #sortable-pages {
        display: flex;
        flex-wrap: wrap; /* Allows items to wrap to the next line */
        gap: 15px;
        list-style-type: none;
        padding: 10px;
        border: 1px dashed #ccc;
        background-color: #f9f9f9;
        min-height: 200px;
    }
    .page-item {
        width: 150px;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        background-color: #fff;
        text-align: center;
        cursor: grab; /* Indicates the item is draggable */
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s;
    }
    .page-item.selected {
        border-color: #007BFF; /* Highlight the selected item */
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.4);
    }
    .page-item:active {
        cursor: grabbing; /* Change cursor while dragging */
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        transform: scale(1.05);
    }
    .page-item img {
        width: 100%;
        height: auto;
        border-bottom: 1px solid #eee;
        margin-bottom: 8px;
    }
    .page-info { font-size: 0.8em; color: #555; word-wrap: break-word; }
    
    /* Container for the action buttons at the bottom */
    .actions-container { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
    .status-message { font-style: italic; color: #555; }
    .btn { display: inline-block; padding: 10px 20px; text-decoration: none; color: white; border-radius: 5px; border: none; font-size: 1em; cursor: pointer; margin-left: 10px; }
    .btn-save { background-color: #28a745; }
    .btn-cancel { background-color: #6c757d; }
    .btn-ai { background-color: #17a2b8; }
</style>

<div class="main-container">
    <!-- Left Pane: Image Preview -->
    <div class="preview-pane">
        <h3>Page Preview</h3>
        <div class="preview-wrapper">
            <span id="preview-placeholder">Click a thumbnail on the right to see a larger preview.</span>
            <iframe id="preview-pdf" src="" width="100%" height="100%" 
                    style="border: none; display: none;">
                <div class="pdf-placeholder">
                    <h4>üìÑ Document Preview</h4>
                    <p>PDF viewer not supported.</p>
                </div>
            </iframe>
        </div>
    </div>

    <!-- Right Pane: Ordering Controls -->
    <div class="order-pane">

        <h1>Reorder Pages</h1>
        <p>Click a page to preview it. Drag and drop pages to set the correct sequence.</p>
        <div style="margin-bottom: 18px; display: flex; align-items: center; gap: 18px;">
            <label for="filename-input" style="font-size:1.1em; font-weight:normal;">Filename:&nbsp;</label>
            <input type="text" id="filename-input" name="filename" value="{{ suggested_filename or '' }}" style="font-size:1.1em; width: 380px; padding: 4px 8px; border: 1.5px solid #007BFF; border-radius: 4px; color:#222; font-weight:bold;">
            <button type="button" id="suggest-name-btn" class="btn btn-ai"{{ testid('order-suggest-name') }}>ü§ñ Suggest Name</button>
            <button type="button" id="apply-name-btn" class="btn btn-save"{{ testid('order-apply-name') }}>Apply Name</button>
            <button type="button" id="revert-name-btn" class="btn btn-cancel" style="display:none;"{{ testid('order-revert-name') }}>Revert</button>
        </div>

        <!-- The form that will submit the final page order -->
        <form id="order-form" action="{{ url_for('manipulation.order_single_document', document_id=document_id) }}" method="post">
            <!-- This hidden input will store the comma-separated list of page IDs in the correct order -->
            <input type="hidden" id="page-order-input" name="page_order" value="">

            <!-- The container for the draggable page thumbnails -->
            <ul id="sortable-pages">
                {% for page in pages %}
                <li class="page-item" data-id="{{ page.id }}" data-img-src="{{ url_for('export.serve_processed_file', filepath=page.relative_image_path) }}">
                    <img src="{{ url_for('export.serve_processed_file', filepath=page.relative_image_path) }}" alt="Page {{ page.page_number }}">
                    <div class="page-info">
                        <strong>Page ID: {{ page.id }}</strong><br>
                        ({{ page.source_filename }}, Pg {{ page.page_number }})
                    </div>
                </li>
                {% endfor %}
            </ul>

            <!-- Action buttons at the bottom of the page -->
            <div class="actions-container">
                <p id="status-message" class="status-message"></p>
                <div class="actions">
                    <a href="{{ url_for('manipulation.order_documents', batch_id=batch_id) }}" class="btn btn-cancel"{{ testid('order-cancel') }}>Cancel</a>
                    <button type="button" id="suggest-order-btn" class="btn btn-ai"{{ testid('order-suggest-order') }}>ü§ñ Suggest Order</button>
                    <button type="submit" class="btn btn-save"{{ testid('order-finish-reordering') }}>Finish Reordering</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- SUGGEST NAME LOGIC ---
        const filenameInput = document.getElementById('filename-input');
        const suggestNameBtn = document.getElementById('suggest-name-btn');
        const revertNameBtn = document.getElementById('revert-name-btn');
    let originalName = filenameInput.value;
    const applyNameBtn = document.getElementById('apply-name-btn');
        applyNameBtn.addEventListener('click', async function() {
            const newName = filenameInput.value.trim();
            if (!newName) { alert('Name cannot be empty.'); return; }
            applyNameBtn.disabled = true;
            try {
                const resp = await fetch('/api/apply_name/{{ document_id }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: newName })
                });
                const data = await resp.json();
                if (data.success) {
                    originalName = newName;
                    revertNameBtn.style.display = 'none';
                    alert('Name updated!');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (e) {
                alert('Network error.');
            } finally {
                applyNameBtn.disabled = false;
            }
        });
        suggestNameBtn.addEventListener('click', async function() {
            suggestNameBtn.disabled = true;
            const prev = filenameInput.value;
            filenameInput.value = 'Suggesting...';
            try {
                const response = await fetch(`/api/suggest_name/{{ document_id }}`, {method: 'POST'});
                const data = await response.json();
                if (data.success) {
                    filenameInput.value = data.suggested_name;
                    revertNameBtn.style.display = '';
                } else {
                    filenameInput.value = prev;
                    alert('AI error: ' + data.error);
                }
            } catch (e) {
                filenameInput.value = prev;
                alert('Network error.');
            } finally {
                suggestNameBtn.disabled = false;
            }
        });
        revertNameBtn.addEventListener('click', function() {
            filenameInput.value = originalName;
            revertNameBtn.style.display = 'none';
        });
        const sortableList = document.getElementById('sortable-pages');
        const pageOrderInput = document.getElementById('page-order-input');
    const suggestBtn = document.getElementById('suggest-order-btn');
        const statusMsg = document.getElementById('status-message');
        const previewPdf = document.getElementById('preview-pdf');
        const previewPlaceholder = document.getElementById('preview-placeholder');
        let selectedItem = null;

        // Function to display a page thumbnail in the large preview pane.
        function showPreview(pageItem) {
            if (selectedItem) {
                selectedItem.classList.remove('selected');
            }
            selectedItem = pageItem;
            selectedItem.classList.add('selected');

            // Extract source filename from the page info (assuming format: "(filename, Pg X)")
            const pageInfo = pageItem.querySelector('.page-info').textContent;
            const filenameMatch = pageInfo.match(/\(([^,]+),/);
            if (filenameMatch) {
                const sourceFilename = filenameMatch[1];
                previewPlaceholder.style.display = 'none';
                previewPdf.style.display = 'block';
                previewPdf.src = `/export/original_pdf/${sourceFilename}`;
            }
        }

        // Add click listeners to all page items to trigger the preview.
        sortableList.querySelectorAll('.page-item').forEach(item => {
            item.addEventListener('click', () => showPreview(item));
        });

        // Show the first page in the preview by default when the page loads.
        const firstPage = sortableList.querySelector('.page-item');
        if (firstPage) {
            showPreview(firstPage);
        }

        // Function to update the hidden input with the current order of page IDs.
        function updatePageOrder() {
            const pageItems = sortableList.querySelectorAll('.page-item');
            const pageIds = Array.from(pageItems).map(item => item.dataset.id);
            pageOrderInput.value = pageIds.join(',');
        }

        // Initialize the SortableJS library on the list of pages.
        const sortable = new Sortable(sortableList, {
            animation: 150, // Animation speed in ms
            onEnd: function (evt) {
                // When the user finishes dragging, update the hidden input.
                updatePageOrder();
            }
        });

        // Set the initial order in the hidden input when the page loads.
        updatePageOrder();

        // Event listener for the "Suggest Order" button.
        suggestBtn.addEventListener('click', async function() {
            statusMsg.textContent = 'ü§ñ Getting AI suggestion...';
            suggestBtn.disabled = true;
            try {
                // Make an API call to the backend to get the AI's suggestion.
                const response = await fetch(`/api/suggest_order/{{ document_id }}`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.success) {
                    const suggestedOrder = data.page_order;
                    const pageElements = new Map();
                    // Create a map of page ID to its HTML element for easy lookup.
                    sortableList.querySelectorAll('.page-item').forEach(el => {
                        pageElements.set(el.dataset.id, el);
                    });
                    // Re-append the elements to the list in the new suggested order.
                    suggestedOrder.forEach(pageId => {
                        const pageElement = pageElements.get(String(pageId));
                        if (pageElement) {
                            sortableList.appendChild(pageElement);
                        }
                    });
                    updatePageOrder(); // Update the hidden input with the new order.
                    statusMsg.textContent = '‚úÖ Suggestion applied! Review and save.';
                } else {
                    statusMsg.textContent = `‚ùå Error: ${data.error}`;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                statusMsg.textContent = '‚ùå Error: Could not contact the server.';
            } finally {
                suggestBtn.disabled = false;
            }
        });
    });
</script>
{% endblock %}
