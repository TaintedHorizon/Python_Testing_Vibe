{% extends 'base.html' %}

{% block title %}Review Batch {{ batch_id }}{% endblock %}

{% block content %}
<style>
    /* Main layout for the review page */
    .container { display: flex; gap: 20px; align-items: flex-start; }
    .image-pane { flex: 1; text-align: center; position: sticky; top: 20px; /* Makes the image pane stick while scrolling */ }
    .image-wrapper { width: 100%; height: 80vh; border: 1px solid #ccc; background-color: #f0f0f0; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .image-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.2s; }
    .info-pane { flex: 1; }
    
    /* General styling for UI elements */
    .info-box { background-color: white; border: 1px solid #ccc; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
    .ocr-text { max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-top: 10px; background-color: #f9f9f9; }
    .ocr-text pre { white-space: pre-wrap; word-wrap: break-word; }
    .form-group { margin-bottom: 15px; }
    .actions { display: flex; gap: 10px; margin-top: 20px; }
    .actions button, .actions .btn-delete { flex: 1; padding: 10px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 1em; text-align: center; }
    .btn-correct { background-color: #007BFF; }
    .btn-delete { background-color: #dc3545; display: inline-block; text-decoration: none; }
    .page-separator { margin-top: 30px; margin-bottom: 30px; border-top: 2px solid #eee; }
    .ocr-actions { text-align: center; margin-top: 15px; }
    .btn-ocr { background-color: #ffc107; color: black; font-weight: bold; padding: 12px 25px; font-size: 1.1em; border: none; border-radius: 5px; cursor: pointer; }
    .btn-ocr:disabled { background-color: #6c757d; color: white; cursor: not-allowed; }
</style>

<h1>üîç Review Flagged Pages for Batch #{{ batch_id }}</h1>
<p>This page lists all pages that were flagged for manual review. You can correct their category, re-run OCR with rotation, or delete them.</p>
<hr>

<!-- Loop through each page that was flagged in this batch -->
{% for page in flagged_pages %}
<div class="container">
    <!-- Left Pane: Image and Rotation Controls -->
    <div class="image-pane">
        <h4>Source: {{ page.source_filename }}, Page {{ page.page_number }} (DB ID: {{ page.id }})</h4>
        <div class="image-wrapper">
            <img id="pageImage_{{ page.id }}" src="{{ url_for('export.serve_processed_file', filepath=page.relative_image_path) }}?v={{ page.rotation_angle or 0 }}" alt="Scanned page">
        </div>
        <div class="rotate-buttons">
            <button type="button" onclick="rotateImage({{ page.id }}, -90)">Rotate Left ‚Ü∫</button>
            <button type="button" onclick="rotateImage({{ page.id }}, 90)">Rotate Right ‚Üª</button>
            <button type="button" class="confirm-rotation-btn" data-pageid="{{ page.id }}" style="margin-left:10px; background:#17a2b8; color:white; border:none; border-radius:5px; padding:8px 16px; cursor:pointer;">Confirm Rotation</button>
            <span id="rotation-confirm-msg-{{ page.id }}" style="margin-left:10px; color:#28a745; display:none; font-weight:bold;">Rotation saved!</span>
        </div>
    </div>

    <!-- Right Pane: Information and Actions -->
    <div class="info-pane">
        <!-- Box for correcting the category -->
        <div class="info-box">
            <form action="{{ url_for('manipulation.update_page') }}" method="post">
                <input type="hidden" id="action-input_{{ page.id }}" name="action" value="save">
                <input type="hidden" name="current_page_num" value="1">
                <input type="hidden" name="total_pages" value="1">
                <p><strong>Reason for Flag:</strong> AI Suggestion was '{{ page.ai_suggested_category }}', but page was manually flagged.</p>
                <hr>
                <!-- Hidden inputs to send page context back to the server -->
                <input type="hidden" name="page_id" value="{{ page.id }}">
                <input type="hidden" name="batch_id" value="{{ batch_id }}">
                <input type="hidden" id="rotation-input_{{ page.id }}" name="rotation" value="{{ page.rotation_angle or 0 }}">
                
                <!-- Category selection dropdown -->
                <div class="form-group">
                    <label for="category-select_{{ page.id }}">Correct Category:</label>
                    <select id="category-select_{{ page.id }}" name="category_dropdown">
                        <option value="" disabled selected>-- Choose a new category --</option>
                        {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                        <option value="other_new">Other (Create New)...</option>
                    </select>
                </div>
                <!-- Input field for creating a new category, hidden by default -->
                <div class="form-group" id="other-category-group_{{ page.id }}" style="display:none;">
                    <label for="other-category-input_{{ page.id }}">New Category Name</label>
                    <input type="text" id="other-category-input_{{ page.id }}" name="other_category">
                </div>
                <div class="actions">
                                        <button type="submit" data-action="save" class="btn-approve">‚úÖ Approve Changes</button>
                    <button type="submit" data-action="keep-flagged" class="btn-flag">üö© Keep Flagged</button>
                </div>
            </form>
        </div>

        <!-- Box for OCR text and actions -->
        <div class="info-box">
            <h3>üìÑ Extracted OCR Text</h3>
            <div class="ocr-text"><pre>{{ page.ocr_text }}</pre></div>
            
            <!-- Form to re-run OCR on this page -->
            <div class="ocr-actions">
                <form id="ocr-form-{{ page.id }}" action="{{ url_for('manipulation.rerun_ocr') }}" method="post" onsubmit="return handleOcrSubmit(this)">
                    <input type="hidden" name="page_id" value="{{ page.id }}">
                    <input type="hidden" name="batch_id" value="{{ batch_id }}">
                    <input type="hidden" id="rotation-rerun_{{ page.id }}" name="rotation" value="{{ page.rotation_angle or 0 }}">
                    <button type="submit" class="btn-ocr">Re-Run OCR with Rotation</button>
                </form>
            </div>
            
            <hr>
            <!-- Form to permanently delete the page -->
            <form action="{{ url_for('manipulation.delete_page', page_id=page.id) }}" method="post" onsubmit="return confirm('Are you sure you want to permanently delete this page? This cannot be undone.');">
                 <input type="hidden" name="batch_id" value="{{ batch_id }}">
                <button type="submit" class="actions btn-delete" style="width:100%;">Delete Page</button>
            </form>
        </div>
    </div>
</div>
<!-- Add a separator between each page entry, but not after the last one -->
{% if not loop.last %}
    <div class="page-separator"></div>
{% endif %}
{% endfor %}
<hr>
<div style="text-align: center; margin-top: 20px;">
    <a href="{{ url_for('batch.batch_control') }}" class="action-btn" style="background-color: #28a745; padding: 15px 30px; font-size: 1.2em;">Finish Review</a>
</div>

<script>
    // Store the initial rotation for each page in a JavaScript object for easy access.
    let rotations = {};
    {% for page in flagged_pages %}
        rotations[{{ page.id }}] = {{ page.rotation_angle or 0 }};
    {% endfor %}

    // Function to handle client-side image rotation.
    function rotateImage(pageId, degrees) {
        rotations[pageId] = (rotations[pageId] + 360 + degrees) % 360;
        document.getElementById('pageImage_' + pageId).style.transform = `rotate(${rotations[pageId]}deg)`;
        // Update the hidden input fields so the rotation value is sent with form submissions.
        document.getElementById('rotation-input_' + pageId).value = rotations[pageId];
        document.getElementById('rotation-rerun_' + pageId).value = rotations[pageId];
    }
    
    // Provides user feedback when re-running OCR.
    function handleOcrSubmit(form) {
        if (confirm('Re-running OCR can be slow. Are you sure?')) {
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Processing...';
            return true; // Proceed with form submission.
        }
        return false; // Cancel submission.
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Ensure the correct action is always sent for each page's form
        document.querySelectorAll('.actions button.btn-correct').forEach(btn => {
            btn.addEventListener('click', function(e) {
                const pageId = this.closest('form').querySelector('input[name="page_id"]').value;
                const actionInput = document.getElementById('action-input_' + pageId);
                if (actionInput) actionInput.value = this.getAttribute('data-action');
            });
        });
        // Apply the initial rotation to all images and hidden inputs when the page loads.
        for (const pageId in rotations) {
            const angle = rotations[pageId];
            const imageElement = document.getElementById('pageImage_' + pageId);
            if (imageElement) {
                imageElement.style.transform = `rotate(${angle}deg)`;
            }
            const rotationInput = document.getElementById('rotation-input_' + pageId);
            if (rotationInput) {
                rotationInput.value = angle;
            }
        }
        // Confirm Rotation AJAX handler (event delegation)
        document.querySelectorAll('.confirm-rotation-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const pageId = this.getAttribute('data-pageid');
                const batchId = document.querySelector('input[name="batch_id"]').value;
                const rotationInput = document.getElementById('rotation-input_' + pageId);
                const rotation = rotationInput ? rotationInput.value : 0;
                const confirmMsg = document.getElementById('rotation-confirm-msg-' + pageId);
                btn.disabled = true;
                fetch("/update_rotation", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ page_id: pageId, batch_id: batchId, rotation: rotation })
                })
                .then(resp => resp.json())
                .then(data => {
                    if (data.success) {
                        if (confirmMsg) {
                            confirmMsg.style.display = 'inline';
                            setTimeout(() => { confirmMsg.style.display = 'none'; }, 1500);
                        }
                    }
                })
                .finally(() => { btn.disabled = false; });
            });
        });

        // Add event listeners to the category dropdowns to show/hide the "Other" text input.
        const selects = document.querySelectorAll('select[name="category_dropdown"]');
        selects.forEach(select => {
            select.addEventListener('change', function() {
                const pageId = this.id.split('_')[1];
                const otherGroup = document.getElementById('other-category-group_' + pageId);
                if (otherGroup) {
                    otherGroup.style.display = (this.value === 'other_new') ? 'block' : 'none';
                }
            });
        });
    });
</script>
{% endblock %}
