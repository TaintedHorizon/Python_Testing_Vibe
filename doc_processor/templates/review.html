{% extends 'base.html' %}
{% block title %}Review Queue for Batch {{ batch_id }}{% endblock %}
{% block content %}
<style>
    .container { display: flex; gap: 20px; align-items: flex-start; }
    .image-pane { flex: 1; text-align: center; }
    .image-wrapper {
        width: 100%;
        height: 80vh;
        border: 1px solid #ccc;
        background-color: #f0f0f0;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    .image-wrapper img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain; /* This is the key fix */
        transition: transform 0.2s;
    }
    .info-pane { flex: 1; }
    /* ... (rest of the styles are the same) ... */
    .pagination { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .pagination a, .pagination span { padding: 10px 20px; text-decoration: none; border: 1px solid #ddd; background-color: #007BFF; color: white; border-radius: 5px; }
    .pagination span { background-color: #6c757d; }
    .info-box { background-color: white; border: 1px solid #ccc; padding: 20px; border-radius: 5px; }
    .ocr-text { max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-top: 10px; background-color: #f9f9f9; }
    .ocr-text pre { white-space: pre-wrap; word-wrap: break-word; }
    .form-group { margin-bottom: 15px; }
    .actions button { padding: 10px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 1em; }
    .btn-save { background-color: #28a745; width: 100%; }
    .btn-rerun { background-color: #ffc107; color: black; width: 100%; }
    .btn-delete { background-color: #dc3545; width: 100%; }
    #action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
</style>

<h1>Review Queue for Batch #{{ batch_id }}</h1>
{% if flagged_pages %}
    {% set total_flagged = flagged_pages|length %}{% set page_num = request.args.get('page', 1, type=int) %}{% if page_num > total_flagged %}{% set page_num = total_flagged %}{% endif %}{% if page_num < 1 %}{% set page_num = 1 %}{% endif %}{% set current_page = flagged_pages[page_num - 1] %}
    <div class="pagination">
        {% if page_num > 1 %}<a href="{{ url_for('review_batch_page', batch_id=batch_id, page=page_num - 1) }}">&laquo; Previous Flagged</a>{% else %}<span>&laquo; Previous Flagged</span>{% endif %}
        <strong>Reviewing Flagged Page {{ page_num }} of {{ total_flagged }}</strong>
        {% if page_num < total_flagged %}<a href="{{ url_for('review_batch_page', batch_id=batch_id, page=page_num + 1) }}">Next Flagged &raquo;</a>{% else %}<span>Next Flagged &raquo;</span>{% endif %}
    </div>
    <div class="container">
        <div class="image-pane">
            <div class="image-wrapper">
                <img id="pageImage" src="{{ url_for('serve_processed_file', filepath=current_page.relative_image_path) }}" alt="Scanned page">
            </div>
            <div class="rotate-buttons"><button onclick="rotateImage(-90)">Rotate Left â†º</button><button onclick="rotateImage(90)">Rotate Right â†»</button></div>
        </div>
        <div class="info-pane">
            <div class="info-box">
                <h3>Resolve Flagged Page ID: {{ current_page.id }}</h3><p><strong>Original File:</strong> {{ current_page.source_filename }} (Page {{ current_page.page_number }})</p><hr>
                <form action="{{ url_for('update_page') }}" method="post" id="manual-correction-form" style="margin-bottom: 20px;">
                    <input type="hidden" name="page_id" value="{{ current_page.id }}"><input type="hidden" name="batch_id" value="{{ batch_id }}"><input type="hidden" name="action" value="correct"><input type="hidden" id="manual-rotation-input" name="rotation" value="{{ current_page.rotation_angle or 0 }}">
                    <div class="form-group"><label><strong>1. Manual Correction:</strong></label><select name="category_dropdown" id="category-select"><option value="" disabled selected>-- Choose a category --</option>{% for cat in categories %}<option value="{{ cat }}">{{ cat }}</option>{% endfor %}<option value="other_new">Other (Create New)...</option></select><input type="text" name="other_category" id="other-category-input" placeholder="New category name" style="display:none; margin-top: 5px;"></div>
                    <button type="submit" class="btn-save">Save Correction & Resolve</button>
                </form>
                <hr style="margin: 20px 0;"><label><strong>2. Other Actions:</strong></label>
                <div id="action-grid">
                    <form action="{{ url_for('rerun_ocr_action') }}" method="post" onsubmit="this.querySelector('button').disabled = true; this.querySelector('button').innerText = 'Re-running OCR...';"><input type="hidden" name="page_id" value="{{ current_page.id }}"><input type="hidden" name="batch_id" value="{{ batch_id }}"><input type="hidden" id="rerun-rotation-input" name="rotation" value="{{ current_page.rotation_angle or 0 }}"><button type="submit" class="btn-rerun">Re-run OCR</button></form>
                    <form action="{{ url_for('delete_page_action', page_id=current_page.id) }}" method="post" onsubmit="return confirm('Are you sure you want to permanently delete this page?');"><input type="hidden" name="batch_id" value="{{ batch_id }}"><button type="submit" class="btn-delete">Delete Page</button></form>
                </div>
            </div>
            <div class="info-box" style="margin-top: 20px;">
                <h3>Current OCR Text (May be incorrect)</h3>
                <div class="ocr-text"><pre>{{ current_page.ocr_text }}</pre></div>
            </div>
        </div>
    </div>
{% else %}
    <h1>Review Queue for Batch #{{ batch_id }}</h1>
    <p style="font-size: 1.2em; color: green;">ðŸŽ‰ Excellent! There are no flagged pages to review in this batch.</p><p>You are ready to proceed to Document Grouping.</p>
{% endif %}
<script>
    // SIMPLIFIED SCRIPT
    let currentRotation = 0;
    const rotationInput = document.getElementById('manual-rotation-input') || document.getElementById('rerun-rotation-input');
    const pageImage = document.getElementById('pageImage');

    function rotateImage(degrees) {
        currentRotation = (currentRotation + 360 + degrees) % 360;
        if (document.getElementById('manual-rotation-input')) document.getElementById('manual-rotation-input').value = currentRotation;
        if (document.getElementById('rerun-rotation-input')) document.getElementById('rerun-rotation-input').value = currentRotation;
        if (pageImage) pageImage.style.transform = `rotate(${currentRotation}deg)`;
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (rotationInput) { currentRotation = parseInt(rotationInput.value) || 0; }
        if (pageImage) { pageImage.style.transform = `rotate(${currentRotation}deg)`; }
        
        const categorySelect = document.getElementById('category-select');
        const otherCategoryInput = document.getElementById('other-category-input');
        if (categorySelect) {
            categorySelect.addEventListener('change', function() { if (otherCategoryInput) { otherCategoryInput.style.display = (this.value === 'other_new') ? 'block' : 'none'; } });
        }
    });
</script>
{% endblock %}