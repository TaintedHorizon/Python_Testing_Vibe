{% extends 'base.html' %}

{% block title %}Revisiting Batch {{ batch_id }}{% endblock %}

{% block content %}
<style>
    /* Styles are largely copied from verify.html for a consistent look and feel */
    .container { display: flex; gap: 20px; align-items: flex-start; }
    .image-pane { flex: 1; text-align: center; position: sticky; top: 20px; }
    .pdf-viewer { width: 100%; height: 80vh; border: 2px solid #007BFF; background-color: #f8f9fa; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; border-radius: 8px; position: relative; }
    .pdf-placeholder { color: #6c757d; text-align: center; padding: 40px; }
    .info-pane { flex: 1; }
    .pagination { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .pagination a, .pagination span { padding: 10px 20px; text-decoration: none; border: 1px solid #ddd; background-color: #007BFF; color: white; border-radius: 5px; }
    .pagination span { background-color: #6c757d; }
    .info-box { background-color: white; border: 1px solid #ccc; padding: 20px; border-radius: 5px; }
    .ocr-text { max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-top: 10px; background-color: #f9f9f9; }
    .ocr-text pre { white-space: pre-wrap; word-wrap: break-word; }
    .form-group { margin-bottom: 15px; }
    .actions { display: flex; gap: 10px; margin-top: 20px; }
    .actions button { flex: 1; padding: 10px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 1em; }
    .btn-correct { background-color: #007BFF; }
    .btn-flag { background-color: #dc3545; }
    .rotate-buttons { margin-top: 10px; }
</style>

<h1>Revisiting Batch #{{ batch_id }} <span style="font-size: 0.6em; color: #666;">(Status: {{ batch.status }})</span></h1>
<p>This is a read-only view of the pages in this batch. You can review the verified categories and make corrections if needed.</p>

<!-- Pagination controls to navigate between pages -->
<div class="pagination">
    {% if current_page_num > 1 %}
        <a href="{{ url_for('manipulation.revisit_batch', batch_id=batch_id, page=current_page_num - 1) }}"{{ testid('revisit-prev') }}>&laquo; Previous Page</a>
    {% else %}
        <span{{ testid('revisit-prev-disabled') }}>&laquo; Previous Page</span>
    {% endif %}
    <strong>Page {{ current_page_num }} of {{ total_pages }}</strong>
    {% if current_page_num < total_pages %}
        <a href="{{ url_for('manipulation.revisit_batch', batch_id=batch_id, page=current_page_num + 1) }}"{{ testid('revisit-next') }}>Next Page &raquo;</a>
    {% else %}
        <!-- On the last page, the "Next" button becomes a "Finish" button -->
        <a href="{{ url_for('batch.batch_control') }}" style="background-color: #17a2b8;"{{ testid('revisit-finish') }}>Finish Revisiting</a>
    {% endif %}
</div>

<div class="container">
    <!-- Left Pane: Image and Rotation -->
    <div class="image-pane">
        <div class="pdf-viewer">
            {% if current_page.original_pdf_path %}
                <iframe src="{{ url_for('export.serve_original_pdf', filename=current_page.original_filename) }}" 
                        width="100%" height="100%" 
                        style="border: none;">
                    <div class="pdf-placeholder">
                        <h4>üìÑ {{ current_page.original_filename }}</h4>
                        <p>PDF viewer not supported.<br>
                        <a href="{{ url_for('export.serve_original_pdf', filename=current_page.original_filename) }}" target="_blank">Open in new tab</a></p>
                    </div>
                </iframe>
            {% else %}
                <div class="pdf-placeholder">
                    <h4>üìÑ {{ current_page.original_filename }}</h4>
                    <p>PDF file not available</p>
                </div>
            {% endif %}
        </div>
        <div class="rotate-buttons">
            <button type="button" onclick="rotateDocument({{ current_page.id }}, -90)"{{ testid('rotate-left') }}>‚Ü∫ Rotate Left</button>
            <button type="button" onclick="rotateDocument({{ current_page.id }}, 90)"{{ testid('rotate-right') }}>‚Üª Rotate Right</button>
            <button type="button" onclick="resetRotation({{ current_page.id }})"{{ testid('rotate-reset') }}>üîÑ Reset</button>
            <button type="button" onclick="cycleFitModeFor({{ current_page.id }}, this)"{{ testid('fit-mode') }}>üñºÔ∏è Fit: Auto</button>
            <button type="button" id="apply-rotation-{{ current_page.id }}" onclick="applyRotation({{ current_page.id }})" style="display:none;background:#28a745;"{{ testid('apply-rotation-'+current_page.id|string) }}>‚úÖ Apply Rotation</button>
        </div>
    </div>

    <!-- Right Pane: Information and Actions -->
    <div class="info-pane">
        <form id="correction-form" action="{{ url_for('manipulation.update_page') }}" method="post">
            <!-- Hidden fields to pass context to the server on form submission -->
            <input type="hidden" name="page_id" value="{{ current_page.id }}">
            <input type="hidden" name="batch_id" value="{{ batch_id }}">
            <input type="hidden" name="current_page_num" value="{{ current_page_num }}">
            <input type="hidden" name="total_pages" value="{{ total_pages }}">
            <input type="hidden" id="rotation-input" name="rotation" value="{{ current_page.rotation_angle or 0 }}">
            <input type="hidden" name="ai_suggestion" value="{{ current_page.ai_suggested_category }}">
            
            <div class="info-box">
                <p><strong>Current Verified Category:</strong><br>{{ current_page.human_verified_category or 'N/A' }}</p>
                <hr>
                <div class="form-group">
                    <label for="category-select">Make a Correction:</label>
                    <select id="category-select" name="category_dropdown">
                        <option value="" disabled selected>-- Choose a new category --</option>
                        {% for cat in categories %}<option value="{{ cat }}">{{ cat }}</option>{% endfor %}
                        <option value="other_new">Other (Create New)...</option>
                    </select>
                </div>
                <div class="form-group" id="other-category-group" style="display:none;">
                    <label for="other-category-input">New Category Name</label>
                    <input type="text" id="other-category-input" name="other_category">
                </div>
                <div class="actions">
                    <button type="submit" name="action" value="correct" class="btn-correct"{{ testid('revisit-save-change') }}>Save Change</button>
                    <button type="submit" name="action" value="flag" class="btn-flag"{{ testid('revisit-flag-review') }}>Flag for Review</button>
                </div>
            </div>
        </form>
        
        <!-- Box to display the OCR text -->
        <div class="info-box" style="margin-top: 20px;">
            <h3>Extracted OCR Text</h3>
            <div class="ocr-text"><pre>{{ current_page.ocr_text }}</pre></div>
        </div>
    </div>
</div>

<script>
    window.documentRotations = window.documentRotations || {};
    window.documentRotations[{{ current_page.id }}] = 0;

    function getIframeFor(docId){ return document.querySelector('.pdf-viewer iframe'); }
    function rotateDocument(docId, degrees){
        const iframe = getIframeFor(docId); if(!iframe) return;
        const next = ((window.documentRotations[docId]||0) + degrees + 360) % 360;
        window.documentRotations[docId] = next;
        if(window.RotationUtils){ window.RotationUtils.applyScaledRotation(iframe, next); }
        const btn = document.getElementById(`apply-rotation-${docId}`);
        if(btn){ btn.style.display = next===0?'none':'inline-block'; }
    }
    function resetRotation(docId){ window.documentRotations[docId]=0; const iframe=getIframeFor(docId); if(iframe&&window.RotationUtils) window.RotationUtils.reset(iframe); const btn=document.getElementById(`apply-rotation-${docId}`); if(btn) btn.style.display='none'; }
    function cycleFitModeFor(docId, btn){ const iframe=getIframeFor(docId); if(!iframe||!window.RotationUtils) return; const mode=window.RotationUtils.cycleFitMode(iframe); const angle=window.documentRotations[docId]||0; window.RotationUtils.applyScaledRotation(iframe, angle); btn.textContent=`üñºÔ∏è Fit: ${mode.charAt(0).toUpperCase()+mode.slice(1)}`; }
    function applyRotation(docId){ const rotation=window.documentRotations[docId]||0; if(rotation===0){ alert('No rotation to apply'); return; } const btn=document.getElementById(`apply-rotation-${docId}`); btn.disabled=true; btn.textContent='‚è≥ Applying...'; fetch(`/api/rotate_document/${docId}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({rotation})}).then(r=>r.json()).then(data=>{ if(!data.success) throw new Error(data.error||'Failed'); window.documentRotations[docId]=0; btn.style.display='none'; alert(`‚úÖ Applied ${rotation}¬∞ rotation - OCR updated`); }).catch(err=>{ console.error(err); alert('Failed to apply rotation: '+err.message); }).finally(()=>{ btn.disabled=false; btn.textContent='‚úÖ Apply Rotation'; }); }

    document.addEventListener('DOMContentLoaded', () => {
        // Logic to show/hide the "New Category Name" input field.
        const categorySelect = document.getElementById('category-select');
        const otherCategoryGroup = document.getElementById('other-category-group');
        if (categorySelect) {
            categorySelect.addEventListener('change', function() { 
                if (otherCategoryGroup) { 
                    otherCategoryGroup.style.display = (this.value === 'other_new') ? 'block' : 'none'; 
                }
            });
        }
    });
    document.addEventListener('DOMContentLoaded', ()=>{ const iframe=document.querySelector('.pdf-viewer iframe'); if(iframe && window.RotationUtils){ window.RotationUtils.applyScaledRotation(iframe, 0); } });
</script>
<script src="{{ url_for('static', filename='js/rotation_utils.js') }}"></script>
{% endblock %}
