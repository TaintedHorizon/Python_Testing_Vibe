{% extends 'base.html' %}

{% block title %}Verify Batch {{ batch_id }}{% endblock %}

{% block content %}
<style>
    /* Styles are consistent with other pages like revisit.html and review.html */
    .container { display: flex; gap: 20px; align-items: flex-start; }
    .image-pane { flex: 1; text-align: center; position: sticky; top: 20px; }
    .pdf-viewer {
        width: 100%;
        height: 80vh;
        border: 2px solid #007BFF;
        background-color: #f8f9fa;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border-radius: 8px;
        position: relative;
    }
    .pdf-placeholder {
        color: #6c757d;
        text-align: center;
        padding: 40px;
    }
    .info-pane { flex: 1; }
    .pagination { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .pagination a, .pagination span { padding: 10px 20px; text-decoration: none; border: 1px solid #ddd; background-color: #007BFF; color: white; border-radius: 5px; }
    .pagination span { background-color: #6c757d; }
    .info-box { background-color: white; border: 1px solid #ccc; padding: 20px; border-radius: 5px; }
    .ocr-text { max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-top: 10px; background-color: #f9f9f9; }
    .ocr-text pre { white-space: pre-wrap; word-wrap: break-word; }
    .form-group { margin-bottom: 15px; }
    .actions { display: flex; gap: 10px; margin-top: 20px; }
    .actions button { flex: 1; padding: 10px; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 1em; }
    .btn-approve { background-color: #28a745; }
    .btn-correct { background-color: #007BFF; }
    .btn-flag { background-color: #dc3545; }
    .rotate-buttons { margin-top: 10px; }
</style>

<h1>‚úÖ Verifying Batch #{{ batch_id }}</h1>
<p>This is the first step of the workflow. Review each page, check the AI's suggested category, and make corrections as needed.</p>

<!-- Pagination controls to move between pages in the batch -->
    <div class="pagination"{{ testid('verify-pagination') }}>
    {% if current_page_num > 1 %}
        <a href="{{ url_for('manipulation.verify_batch', batch_id=batch_id, page=current_page_num - 1) }}"{{ testid('verify-prev') }}>&laquo; Previous Page</a>
    {% else %}
        <!-- Disable the "Previous" button on the first page -->
        <span>&laquo; Previous Page</span>
    {% endif %}
    <strong>Page {{ current_page_num }} of {{ total_pages }}</strong>
    {% if current_page_num < total_pages %}
        <a href="{{ url_for('manipulation.verify_batch', batch_id=batch_id, page=current_page_num + 1) }}"{{ testid('verify-next') }}>Next Page &raquo;</a>
    {% else %}
        <!-- On the last page, the "Next" button is disabled, as submitting any action will move to the next step. -->
        <span>Next Page &raquo;</span>
    {% endif %}
</div>

<div class="container">
    <!-- Left Pane: Image and Rotation -->
    <div class="image-pane">
        <div class="pdf-viewer">
            {% if current_page.original_pdf_path %}
                <iframe src="{{ url_for('export.serve_original_pdf', filename=current_page.original_filename) }}" 
                    width="100%" height="100%" 
                    style="border: none;"{{ testid('verify-preview-frame') }}>
                    <div class="pdf-placeholder">
                        <h4>üìÑ {{ current_page.original_filename }}</h4>
                        <p>PDF viewer not supported.<br>
                        <a href="{{ url_for('export.serve_original_pdf', filename=current_page.original_filename) }}" target="_blank"{{ testid('verify-open-in-new') }}>Open in new tab</a></p>
                    </div>
                </iframe>
            {% else %}
                <div class="pdf-placeholder">
                    <h4>üìÑ {{ current_page.original_filename }}</h4>
                    <p>PDF file not available</p>
                </div>
            {% endif %}
        </div>
        <div class="rotate-buttons">
            <button type="button" onclick="rotateDocument({{ current_page.id }}, -90)"{{ testid('verify-rotate-left') }}>‚Ü∫ Rotate Left</button>
            <button type="button" onclick="rotateDocument({{ current_page.id }}, 90)"{{ testid('verify-rotate-right') }}>‚Üª Rotate Right</button>
            <button type="button" onclick="resetRotation({{ current_page.id }})"{{ testid('verify-rotate-reset') }}>üîÑ Reset</button>
            <button type="button" onclick="cycleFitModeFor({{ current_page.id }}, this)" title="Cycle fit mode (auto ‚Üí width ‚Üí height)"{{ testid('verify-fit-mode') }}>üñºÔ∏è Fit: Auto</button>
            <button type="button" id="apply-rotation-{{ current_page.id }}" onclick="applyRotation({{ current_page.id }})" style="display:none;background:#28a745;"{{ testid('verify-apply-rotation') }}>‚úÖ Apply Rotation</button>
        </div>
    </div>

    <!-- Right Pane: Information and Actions -->
    <div class="info-pane">
        <form id="correction-form" action="{{ url_for('manipulation.update_page') }}" method="post">
            <input type="hidden" id="action-input" name="action" value="save">
            <!-- Hidden fields to pass all necessary context to the server -->
            <input type="hidden" name="page_id" value="{{ current_page.id }}">
            <input type="hidden" name="batch_id" value="{{ batch_id }}">
            <input type="hidden" name="current_page_num" value="{{ current_page_num }}">
            <input type="hidden" name="total_pages" value="{{ total_pages }}">
            <input type="hidden" id="rotation-input" name="rotation" value="{{ current_page.rotation_angle or 0 }}">
            <input type="hidden" name="ai_suggestion" value="{{ current_page.ai_suggested_category }}">
            
            <div class="info-box">
                <div class="form-group">
                    <label for="category-select">Category</label>
                    <select id="category-select" name="category_dropdown">
                        <!-- The default option shows the AI's suggestion -->
                        <option value="" disabled selected>-- AI Suggestion: {{ current_page.ai_suggested_category }} --</option>
                        <!-- Populate the dropdown with all known categories -->
                        {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                        <!-- Option to create a new category -->
                        <option value="other_new">Other (Create New)...</option>
                    </select>
                </div>
                <!-- This input is hidden by default and appears if the user selects "Other" -->
                <div class="form-group" id="other-category-group" style="display:none;">
                    <label for="other-category-input">New Category Name</label>
                    <input type="text" id="other-category-input" name="other_category">
                </div>
                <!-- Action buttons that submit the form with different 'action' values -->
                <div class="actions">
                    <button type="submit" id="primary-action-btn" data-action="save" class="btn-approve"{{ testid('verify-approve') }}>‚úÖ Approve & Next</button>
                    <button type="submit" data-action="flag" class="btn-flag"{{ testid('verify-flag') }}>üö© Flag for Review</button>
                </div>
            </div>
        </form>
        
        <!-- Box to display the extracted OCR text -->
        <div class="info-box" style="margin-top: 20px;">
            <h3>üìÑ Extracted OCR Text</h3>
            <div class="ocr-text"><pre>{{ current_page.ocr_text }}</pre></div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Ensure the correct action is always sent
        const actionInput = document.getElementById('action-input');
        document.querySelectorAll('.actions button').forEach(btn => {
            btn.addEventListener('click', function() {
                if (actionInput) actionInput.value = this.getAttribute('data-action');
            });
        });

        // Show/hide the "New Category" input field based on dropdown selection.
        const categorySelect = document.getElementById('category-select');
        const otherCategoryGroup = document.getElementById('other-category-group');
        if (categorySelect) {
            categorySelect.addEventListener('change', function() { 
                if (otherCategoryGroup) { 
                    otherCategoryGroup.style.display = (this.value === 'other_new') ? 'block' : 'none'; 
                }
                updatePrimaryButtonLabel();
            });
        }
        const otherCategoryInput = document.getElementById('other-category-input');
        if (otherCategoryInput) {
            otherCategoryInput.addEventListener('input', updatePrimaryButtonLabel);
        }

        function normalize(str){return (str||'').trim().toLowerCase();}
        function updatePrimaryButtonLabel(){
            const aiSuggestion = normalize(document.querySelector('input[name="ai_suggestion"]').value);
            let chosen = '';
            if (categorySelect){
                if (categorySelect.value === 'other_new') {
                    chosen = normalize(otherCategoryInput ? otherCategoryInput.value : '');
                } else if (categorySelect.value) {
                    chosen = normalize(categorySelect.value);
                } else {
                    chosen = aiSuggestion; // no change
                }
            }
            const primaryBtn = document.getElementById('primary-action-btn');
            if (!primaryBtn) return;
            const isCorrection = chosen && chosen !== aiSuggestion;
            primaryBtn.textContent = isCorrection ? 'Correct & Next' : 'Approve & Next';
            primaryBtn.classList.toggle('btn-correct', isCorrection);
            primaryBtn.classList.toggle('btn-approve', !isCorrection);
        }
        updatePrimaryButtonLabel();
    });

    window.documentRotations = window.documentRotations || {};
    window.documentRotations[{{ current_page.id }}] = 0;

    function getIframeFor(docId){
        return document.querySelector('.pdf-viewer iframe');
    }

    function rotateDocument(docId, degrees){
        const iframe = getIframeFor(docId);
        if(!iframe){ return; }
        const current = window.documentRotations[docId] || 0;
        const next = (current + degrees + 360) % 360;
        window.documentRotations[docId] = next;
        if(window.RotationUtils){ window.RotationUtils.applyScaledRotation(iframe, next); }
        const applyBtn = document.getElementById(`apply-rotation-${docId}`);
        applyBtn.style.display = next === 0 ? 'none' : 'inline-block';
    }

    function resetRotation(docId){
        window.documentRotations[docId] = 0;
        const iframe = getIframeFor(docId);
        if(iframe && window.RotationUtils){ window.RotationUtils.reset(iframe); }
        const applyBtn = document.getElementById(`apply-rotation-${docId}`);
        if(applyBtn){ applyBtn.style.display = 'none'; }
    }

    function cycleFitModeFor(docId, btn){
        const iframe = getIframeFor(docId);
        if(!iframe || !window.RotationUtils) return;
        const mode = window.RotationUtils.cycleFitMode(iframe);
        const angle = window.documentRotations[docId] || 0;
        window.RotationUtils.applyScaledRotation(iframe, angle);
        btn.textContent = `üñºÔ∏è Fit: ${mode.charAt(0).toUpperCase()+mode.slice(1)}`;
    }

    function applyRotation(docId){
        const rotation = window.documentRotations[docId] || 0;
        if(rotation === 0){ alert('No rotation to apply'); return; }
        const btn = document.getElementById(`apply-rotation-${docId}`);
        btn.disabled = true; btn.textContent = '‚è≥ Applying...';
        fetch(`/api/rotate_document/${docId}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rotation }) })
          .then(r=>r.json())
          .then(data=>{ if(!data.success) throw new Error(data.error||'Failed'); window.documentRotations[docId]=0; btn.style.display='none'; alert(`‚úÖ Applied ${rotation}¬∞ rotation - OCR updated`); })
          .catch(err=>{ console.error(err); alert('Failed to apply rotation: '+err.message); })
          .finally(()=>{ btn.disabled=false; btn.textContent='‚úÖ Apply Rotation'; });
    }
</script>
<script src="{{ url_for('static', filename='js/rotation_utils.js') }}"></script>
<script>
  // Initialize badge / base rotation once utilities loaded
  document.addEventListener('DOMContentLoaded', ()=>{
     const iframe = document.querySelector('.pdf-viewer iframe');
     if(iframe && window.RotationUtils){ window.RotationUtils.applyScaledRotation(iframe, 0); }
  });
</script>
{% endblock %}
