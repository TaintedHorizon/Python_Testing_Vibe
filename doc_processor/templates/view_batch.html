{% extends 'base.html' %}

{% block title %}Viewing Batch {{ batch_id }}{% endblock %}

{% block content %}
<style>
    /* Styles are largely copied from revisit.html for a consistent look and feel */
    .container { display: flex; gap: 20px; align-items: flex-start; }
    .image-pane { flex: 1; text-align: center; position: sticky; top: 20px; }
    .image-wrapper { width: 100%; height: 80vh; border: 1px solid #ccc; background-color: #f0f0f0; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .image-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.2s; }
    .info-pane { flex: 1; }
    .pagination { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .pagination a, .pagination span { padding: 10px 20px; text-decoration: none; border: 1px solid #ddd; background-color: #007BFF; color: white; border-radius: 5px; }
    .pagination span { background-color: #6c757d; }
    .info-box { background-color: white; border: 1px solid #ccc; padding: 20px; border-radius: 5px; }
    .ocr-text { max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-top: 10px; background-color: #f9f9f9; }
    .ocr-text pre { white-space: pre-wrap; word-wrap: break-word; }
    .rotate-buttons { margin-top: 10px; }
</style>

<h1>Viewing Completed Batch #{{ batch_id }} <span style="font-size: 0.6em; color: #666;">(Status: {{ batch.status }})</span></h1>
<p>This is a read-only view of the pages in this completed batch. If changes are needed, you must use the "Reset Batch" button on the Mission Control page.</p>

<div class="pagination">
    {% if current_page_num > 1 %}
        <a href="{{ url_for('view_batch_page', batch_id=batch_id, page=current_page_num - 1) }}">&laquo; Previous Page</a>
    {% else %}
        <span>&laquo; Previous Page</span>
    {% endif %}
    <strong>Page {{ current_page_num }} of {{ total_pages }}</strong>
    {% if current_page_num < total_pages %}
        <a href="{{ url_for('view_batch_page', batch_id=batch_id, page=current_page_num + 1) }}">Next Page &raquo;</a>
    {% else %}
        <a href="{{ url_for('mission_control_page') }}" style="background-color: #17a2b8;">Finish Viewing</a>
    {% endif %}
</div>

<div class="container">
    <div class="image-pane">
        <div class="image-wrapper">
            <img id="pageImage" src="{{ url_for('serve_processed_file', filepath=current_page.relative_image_path) }}" alt="Scanned page">
        </div>
        <input type="hidden" id="rotation-input" value="{{ current_page.rotation_angle or 0 }}">
        <div class="rotate-buttons">
            <button onclick="rotateImage(-90)">Rotate Left ↺</button>
            <button onclick="rotateImage(90)">Rotate Right ↻</button>
        </div>
    </div>

    <div class="info-pane">
        <div class="info-box">
            <p><strong>Source File:</strong><br>{{ current_page.source_filename }}, Page {{ current_page.page_number }}</p>
            <hr>
            <p><strong>AI Suggested Category:</strong><br>{{ current_page.ai_suggested_category or 'N/A' }}</p>
            <hr>
            <p><strong>Final Verified Category:</strong><br>{{ current_page.human_verified_category or 'N/A' }}</p>
        </div>
        
        <div class="info-box" style="margin-top: 20px;">
            <h3>Extracted OCR Text</h3>
            <div class="ocr-text"><pre>{{ current_page.ocr_text }}</pre></div>
        </div>
    </div>
</div>

<script>
    let currentRotation = 0;
    const rotationInput = document.getElementById('rotation-input');
    const pageImage = document.getElementById('pageImage');
    
    // Function to handle client-side image rotation for viewing.
    function rotateImage(degrees) {
        currentRotation = (currentRotation + 360 + degrees) % 360;
        if (pageImage) pageImage.style.transform = `rotate(${currentRotation}deg)`;
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Set the initial rotation of the image based on the value from the database.
        if (rotationInput) { currentRotation = parseInt(rotationInput.value) || 0; }
        if (pageImage) { pageImage.style.transform = `rotate(${currentRotation}deg)`; }
    });
</script>
{% endblock %}